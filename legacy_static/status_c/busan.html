<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰íƒ ì„¸íƒì†Œ ì‹œì„¤ ì‹ ì¶• ê³µì‚¬ ì•ˆì „ë³´ê±´ í†µí•© ë¡œë“œë§µ</title>
    <style>
        /* [ê³µí†µ] í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        :root {
            --primary: #4a90e2;
            /* íŒŒë‘ */
            --danger: #d9534f;
            /* ë¹¨ê°• */
            --warning: #f0ad4e;
            /* ë…¸ë‘ */
            --orange: #e67e22;
            /* ì£¼í™© */
            --success: #5cb85c;
            /* ì´ˆë¡ */
            --navy: #2c3e50;
            /* ë‚¨ìƒ‰ (í—¤ë”) */
            --dark: #343a40;
            /* ë‹¤í¬ (ì¤€ê³µ) */
            --purple: #9b59b6;
            /* ë³´ë¼ */
            --border: #e0e0e0;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            margin: 0;
            background: #f4f6f9;
            color: #333;
            padding-bottom: 50px;
        }

        /* [ë©”ì¸] ìƒë‹¨ í”„ë¡œì íŠ¸ ì •ë³´ */
        .header-panel {
            background: #fff;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .info-container {
            display: flex;
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .info-box {
            flex: 1;
            background: #f0f4ff;
            border: 1px solid #d0dbf5;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-box.pink {
            background: #fff0f0;
            border-color: #ffd0d0;
        }

        .info-title {
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }

        .info-content {
            outline: none;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .info-content:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .info-content:focus {
            background: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 3px rgba(74, 144, 226, 0.3);
        }

        /* [ë©”ì¸] ì°¨íŠ¸ ê·¸ë¦¬ë“œ (16ê°œì›” ëŒ€ì‘) */
        .chart-wrapper {
            max-width: 1600px;
            margin: 0 auto 30px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 180px 80px repeat(16, 1fr);
            min-width: 1600px;
        }

        .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 8px;
            font-size: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cell-header {
            background: #f5f5f5;
            text-align: center;
            font-weight: bold;
            padding: 10px;
            white-space: nowrap;
            /* [Modified] Text wrap prevention */
        }

        .cell-sidebar {
            background: #fff;
            font-weight: bold;
            color: #0056b3;
            justify-content: flex-start;
            padding-left: 15px;
        }

        .cell-sidebar.safety-row {
            background: #fffdf0;
            color: #333;
        }

        .clickable-cell {
            cursor: pointer;
            transition: background 0.2s;
        }

        .clickable-cell:hover {
            background-color: #f0f8ff;
        }

        .prep-header {
            background: #e3f2fd;
            color: #1976d2;
        }

        .prep-cell {
            color: #555;
            background: #fafafa;
            outline: none;
            transition: 0.2s;
        }

        .prep-cell:focus {
            background: white;
            border: 2px solid var(--primary);
        }

        .prep-cell:hover {
            background: #eee;
            cursor: text;
        }

        /* [ë©”ì¸] ê³µì • ë§‰ëŒ€ */
        .task-bar {
            width: 100%;
            height: 24px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            white-space: nowrap;
            overflow: hidden;
        }

        .task-bar:hover {
            transform: scale(1.02);
            z-index: 10;
        }

        .bg-blue {
            background: var(--primary);
        }

        .bg-red {
            background: var(--danger);
        }

        .bg-yellow {
            background: var(--warning);
            color: #fff;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        .bg-green {
            background: var(--success);
        }

        .bg-grey {
            background: #6c757d;
        }

        .bg-warning {
            background: var(--orange);
            color: white;
        }

        .bg-dark {
            background: var(--dark);
            color: white;
        }

        .divider-row {
            grid-column: 1 / -1;
            background: #eef2f5;
            text-align: center;
            font-weight: bold;
            padding: 8px;
            font-size: 13px;
            color: #555;
            border-bottom: 1px solid var(--border);
        }

        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .tag-container {
            flex-direction: column;
            gap: 2px;
            min-height: 40px;
        }

        .tag {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            text-align: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
        }

        .tag.pink {
            background: #ffeef0;
            color: #d63384;
            border-color: #f8d7da;
        }

        .tag.green {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
        }

        .tag.orange {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffe0b2;
        }

        .tag.blue {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        .tag.red {
            background: #fff5f5;
            color: #dc3545;
            border-color: #ffc9c9;
        }

        .tag.purple {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        /* KPI í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .kpi-section {
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .kpi-header-title {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kpi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .kpi-th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .kpi-td {
            border: 1px solid #ddd;
            padding: 12px;
            vertical-align: middle;
            line-height: 1.6;
        }

        .kpi-td.center {
            text-align: center;
        }

        .text-red {
            color: #d9534f;
            font-weight: bold;
        }

        .text-blue {
            color: #4a90e2;
            font-weight: bold;
        }

        .editable {
            outline: none;
            transition: background 0.2s;
            border-radius: 4px;
            padding: 5px;
        }

        .editable:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .editable:focus {
            background: #fff;
            border: 1px solid var(--primary);
            cursor: text;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
        }

        /* í•˜ë‹¨ í™œë™ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .log-section {
            max-width: 1600px;
            margin: 30px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            padding: 20px;
            box-sizing: border-box;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .log-search {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
            font-size: 13px;
        }

        .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            cursor: pointer;
        }

        .log-item:hover {
            background: #f9f9f9;
        }

        .log-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .log-task {
            font-weight: bold;
            color: var(--navy);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .log-content {
            font-size: 13px;
            color: #555;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .log-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            color: white;
        }

        .badge-risk {
            background: var(--danger);
        }

        .badge-kpi {
            background: var(--primary);
        }

        .btn-log-delete {
            background: white;
            border: 1px solid #ccc;
            color: #888;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-log-delete:hover {
            border-color: #d9534f;
            color: #d9534f;
            background: #fff5f5;
        }

        /* [NEW] ë°˜ì… ì ê²€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .inspection-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .inspection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .inspection-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-inspect {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-inspect.blue {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        .btn-inspect.orange {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffe0b2;
        }

        .btn-inspect.purple {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        .btn-inspect:hover {
            filter: brightness(0.95);
        }

        .inspection-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .inspection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .inspect-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pass {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-fail {
            background: #ffebee;
            color: #c62828;
        }

        /* íŒì—… UI */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 650px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .btn-close {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 8px;
            color: #555;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-label {
            font-size: 13px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .row-2-col {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
        }

        .risk-text {
            color: var(--danger);
            font-weight: bold;
        }

        .comment-section {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
        }

        .comment-list {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .comment-item {
            font-size: 13px;
            color: #333;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-item strong {
            color: var(--navy);
        }

        .comment-date {
            color: #888;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-del-comment {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .btn-del-comment:hover {
            color: #d9534f;
            font-weight: bold;
        }

        .comment-input-group {
            display: flex;
            gap: 8px;
        }

        .input-name {
            width: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .input-content {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background: #fff;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn-gray {
            background: #e0e0e0;
            color: #333;
        }

        .btn-navy {
            background: var(--navy);
            color: white;
        }

        .preview-box {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            background: #fafafa;
            display: none;
            position: relative;
        }

        /* [ìˆ˜ì •ë¨] ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€/PDF ìŠ¤íƒ€ì¼ */
        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            display: none;
            margin: 0 auto;
        }

        .preview-pdf {
            width: 100%;
            height: 350px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }

        .btn-delete-img {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            z-index: 10;
        }

        .tag-editor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            min-height: 50px;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-weight: bold;
        }

        .tag-item .del-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #888;
            font-weight: bold;
        }

        .tag-input-group {
            display: flex;
            gap: 5px;
        }

        .color-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--navy);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="loading">
        <div class="spinner"></div>
        <div>ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="header-panel">
        <h2 style="text-align:center; margin-bottom: 20px;">í‰íƒ ì„¸íƒì†Œ ì‹œì„¤ ì‹ ì¶• ê³µì‚¬ <span
                style="font-size:12px; color:#ccc; font-weight:normal;">(v2026.03.01)</span></h2>
        <div class="info-container">
            <div class="info-box">
                <div class="info-title">ğŸ“… ê³µì‚¬ ê¸°ê°„</div>
                <!-- [Modified] Removed contenteditable to prevent user editing, as it is now hardcoded -->
                <div id="infoPeriod" class="info-content">
                    2026.03.01 ~ 2028.02.28<br><span style="font-size:11px; color:#888;">(ì°©ê³µì¼ë¡œë¶€í„° 24ê°œì›”)</span>
                </div>
            </div>
            <div class="info-box">
                <div class="info-title">ğŸ¢ ê³µì‚¬ ê·œëª¨</div>
                <div id="infoScale" class="info-content" contenteditable="true" onblur="updateDB()">
                    ì§€í•˜2ì¸µ ~ ì§€ìƒ10ì¸µ (ì—…ë¬´ì‹œì„¤)
                </div>
            </div>
            <div class="info-box pink">
                <div class="info-title">ğŸ† ì•ˆì „ ëª©í‘œ</div>
                <div id="infoGoal" class="info-content" contenteditable="true" onblur="updateDB()"
                    style="color:#d9534f; font-weight:bold;">
                    ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 1000ì¼ ë‹¬ì„±
                </div>
            </div>
        </div>
    </div>

    <div class="chart-wrapper">
        <div class="grid-container" id="mainGrid"></div>
    </div>

    <div class="kpi-section">
        <div class="kpi-header-title">
            <span>ğŸ“‹ ì›”ë³„ ì•ˆì „ë³´ê±´ ì¤‘ì  í™œë™ ë° ì„±ê³¼ ëª©í‘œ (KPI)</span>
            <span style="font-size:12px; font-weight:normal; opacity:0.8;">â€» ëª¨ë“  ë‚´ìš©ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
        <table class="kpi-table">
            <colgroup>
                <col style="width: 50px;">
                <col style="width: 150px;">
                <col style="width: 150px;">
                <col style="width: auto;">
                <col style="width: 120px;">
                <col style="width: 120px;">
            </colgroup>
            <thead>
                <tr>
                    <th class="kpi-th">ì›”</th>
                    <th class="kpi-th">ì£¼ìš” ê³µì •</th>
                    <th class="kpi-th">í•µì‹¬ ìœ„í—˜</th>
                    <th class="kpi-th">ì•ˆì „ë³´ê±´ í™œë™</th>
                    <th class="kpi-th">ì„±ê³¼ ì§€í‘œ</th>
                    <th class="kpi-th">ë²•ì  ì„œë¥˜</th>
                </tr>
            </thead>
            <tbody id="kpiTableBody"></tbody>
        </table>
    </div>

    <!-- [NEW] ë°˜ì… ì ê²€ ë° ì•Œë¦¼ ì„¹ì…˜ (ìˆ¨ê¹€ ì²˜ë¦¬: ê³µì •í‘œ í˜ì´ì§€ì—ì„œëŠ” ë³´ì´ì§€ ì•Šë„ë¡ í•¨) -->
    <div class="inspection-section" style="display: none;">
        <div class="inspection-header">
            <h3 style="margin:0;">ğŸ—ï¸ ë°˜ì… ì¥ë¹„/ìì¬ ì ê²€ ë° ì•Œë¦¼</h3>
        </div>
        <div class="inspection-buttons">
            <button class="btn-inspect blue" onclick="openInspectionModal('ê±´ì„¤ì¥ë¹„')">ğŸšœ ê±´ì„¤ì¥ë¹„ ì ê²€</button>
            <button class="btn-inspect orange" onclick="openInspectionModal('ê¸°ê³„ê¸°êµ¬')">ğŸ› ï¸ ê¸°ê³„ê¸°êµ¬ ì ê²€</button>
            <button class="btn-inspect purple" onclick="openInspectionModal('ìœ í•´í™”í•™ë¬¼ì§ˆ')">ğŸ§ª ìœ í•´í™”í•™ë¬¼ì§ˆ ì ê²€</button>
        </div>
        <ul id="inspectionList" class="inspection-list">
            <li style="text-align:center; color:#999; padding:10px;">ë“±ë¡ëœ ì ê²€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>
        </ul>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3 style="margin:0;">ğŸ“Š ì‹¤ì‹œê°„ ì•ˆì „í™œë™ ë“±ë¡ í˜„í™© (ìµœì‹ ìˆœ)</h3>
            <input type="text" id="logSearchInput" class="log-search" placeholder="ê³µì¢…ëª…, ë‚´ìš© ê²€ìƒ‰..."
                onkeyup="renderActivityLog()">
        </div>
        <ul id="activityLogList" class="log-list">
            <li style="text-align:center; padding:20px; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>
        </ul>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ê³µì • ìƒì„¸ í™œë™</h3><button class="btn-close"
                    onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- [Added] Date Input Field -->
                <div><label class="form-label">ğŸ“… ì‘ì—… ì¼ì (ìë™ ì…ë ¥)</label><input type="date" id="modalDate"
                        class="form-input" style="font-weight:bold; font-size:16px; color:#333; background:#f9f9f9;">
                </div>

                <div class="row-2-col">
                    <div class="col"><label class="form-label">âš ï¸ í•µì‹¬ ìœ„í—˜</label><input type="text" id="modalRisk"
                            class="form-input risk-text"></div>
                    <div class="col"><label class="form-label">ğŸ“ˆ ì„±ê³¼ ì§€í‘œ</label><input type="text" id="modalKPI"
                            class="form-input"></div>
                </div>
                <div><label class="form-label">ğŸ“ ì•ˆì „ë³´ê±´ í™œë™ ì¼ì§€</label><textarea id="modalActivity" class="form-input"
                        rows="4"></textarea></div>
                <div>
                    <label class="form-label">ğŸ“¸ ì‚¬ì§„/ë¬¸ì„œ ì²¨ë¶€ (ì´ë¯¸ì§€ or PDF)</label>
                    <input type="file" id="fileInput" class="form-input" style="padding: 6px;" accept="image/*, .pdf"
                        onchange="handleFileSelect(this)">
                    <div id="previewBox" class="preview-box">
                        <button class="btn-delete-img" onclick="deleteFile()">Ã—</button>
                        <img id="previewImg" class="preview-img" src="">
                        <iframe id="previewPdf" class="preview-pdf" src=""></iframe>
                    </div>
                </div>
                <div class="comment-section">
                    <label class="form-label">ğŸ’¬ í˜„ì¥ ì†Œí†µ (ëŒ“ê¸€)</label>
                    <ul class="comment-list" id="commentList"></ul>
                    <div class="comment-input-group">
                        <input type="text" id="writerName" class="input-name" placeholder="ì´ë¦„">
                        <input type="text" id="commentContent" class="input-content" placeholder="ë‚´ìš©...">
                        <button class="btn btn-navy" onclick="addComment()">ë“± ë¡</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeModal()">ë‹«ê¸°</button>
                <button class="btn btn-navy" onclick="saveTaskDetails()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="safetyModal" class="modal-overlay">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="safetyModalTitle">ì¼ì • íƒœê·¸ ìˆ˜ì •</h3><button class="btn-close"
                    onclick="closeSafetyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <label class="form-label">í˜„ì¬ ë“±ë¡ëœ íƒœê·¸</label>
                <div id="currentTagList" class="tag-editor-list"></div>
                <label class="form-label">ìƒˆ íƒœê·¸ ì¶”ê°€</label>
                <div class="tag-input-group">
                    <select id="newTagColor" class="color-select">
                        <option value="blue">í‰ê°€(íŒŒë‘)</option>
                        <option value="green">êµìœ¡(ì´ˆë¡)</option>
                        <option value="red">íŠ¹ë³„(ë¹¨ê°•)</option>
                        <option value="orange">ì ê²€(ì£¼í™©)</option>
                        <option value="pink">ì¸¡ì •(ë¶„í™)</option>
                        <option value="purple">íšŒì˜(ë³´ë¼)</option>
                    </select>
                    <input type="text" id="newTagText" class="form-input" placeholder="ë‚´ìš©">
                    <button class="btn btn-navy" style="padding: 0 15px;" onclick="addSafetyTag()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-gray" onclick="closeSafetyModal()">ì·¨ì†Œ</button><button
                    class="btn btn-navy" onclick="saveSafetyChanges()">ì ìš©í•˜ê¸°</button></div>
        </div>
    </div>

    <!-- [NEW] ë°˜ì… ì ê²€ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="inspectionModal" class="modal-overlay">
        <div class="modal-box" style="width: 500px;">
            <div class="modal-header" style="background:var(--primary); color:white;">
                <h3 class="modal-title" id="inspectionModalTitle" style="color:white;">ì ê²€ ë“±ë¡</h3>
                <button class="btn-close" style="color:white; border-color:white;"
                    onclick="closeInspectionModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inspectType">
                <div>
                    <label class="form-label">ğŸ“¦ í’ˆëª©ëª… / ì¥ë¹„ëª…</label>
                    <input type="text" id="inspectItem" class="form-input" placeholder="ì˜ˆ: êµ´ì‚­ê¸°, ì‚¬ë‹¤ë¦¬, ì—í­ì‹œ ë“±">
                </div>
                <div>
                    <label class="form-label">âœ… ì ê²€ ê²°ê³¼</label>
                    <div style="display:flex; gap:20px; padding:10px 0;">
                        <label style="cursor:pointer;"><input type="radio" name="inspectResult" value="í•©ê²©" checked>
                            <span style="color:var(--success); font-weight:bold;">í•©ê²©</span></label>
                        <label style="cursor:pointer;"><input type="radio" name="inspectResult" value="ë¶ˆí•©ê²©"> <span
                                style="color:var(--danger); font-weight:bold;">ë¶ˆí•©ê²©</span></label>
                    </div>
                </div>
                <div>
                    <label class="form-label">ğŸ“ ì„¸ë¶€ ì ê²€ ë‚´ìš©</label>
                    <textarea id="inspectDesc" class="form-input" rows="3" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥"></textarea>
                </div>
                <div>
                    <label class="form-label">ğŸ“¸ ì‚¬ì§„ ì²¨ë¶€</label>
                    <input type="file" id="inspectFile" class="form-input" accept="image/*" multiple>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeInspectionModal()">ì·¨ì†Œ</button>
                <button class="btn btn-navy" onclick="saveInspection()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, storage } from "../firebase.js";
        import { doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ============================================
        // [íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •]
        // firebase.jsì—ì„œ ì„¤ì •ëœ db, storage ê°ì²´ë¥¼ ê°€ì ¸ì™€ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // ============================================

        // â˜… [ìˆ˜ì •ë¨ 2026-02-16] ë¶€ì‚° í˜„ì¥ DB ê²½ë¡œ ì„¤ì • (sites/siteC)
        const SITE_ID = "siteC";
        const docRef = doc(db, "sites", SITE_ID);

        // ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°
        let globalData = {
            headerInfo: {
                period: "2026.03.01 ~ 2028.02.28<br><span style='font-size:11px; color:#888;'>(ì°©ê³µì¼ë¡œë¶€í„° 24ê°œì›”)</span>",
                scale: "ì§€í•˜2ì¸µ ~ ì§€ìƒ10ì¸µ (ì—…ë¬´ì‹œì„¤)",
                goal: "ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 1000ì¼ ë‹¬ì„±"
            },
            prepConst: {},
            prepSafety: {},
            comments: {},
            taskDetails: {},
            kpiData: [],
            safetyData: [
                { title: "ìœ„í—˜ì„±í‰ê°€", monthlyTags: { 1: ["ìµœì´ˆí‰ê°€|blue"] } },
                { title: "ì•ˆì „êµìœ¡", monthlyTags: { 1: ["ì±„ìš©ì‹œ|green"] } },
                { title: "í˜‘ì˜ì²´/íšŒì˜", monthlyTags: { 1: ["í˜‘ì˜ì²´|purple"] } },
                { title: "ë²•ì ì ê²€", monthlyTags: { 1: ["í•©ë™|orange"] } },
                { title: "ì„±ê³¼ì¸¡ì •", monthlyTags: { 1: ["ì´í–‰ì ê²€|pink"] } }
            ]
        };

        // KPI ê¸°ë³¸ ë°ì´í„° ìƒì„± (16ê°œì›”)
        for (let i = 1; i <= 16; i++) {
            globalData.kpiData.push({ month: i, process: "", risk: "", activity: "", kpi: "", docs: "" });
        }

        // ê³µì • ë°ì´í„°
        const constructionData = [
            { name: "ê³µí†µê°€ì„¤ê³µì‚¬", start: 1, duration: 16, color: "bg-grey", label: "ê³µí†µê°€ì„¤" },
            { name: "ê°€ì„¤ê³µì‚¬", start: 3, duration: 5, color: "bg-blue", label: "ê°€ì„¤ê³µì‚¬" },
            { name: "ì² ê·¼ì½˜í¬ë¦¬íŠ¸", start: 5, duration: 11, color: "bg-red", label: "ê³¨ì¡°ê³µì‚¬" },
            { name: "ì¡°ì ê³µì‚¬", start: 8, duration: 6, color: "bg-blue", label: "ì¡°ì ê³µì‚¬" },
            { name: "ë¯¸ì¥ê³µì‚¬", start: 8, duration: 8, color: "bg-blue", label: "ë¯¸ì¥ê³µì‚¬" },
            { name: "ë°©ìˆ˜ê³µì‚¬", start: 8, duration: 8, color: "bg-blue", label: "ë°©ìˆ˜ê³µì‚¬" },
            { name: "íƒ€ì¼ê³µì‚¬", start: 12, duration: 3, color: "bg-yellow", label: "íƒ€ì¼ê³µì‚¬" },
            { name: "ì„ê³µì‚¬", start: 11, duration: 5, color: "bg-yellow", label: "ì„ê³µì‚¬" },
            { name: "ê¸ˆì†ê³µì‚¬", start: 11, duration: 5, color: "bg-yellow", label: "ê¸ˆì†ê³µì‚¬" },
            { name: "ì°½í˜¸ê³µì‚¬", start: 8, duration: 8, color: "bg-yellow", label: "ì°½í˜¸ê³µì‚¬" },
            { name: "ìœ ë¦¬ê³µì‚¬", start: 12, duration: 4, color: "bg-yellow", label: "ìœ ë¦¬ê³µì‚¬" },
            { name: "ë„ì¥ê³µì‚¬", start: 11, duration: 5, color: "bg-yellow", label: "ë„ì¥ê³µì‚¬" },
            { name: "ìˆ˜ì¥ê³µì‚¬", start: 10, duration: 5, color: "bg-yellow", label: "ìˆ˜ì¥ê³µì‚¬" },
            { name: "ì¥ì• ì¸í¸ì˜", start: 14, duration: 2, color: "bg-yellow", label: "ì¥ì• ì¸ì‹œì„¤" },
            { name: "E/Vê³µì‚¬", start: 12, duration: 4, color: "bg-yellow", label: "ìŠ¹ê°•ê¸°" },
            { name: "ì¡°ê²½ê³µì‚¬", start: 14, duration: 2, color: "bg-green", label: "ì¡°ê²½ê³µì‚¬" },
            { name: "í† ëª©ê³µì‚¬", start: 1, duration: 5, color: "bg-blue", label: "í† ëª©ê³µì‚¬" },
            { name: "ë¶€ëŒ€í† ëª©ê³µì‚¬", start: 13, duration: 3, color: "bg-green", label: "ë¶€ëŒ€í† ëª©" },
            { name: "ê¸°ê³„ì„¤ë¹„ê³µì‚¬", start: 5, duration: 11, color: "bg-grey", label: "ê¸°ê³„ì„¤ë¹„" },
            { name: "ì „ê¸°í†µì‹ ê³µì‚¬", start: 5, duration: 11, color: "bg-grey", label: "ì „ê¸°í†µì‹ " },
            { name: "ì†Œë°©ê³µì‚¬", start: 6, duration: 10, color: "bg-grey", label: "ì†Œë°©ê³µì‚¬" },
            { name: "ì¤€ê³µ/ì¸ê³„", start: 16, duration: 1, color: "bg-dark", label: "ì¤€ê³µ" }
        ];

        // [ìˆ˜ì •ë¨ 2026-02-14] ë¬´í•œ ë¡œë”© ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ì•„ì›ƒ ì¶”ê°€
        setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                console.warn('âš ï¸ Firebase ë¡œë”© íƒ€ì„ì•„ì›ƒ: 10ì´ˆ ê²½ê³¼');
                loadingEl.style.display = 'none';
                // ê¸°ë³¸ ë°ì´í„°ë¡œ ë Œë”ë§ ì‹œë„
                renderAll();
            }
        }, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ


        // [ë¬´í•œ ë£¨í”„ ë°©ì§€] ì´ˆê¸°í™” í”Œë˜ê·¸
        let isInitializing = false;

        // (1) ë©”ì¸ ë¬¸ì„œ ì½ê¸°
        onSnapshot(docRef, (docSnap) => {
            try {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    globalData = { ...globalData, ...data };
                    if (!globalData.prepConst) globalData.prepConst = {};
                    if (!globalData.prepSafety) globalData.prepSafety = {};
                    if (globalData.kpiData) {
                        for (let i = 0; i < 16; i++) {
                            if (!globalData.kpiData[i]) globalData.kpiData[i] = { month: i + 1, process: "", risk: "", activity: "", kpi: "", docs: "" };
                        }
                    }
                } else {
                    // [ìˆ˜ì •ë¨] ë¬´í•œ ë£¨í”„ ë°©ì§€: ì´ˆê¸°í™” ì¤‘ì´ ì•„ë‹ ë•Œë§Œ setDoc ì‹¤í–‰
                    if (!isInitializing) {
                        isInitializing = true;
                        console.warn('âš ï¸ Firestore ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ, ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”');
                        setDoc(docRef, globalData).catch(err => console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', err));
                    }
                }
                renderAll();
                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                console.error('ë Œë”ë§ ì˜¤ë¥˜:', err);
                // ... error handling ...
            }
        }, (error) => {
            console.error("âŒ Firestore Error:", error);
        });

        // ==========================================
        // [ë³µêµ¬ë¨] í•˜ìœ„ ì»¬ë ‰ì…˜(Subcollection) ë¦¬ìŠ¤ë„ˆ
        // ==========================================

        // (2) ê³µì •ë³„ ìƒì„¸ í™œë™ (taskDetails)
        const detailsRef = collection(db, "sites", SITE_ID, "taskDetails");
        onSnapshot(detailsRef, (snapshot) => {
            globalData.taskDetails = {};
            snapshot.forEach((doc) => {
                globalData.taskDetails[doc.id] = doc.data();
            });
            renderActivityLog(); // ë¡œê·¸ UI ê°±ì‹ 
        });

        // (3) ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸ (activityLogs)
        const logsRef = collection(db, "sites", SITE_ID, "activityLogs");
        const logsQuery = query(logsRef, orderBy("lastUpdated", "desc"), limit(50));

        onSnapshot(logsQuery, (snapshot) => {
            globalData.activityLog = [];
            snapshot.forEach((doc) => {
                globalData.activityLog.push({ id: doc.id, ...doc.data() });
            });
            renderActivityLog();
        });

        // (4) ë°˜ì… ì ê²€ ë¡œê·¸ (inspectionLogs)
        const inspectRef = collection(db, "sites", SITE_ID, "inspectionLogs");
        const inspectQuery = query(inspectRef, orderBy("date", "desc"), limit(20));

        onSnapshot(inspectQuery, (snapshot) => {
            globalData.inspectionLogs = [];
            snapshot.forEach((doc) => {
                globalData.inspectionLogs.push({ id: doc.id, ...doc.data() });
            });
            renderInspectionLog();
        });

        // 2. ë Œë”ë§
        function renderAll() {
            renderHeader();
            renderGrid();
            renderKpiTable();
            renderActivityLog();
        }

        function renderHeader() {
            // [ìˆ˜ì •ë¨] ê³µì‚¬ê¸°ê°„ í…ìŠ¤íŠ¸ ê°•ì œ ê³ ì • (DBê°’ ë¬´ì‹œ) - ê¸°ì¡´: globalData.headerInfo.period ì‚¬ìš©
            document.getElementById('infoPeriod').innerHTML = "2026.03.01 ~ 2028.02.28<br><span style='font-size:11px; color:#888;'>(ì°©ê³µì¼ë¡œë¶€í„° 24ê°œì›”)</span>";
            document.getElementById('infoScale').innerText = globalData.headerInfo.scale;
            document.getElementById('infoGoal').innerText = globalData.headerInfo.goal;
        }

        function renderGrid() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = `<div class="cell-header">êµ¬ë¶„</div><div class="cell-header prep-header">ì°©ê³µì¤€ë¹„</div>`;
            for (let i = 1; i <= 16; i++) grid.innerHTML += `<div class="cell-header">${i}ì›”</div>`;

            // ê³µì •
            constructionData.forEach((task, index) => {
                let rowHTML = `<div class="cell cell-sidebar" title="${task.name}">${task.name}</div>`;
                let prepVal = globalData.prepConst[index] || "";
                rowHTML += `<div class="cell prep-cell" contenteditable="true" onblur="updatePrep('const', ${index}, this.innerText)">${prepVal}</div>`;
                for (let i = 1; i <= 16; i++) {
                    if (i === task.start) {
                        rowHTML += `<div class="cell" style="grid-column: span ${task.duration}; background:#fff; padding:5px;"><div class="task-bar ${task.color}" onclick="openModal(${index})">${task.label}</div></div>`;
                        i += (task.duration - 1);
                    } else { rowHTML += `<div class="cell"></div>`; }
                }
                grid.innerHTML += rowHTML;
            });

            grid.innerHTML += `<div class="divider-row">â–¼ ë²•ì  ì•ˆì „ê´€ë¦¬ ë° ì„±ê³¼ ì¸¡ì • ì¼ì • (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</div>`;

            // ì•ˆì „
            globalData.safetyData.forEach((row, rowIndex) => {
                let rowHTML = `<div class="cell cell-sidebar safety-row">${row.title}</div>`;
                let prepVal = globalData.prepSafety[rowIndex] || "";
                rowHTML += `<div class="cell prep-cell" contenteditable="true" onblur="updatePrep('safety', ${rowIndex}, this.innerText)">${prepVal}</div>`;
                for (let i = 1; i <= 16; i++) {
                    let tagsHTML = "";
                    if (row.monthlyTags && row.monthlyTags[i]) {
                        row.monthlyTags[i].forEach(tagStr => {
                            const [text, color] = tagStr.split("|");
                            tagsHTML += `<div class="tag ${color}">${text}</div>`;
                        });
                    }
                    rowHTML += `<div class="cell tag-container clickable-cell" onclick="openSafetyModal(${rowIndex}, ${i})">${tagsHTML}</div>`;
                }
                grid.innerHTML += rowHTML;
            });
        }

        function renderKpiTable() {
            const tbody = document.getElementById('kpiTableBody');
            tbody.innerHTML = "";
            globalData.kpiData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="kpi-td center"><strong>${row.month}ì›”</strong></td>
                    <td class="kpi-td editable center" contenteditable="true" onblur="updateKpi(${index}, 'process', this.innerText)">${row.process || ""}</td>
                    <td class="kpi-td editable center text-red" contenteditable="true" onblur="updateKpi(${index}, 'risk', this.innerText)">${row.risk || ""}</td>
                    <td class="kpi-td editable" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpi(${index}, 'activity', this.innerText)">${row.activity || ""}</td>
                    <td class="kpi-td editable center text-blue" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpi(${index}, 'kpi', this.innerText)">${row.kpi || ""}</td>
                    <td class="kpi-td editable center" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpi(${index}, 'docs', this.innerText)">${row.docs || ""}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. ì“°ê¸° (ì „ì—­ í•¨ìˆ˜)
        window.updateDB = async function () {
            globalData.headerInfo = {
                period: document.getElementById('infoPeriod').innerText, // This will capture the hardcoded text if user tries to save, but since it's hardcoded on render, it persists visually. But technically updating DB with hardcoded text is fine.
                scale: document.getElementById('infoScale').innerText,
                goal: document.getElementById('infoGoal').innerText
            };
            await updateDoc(docRef, { headerInfo: globalData.headerInfo });
        };

        window.updatePrep = async function (type, index, value) {
            if (type === 'const') globalData.prepConst[index] = value;
            else globalData.prepSafety[index] = value;
            await updateDoc(docRef, { prepConst: globalData.prepConst, prepSafety: globalData.prepSafety });
        };

        window.updateKpi = async function (index, key, value) {
            globalData.kpiData[index][key] = value;
            await updateDoc(docRef, { kpiData: globalData.kpiData });
        };

        // --- íŒì—… ---
        let currentTaskIndex = null;
        let selectedFile = null; // [Refactor] File object for upload
        let currentFileUrl = null; // [Refactor] Existing URL or Base64

        window.openModal = function (index) {
            currentTaskIndex = index;
            const savedDetail = (globalData.taskDetails && globalData.taskDetails[index]) || {};
            const defaultLabel = constructionData[index].label;

            document.getElementById('modalTitle').innerText = defaultLabel + " ìƒì„¸ í™œë™";

            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            document.getElementById('modalDate').value = savedDetail.workDate || today;

            document.getElementById('modalRisk').value = savedDetail.risk || "";
            document.getElementById('modalKPI').value = savedDetail.kpi || "";
            document.getElementById('modalActivity').value = savedDetail.activity || "";

            document.getElementById('fileInput').value = "";
            currentFileUrl = savedDetail.imageData || null;
            selectedFile = null;

            // [ìˆ˜ì •ë¨] ì €ì¥ëœ íŒŒì¼ì´ PDFì¸ì§€ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•˜ì—¬ í‘œì‹œ (URL í¬í•¨)
            const previewBox = document.getElementById('previewBox');
            const previewImg = document.getElementById('previewImg');
            const previewPdf = document.getElementById('previewPdf');

            if (currentFileUrl) {
                previewBox.style.display = "block";
                // ë°ì´í„° í—¤ë”ë¡œ íƒ€ì… êµ¬ë¶„ í˜¹ì€ URL í™•ì¥ì ì²´í¬
                const isPdf = currentFileUrl.toLowerCase().includes(".pdf") || currentFileUrl.startsWith("data:application/pdf");

                if (isPdf) {
                    previewImg.style.display = "none";
                    previewPdf.style.display = "block";
                    previewPdf.src = currentFileUrl;
                } else {
                    previewPdf.style.display = "none";
                    previewImg.style.display = "block";
                    previewImg.src = currentFileUrl;
                }
            } else {
                previewBox.style.display = "none";
                previewImg.src = "";
                previewPdf.src = "";
            }
            renderComments(index);
            document.getElementById('modal').style.display = 'flex';
        };

        window.closeModal = function () { document.getElementById('modal').style.display = 'none'; };

        // [ìˆ˜ì •ë¨] íŒŒì¼ ì²˜ë¦¬ (PDF ì§€ì›)
        // [ìˆ˜ì •ë¨] íŒŒì¼ ì²˜ë¦¬ (PDF ì§€ì›)
        window.handleFileSelect = function (input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // íŒŒì¼ ìš©ëŸ‰ ì²´í¬ (ì˜ˆ: 10MB ì œí•œ)
                if (file.size > 10 * 1024 * 1024) {
                    alert("íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (10MB ì´í•˜ë§Œ ê°€ëŠ¥)");
                    input.value = "";
                    return;
                }

                selectedFile = file; // ì—…ë¡œë“œ ëŒ€ê¸°
                // currentFileUrl = null; // Reset current URL on new selection? Maybe.

                const reader = new FileReader();
                reader.onload = function (e) {
                    currentFileUrl = e.target.result; // For preview only
                    const previewBox = document.getElementById('previewBox');
                    const previewImg = document.getElementById('previewImg');
                    const previewPdf = document.getElementById('previewPdf');

                    previewBox.style.display = "block";

                    if (file.type.includes("pdf")) {
                        previewImg.style.display = "none";
                        previewPdf.style.display = "block";
                        previewPdf.src = currentFileUrl;
                    } else {
                        previewPdf.style.display = "none";
                        previewImg.style.display = "block";
                        previewImg.src = currentFileUrl;
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.deleteFile = function () {
            if (confirm("ì²¨ë¶€íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                currentFileUrl = null;
                selectedFile = null;
                document.getElementById('previewBox').style.display = "none";
                document.getElementById('previewImg').src = "";
                document.getElementById('previewPdf').src = "";
                document.getElementById('fileInput').value = "";
            }
        };

        // [ìˆ˜ì •] ì €ì¥ ê¸°ëŠ¥
        // [ìˆ˜ì •] ì €ì¥ ê¸°ëŠ¥ (Subcollection)
        window.saveTaskDetails = async function () {
            try {
                if (!globalData.taskDetails) globalData.taskDetails = {};

                let finalImageUrl = currentFileUrl;

                // [Refactor] Upload to Firebase Storage
                if (selectedFile) {
                    const storageRef = ref(storage, `site_attachments/${SITE_ID}/${Date.now()}_${selectedFile.name}`);
                    await uploadBytes(storageRef, selectedFile);
                    finalImageUrl = await getDownloadURL(storageRef);
                }

                const taskData = {
                    workDate: document.getElementById('modalDate').value,
                    risk: document.getElementById('modalRisk').value,
                    kpi: document.getElementById('modalKPI').value,
                    activity: document.getElementById('modalActivity').value,
                    imageData: finalImageUrl,
                    lastUpdated: new Date().toISOString()
                };

                // ë¡œì»¬ ë°ì´í„° ê°±ì‹ 
                globalData.taskDetails[currentTaskIndex] = taskData;

                // Firestore Subcollection ì €ì¥ (ë¬¸ì„œ ID = currentTaskIndex)
                const taskDocRef = doc(db, "sites", SITE_ID, "taskDetails", String(currentTaskIndex));
                await setDoc(taskDocRef, taskData, { merge: true });

                alert("âœ… [ì €ì¥ ì™„ë£Œ]\n\nì•ˆì „ë³´ê±´ í™œë™ ë‚´ì—­ì´ ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\ní™”ë©´ í•˜ë‹¨ ëª©ë¡ì—ì„œ ë‚´ì—­ì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                closeModal();
            } catch (e) {
                alert("âŒ ì €ì¥ ì‹¤íŒ¨: ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ íŒŒì¼ ìš©ëŸ‰ì„ ì¤„ì—¬ì£¼ì„¸ìš”.");
                console.error(e);
            }
        };

        window.addComment = async function () {
            const name = document.getElementById('writerName').value.trim();
            const content = document.getElementById('commentContent').value.trim();
            if (!name || !content) return alert("ì…ë ¥í•˜ì„¸ìš”");

            const dateStr = new Date().toISOString().slice(0, 10);
            const newComment = { name, content, date: dateStr };

            // ë¡œì»¬ ë°ì´í„° ê°±ì‹ 
            if (!globalData.comments) globalData.comments = {};
            if (!globalData.comments[currentTaskIndex]) globalData.comments[currentTaskIndex] = [];
            globalData.comments[currentTaskIndex].push(newComment);

            // Firestore Subcollection ì €ì¥ (comments í•„ë“œëŠ” taskDetails ë¬¸ì„œ ë‚´ì— ì¡´ì¬í•œë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, ë³„ë„ ì»¬ë ‰ì…˜ì¼ ìˆ˜ ìˆìŒ)
            // ë°±ì—… íŒŒì¼ ë¡œì§ í™•ì¸ ê²°ê³¼: taskDetails ë¬¸ì„œ ë‚´ì˜ 'comments' í•„ë“œë¡œ ì €ì¥í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, 
            // comments ì—­ì‹œ ë³„ë„ ê´€ë¦¬ê°€ í•„ìš”í•´ ë³´ì´ë‚˜, ê¸°ì¡´ ë¡œì§ì´ 'comments' í•„ë“œë¥¼ ì—…ë°ì´íŠ¸ í•˜ëŠ” ê²ƒì´ì—ˆìŒ.
            // í•˜ì§€ë§Œ taskDetailsê°€ subcollectionì´ ë˜ì—ˆìœ¼ë¯€ë¡œ, í•´ë‹¹ ë¬¸ì„œì˜ í•„ë“œë¡œ ì €ì¥í•´ì•¼ í•¨.

            const taskDocRef = doc(db, "sites", SITE_ID, "taskDetails", String(currentTaskIndex));
            // taskDetails ë¬¸ì„œê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ setDoc(merge) ì‚¬ìš©
            // ì£¼ì˜: ë°°ì—´ updateëŠ” arrayUnionì„ ì“°ëŠ”ê²Œ ì¢‹ì§€ë§Œ, ì—¬ê¸°ì„  ì „ì²´ ë°°ì—´ ë®ì–´ì“°ê¸°ë¡œ ìœ ì§€ (ê¸°ì¡´ ë¡œì§ í˜¸í™˜)
            await setDoc(taskDocRef, { comments: globalData.comments[currentTaskIndex] }, { merge: true });

            document.getElementById('commentContent').value = '';
            renderComments(currentTaskIndex);
        };

        function renderComments(index) {
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            const comments = (globalData.comments && globalData.comments[index]) || [];
            comments.forEach((c, i) => {
                const li = document.createElement('li');
                li.className = 'comment-item';
                li.innerHTML = `<div><strong>${c.name}:</strong> ${c.content} <span class="comment-date">(${c.date})</span></div><button class="btn-del-comment" onclick="deleteComment(${i})">ì‚­ì œ</button>`;
                list.appendChild(li);
            });
        }

        window.deleteComment = async function (idx) {
            const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
            if (pwd === "1234") {
                globalData.comments[currentTaskIndex].splice(idx, 1);

                // Firestore Subcollection ì—…ë°ì´íŠ¸
                const taskDocRef = doc(db, "sites", SITE_ID, "taskDetails", String(currentTaskIndex));
                await setDoc(taskDocRef, { comments: globalData.comments[currentTaskIndex] }, { merge: true });

                renderComments(currentTaskIndex);
            } else if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        };

        // --- íƒœê·¸ í¸ì§‘ ---
        let safetyEditRow = null;
        let safetyEditMonth = null;
        let tempTags = [];

        window.openSafetyModal = function (rowIdx, month) {
            safetyEditRow = rowIdx;
            safetyEditMonth = month;
            document.getElementById('safetyModalTitle').innerText = `${month}ì›” ì¼ì • ìˆ˜ì •`;
            tempTags = [];
            if (globalData.safetyData[rowIdx].monthlyTags && globalData.safetyData[rowIdx].monthlyTags[month]) {
                tempTags = [...globalData.safetyData[rowIdx].monthlyTags[month]];
            }
            renderTempTags();
            document.getElementById('newTagText').value = "";
            document.getElementById('safetyModal').style.display = 'flex';
        };

        window.closeSafetyModal = function () { document.getElementById('safetyModal').style.display = 'none'; };

        function renderTempTags() {
            const container = document.getElementById('currentTagList');
            container.innerHTML = "";
            tempTags.forEach((tagStr, idx) => {
                const [text, color] = tagStr.split("|");
                const span = document.createElement('span');
                span.className = `tag-item tag ${color}`;
                span.innerHTML = `${text} <span class="del-btn" onclick="removeSafetyTag(${idx})">Ã—</span>`;
                container.appendChild(span);
            });
        }

        window.addSafetyTag = function () {
            const text = document.getElementById('newTagText').value.trim();
            const color = document.getElementById('newTagColor').value;
            if (!text) return;
            tempTags.push(`${text}|${color}`);
            renderTempTags();
            document.getElementById('newTagText').value = "";
            document.getElementById('newTagText').focus();
        };

        window.removeSafetyTag = function (idx) {
            tempTags.splice(idx, 1);
            renderTempTags();
        };

        window.saveSafetyChanges = async function () {
            if (!globalData.safetyData[safetyEditRow].monthlyTags) globalData.safetyData[safetyEditRow].monthlyTags = {};
            globalData.safetyData[safetyEditRow].monthlyTags[safetyEditMonth] = tempTags;
            await updateDoc(docRef, { safetyData: globalData.safetyData });
            closeSafetyModal();
        };

        window.deleteTaskDetail = async function (index) {
            if (confirm("ì •ë§ë¡œ ì´ í™œë™ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (pwd === "1234") {
                    // ë¡œì»¬ ì‚­ì œ
                    delete globalData.taskDetails[index];

                    // Firestore Subcollection ì‚­ì œ
                    const taskDocRef = doc(db, "sites", SITE_ID, "taskDetails", String(index));
                    await deleteDoc(taskDocRef);

                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    renderActivityLog();
                } else {
                    if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        };

        window.renderActivityLog = function () {
            const listContainer = document.getElementById('activityLogList');
            const searchText = document.getElementById('logSearchInput').value.toLowerCase();
            const details = globalData.taskDetails || {};

            let logArray = Object.keys(details).map(index => {
                return {
                    index: index,
                    taskName: constructionData[index].label,
                    data: details[index]
                };
            });

            logArray = logArray.filter(item =>
                (item.data.risk || item.data.kpi || item.data.activity)
            );

            if (searchText) {
                logArray = logArray.filter(item =>
                    item.taskName.toLowerCase().includes(searchText) ||
                    (item.data.risk && item.data.risk.toLowerCase().includes(searchText)) ||
                    (item.data.activity && item.data.activity.toLowerCase().includes(searchText))
                );
            }

            logArray.sort((a, b) => {
                const dateA = a.data.lastUpdated ? new Date(a.data.lastUpdated) : new Date(0);
                const dateB = b.data.lastUpdated ? new Date(b.data.lastUpdated) : new Date(0);
                return dateB - dateA;
            });

            if (logArray.length === 0) {
                listContainer.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë“±ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            listContainer.innerHTML = "";
            logArray.forEach(item => {
                const d = item.data;
                let dateStr = "ë‚ ì§œ ì •ë³´ ì—†ìŒ";
                if (d.lastUpdated) {
                    const dateObj = new Date(d.lastUpdated);
                    dateStr = dateObj.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                }

                const li = document.createElement('li');
                li.className = 'log-item';
                li.onclick = function () { openModal(item.index); };

                let badges = "";
                if (d.risk) badges += `<span class="log-badge badge-risk">í•µì‹¬ìœ„í—˜</span>`;
                if (d.kpi) badges += `<span class="log-badge badge-kpi">KPI</span>`;

                li.innerHTML = `
                    <div class="log-top">
                        <span>No. ${Number(item.index) + 1} &nbsp;&nbsp; ğŸ•’ ${dateStr}</span>
                        <button class="btn-log-delete" onclick="event.stopPropagation(); deleteTaskDetail('${item.index}')">ì‚­ì œ</button>
                    </div>
                    <div class="log-task">${item.taskName} ${badges}</div>
                    <div class="log-content">${d.activity ? d.activity : '<span style="color:#ccc">(í™œë™ ë‚´ìš© ì—†ìŒ)</span>'}</div>
                    ${d.risk ? `<div style="font-size:12px; color:#d9534f; margin-top:5px;">âš ï¸ ìœ„í—˜: ${d.risk}</div>` : ''}
                `;
                listContainer.appendChild(li);
            });
        };
        // [NEW] ë°˜ì… ì ê²€ ê´€ë ¨ í•¨ìˆ˜ë“¤
        window.openInspectionModal = function (type) {
            document.getElementById('inspectType').value = type;
            document.getElementById('inspectionModalTitle').innerText = `${type} ì ê²€ ë“±ë¡`;
            document.getElementById('inspectItem').value = "";
            document.getElementById('inspectDesc').value = "";
            document.getElementById('inspectFile').value = "";
            document.getElementsByName('inspectResult')[0].checked = true; // í•©ê²© ê¸°ë³¸
            document.getElementById('inspectionModal').style.display = 'flex';
        };

        window.closeInspectionModal = function () {
            document.getElementById('inspectionModal').style.display = 'none';
        };

        window.saveInspection = async function () {
            const type = document.getElementById('inspectType').value;
            const item = document.getElementById('inspectItem').value;
            const result = document.querySelector('input[name="inspectResult"]:checked').value;
            const desc = document.getElementById('inspectDesc').value;
            const files = document.getElementById('inspectFile').files;

            if (!item) return alert("í’ˆëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('#inspectionModal .btn-navy');
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì²«ë²ˆì§¸ íŒŒì¼ë§Œ ì˜ˆì‹œë¡œ ì²˜ë¦¬, í•„ìš”ì‹œ ë‹¤ì¤‘ ì²˜ë¦¬)
                let imageUrl = null;
                if (files.length > 0) {
                    const file = files[0];
                    const storageRef = ref(storage, `site_inspections/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(storageRef);
                }

                const today = new Date();
                const logData = {
                    type: type,
                    item: item,
                    result: result,
                    desc: desc,
                    imageUrl: imageUrl,
                    date: today.toLocaleString('ko-KR'),
                    timestamp: Date.now()
                };

                const inspectRef = collection(db, "sites", SITE_ID, "inspectionLogs");
                await addDoc(inspectRef, logData);

                // ì•Œë¦¼ ë°œì†¡ - ê¶Œí•œ í™•ì¸ í•„ìš”
                if (window.Notification && Notification.permission === "granted") {
                    new Notification(`[ë°˜ì…ì ê²€] ${type} - ${item}`, {
                        body: `ê²°ê³¼: ${result}\në‚´ìš©: ${desc}`,
                        icon: "/pwa-192x192.png" // ì•„ì´ì½˜ ê²½ë¡œ í™•ì¸ í•„ìš”
                    });
                }

                alert("ì ê²€ ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeInspectionModal();
            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerText = "ì €ì¥í•˜ê¸°";
                btn.disabled = false;
            }
        };

        window.renderInspectionLog = function () {
            const list = document.getElementById('inspectionList');
            // [ìˆ˜ì •] ê³µì •í‘œ í˜ì´ì§€ ë“±ì—ì„œ í•´ë‹¹ ì„¹ì…˜ì´ ì—†ì„ ê²½ìš° ì—ëŸ¬ ë°©ì§€
            if (!list) return;

            if (!globalData.inspectionLogs || globalData.inspectionLogs.length === 0) {
                list.innerHTML = '<li style="text-align:center; color:#999; padding:10px;">ë“±ë¡ëœ ì ê²€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            list.innerHTML = "";
            globalData.inspectionLogs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'inspection-item';
                // ìŠ¤íƒ€ì¼ ì •ì˜ê°€ í•„ìš”í•œ í´ë˜ìŠ¤ (CSSì— ì¶”ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ)
                const resultClass = log.result === 'í•©ê²©' ? 'status-pass' : 'status-fail';

                li.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:4px; border-bottom:1px solid #eee; padding:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <div>
                                <span style="background:#eee; color:#666; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">${log.type}</span>
                                <span style="font-weight:bold; color:#333;">${log.item}</span>
                            </div>
                            <button onclick="deleteLogItem('${log.id}')" style="border:none; background:none; color:#ccc; cursor:pointer;" title="ì‚­ì œ">Ã—</button>
                        </div>
                        <div style="font-size:12px; color:#888;">${log.date} ${log.desc ? '- ' + log.desc : ''}</div>
                        ${log.imageUrl ? `<a href="${log.imageUrl}" target="_blank" style="font-size:12px; color:var(--primary);">ğŸ“¸ ì‚¬ì§„ ë³´ê¸°</a>` : ''}
                        <div style="margin-top:4px;">
                            <span style="font-weight:bold; color:${log.result === 'í•©ê²©' ? 'green' : 'red'};">${log.result}</span>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        };

        window.deleteLogItem = async function (logId) {
            if (confirm("ì´ ì´ë ¥ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (pwd === "1234") {
                    try {
                        const logDocRef = doc(db, "sites", SITE_ID, "inspectionLogs", logId);
                        await deleteDoc(logDocRef);
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch (e) {
                        console.error(e);
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                    }
                } else {
                    if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        };
    </script>
</body>

</html>