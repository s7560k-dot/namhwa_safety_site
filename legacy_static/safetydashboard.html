<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety ON - ìŠ¤ë§ˆíŠ¸ ì•ˆì „ë³´ê±´ í”Œë«í¼</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        @font-face {
            font-family: 'SeoulHangang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_two@1.0/SeoulHangangM.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: Pretendard, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* ========================================= */
        /* [í•µì‹¬] ì¸ì‡„(PDF) ì „ìš© ìŠ¤íƒ€ì¼ ì„¤ì • */
        /* ========================================= */
        @media print {
            @page {
                size: A4;
                margin: 30mm 10mm 10mm 10mm;
            }

            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 10pt;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .page-break {
                page-break-before: always;
            }

            .avoid-break {
                page-break-inside: avoid;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 10px;
            }

            th,
            td {
                border: 1px solid #000;
                padding: 4px 8px;
                font-size: 9pt;
            }

            th {
                background-color: #f3f4f6 !important;
                text-align: center;
                font-weight: bold;
            }
        }

        .print-only {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDbVG3iL3FBJe6alPLZnhFW_QAGpzeqFoY",
            authDomain: "namhwa-safety-dashboard.firebaseapp.com",
            projectId: "namhwa-safety-dashboard",
            storageBucket: "namhwa-safety-dashboard.firebasestorage.app",
            messagingSenderId: "152864778612",
            appId: "1:152864778612:web:ecc482adce93a1534a2421"
        };

        // Firebase ì´ˆê¸°í™” ë³´ì¥
        let db = null;
        let storage = null;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            storage = firebase.storage();
            console.log("ğŸ”¥ Firebase ì—°ê²° ë° Firestore ì´ˆê¸°í™” ì™„ë£Œ, Storage ì´ˆê¸°í™” ì™„ë£Œ");
        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
        }

        // --- ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ ---
        const Icon = ({ children, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Shield = (props) => <Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></Icon>;
        const CalendarIcon = (props) => <Icon {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></Icon>;
        const Bell = (props) => <Icon {...props}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" /></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>;
        const MoreHorizontal = (props) => <Icon {...props}><circle cx="12" cy="12" r="1" /><circle cx="19" cy="12" r="1" /><circle cx="5" cy="12" r="1" /></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const AlertOctagon = (props) => <Icon {...props}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;
        const Edit2 = (props) => <Icon {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
        const Activity = (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></Icon>;
        const Truck = (props) => <Icon {...props}><rect x="1" y="3" width="15" height="13" /><polygon points="16 8 20 8 23 11 23 16 16 16 16 8" /><circle cx="5.5" cy="18.5" r="2.5" /><circle cx="18.5" cy="18.5" r="2.5" /></Icon>;
        const FlaskConical = (props) => <Icon {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><line x1="8.5" y1="2" x2="15.5" y2="2" /><path d="M8.5 14h7" /></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const Trash = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></Icon>;
        const Tool = (props) => <Icon {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
        const ArrowRight = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></Icon>;
        const ClipboardCheck = (props) => <Icon {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></Icon>;
        const LinkIcon = (props) => <Icon {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></Icon>;
        const Printer = (props) => <Icon {...props}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></Icon>;

        // [ìˆ˜ì •ë¨ 2026-02-14] ì˜¤ëŠ˜ ë‚ ì§œë¥¼ MM.DD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        const getTodayDate = () => {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${month}.${day}`;
        };

        // ì´ˆê¸° ë°ì´í„° (DBê°€ ë¹„ì–´ìˆì„ ë•Œ ì‚¬ìš©)
        const DEFAULT_SEED_DATA = {
            riskWorks: [
                { id: '1', team: 'ê³¨ì¡° 2íŒ€', task: '203ë™ ê°±í¼ ì¸ì–‘ ì‘ì—…', risk: 'ìƒ', status: 'ì‘ì—…ì¤‘', manager: 'ê¹€ì² ìˆ˜', workerCount: 5, eduCompleted: 5, assessment: 'í¬ë ˆì¸ ì¸ì–‘ ì¤‘ ë‚™í•˜ ìœ„í—˜, ì‹ í˜¸ìˆ˜ ë°°ì¹˜ ë° í•˜ë¶€ í†µì œ ì² ì €' },
                { id: '2', team: 'ì„¤ë¹„ 1íŒ€', task: 'ì§€í•˜ 2ì¸µ ë°€íê³µê°„ ìš©ì ‘', risk: 'ìƒ', status: 'ì˜ˆì •', manager: 'ì´ì˜í¬', workerCount: 3, eduCompleted: 2, assessment: 'ì§ˆì‹ ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•œ ì†¡í’ê¸° ê°€ë™ í•„ìˆ˜, ì‚°ì†Œ ë†ë„ ì¸¡ì • ê¸°ë¡' },
            ],
            notices: [
                { id: 'n1', type: 'ê³µì§€', title: '[í˜„ì¥] í˜¹ì„œê¸° ê·¼ë¡œì íœ´ê²Œ ì‹œê°„ ì¤€ìˆ˜ ì•ˆë‚´', content: 'ìµœê³  ê¸°ì˜¨ì´ 33ë„ ì´ìƒì¸ í­ì—¼ ì£¼ì˜ë³´ ë°œë ¹ ì‹œ ì˜¤í›„ 2ì‹œ~5ì‹œ ì‚¬ì´ ì˜¥ì™¸ì‘ì—… ë‹¨ì¶• ë° íœ´ì‹ì‹œê°„ì„ ì² ì €íˆ ì¤€ìˆ˜ ë°”ëë‹ˆë‹¤.', author: 'ì•ˆì „íŒ€ì¥' },
                { id: 'n2', type: 'ì¼ì •', title: '[í˜„ì¥] ì œ5íšŒ ì•ˆì „ë³´ê±´í˜‘ì˜ì²´ íšŒì˜', content: 'ê¸ˆì¼ 14:00 í˜„ì¥ íšŒì˜ì‹¤ì—ì„œ í˜‘ì˜ì²´ íšŒì˜ê°€ ìˆìŠµë‹ˆë‹¤.', author: 'í˜„ì¥ì†Œì¥' },
            ],
            issueList: [
                { id: 'i1', loc: '105ë™ 3ì¸µ', desc: 'ê°œêµ¬ë¶€ ë®ê°œ ë¯¸ì„¤ì¹˜ë¡œ ì¸í•œ ì¶”ë½ ìœ„í—˜', finder: 'ì•ˆì „ê³¼ì¥', status: 'new' },
                { id: 'i2', loc: 'ì§€í•˜ 1ì¸µ', desc: 'ê°€ì„¤ ë¶„ì „ë°˜ ì ‘ì§€ ëˆ„ë½', finder: 'ì „ê¸°ë°˜ì¥', status: 'processing' },
                { id: 'i3', loc: 'ì•¼ì ì¥', desc: 'ìì¬ ì •ë¦¬ì •ëˆ ë¶ˆëŸ‰', finder: 'ê´€ë¦¬ì', status: 'done' },
            ],
            inspectionLog: [
                { id: 'ins1', type: 'ì¥ë¹„', item: 'ì´ë™ì‹ í¬ë ˆì¸ (100t)', status: 'í•©ê²©' },
                { id: 'ins2', type: 'ê¸°ê³„', item: 'ìš©ì ‘ê¸° A-102', status: 'í•©ê²©' },
            ],
            workerDetails: [
                { id: 'w1', trade: 'ê´€ë¦¬ì', count: 12 },
                { id: 'w2', trade: 'ì² ê·¼ê³µ', count: 45 },
                { id: 'w3', trade: 'ëª©ê³µ', count: 30 },
            ]
        };

        // ==================================================================================
        // [ì¸ì‡„ìš© ë³´ê³ ì„œ ì»´í¬ë„ŒíŠ¸]
        // ==================================================================================
        const PrintReport = ({ data, siteName, currentDate, accidentFreeDays, targetDays }) => {
            return (
                <div className="print-only p-4">
                    <div className="border-b-2 border-black pb-4 mb-6">
                        <h1 className="text-3xl font-bold text-center mb-2">ì•ˆì „ë³´ê±´ ì¼ì¼ ë¦¬í¬íŠ¸</h1>
                        <div className="flex justify-between text-sm">
                            <span>í˜„ì¥ëª…: {siteName}</span>
                            <span>ì‘ì„±ì¼: {currentDate}</span>
                            <span>ë¬´ì¬í•´: {accidentFreeDays}ì¼ (ëª©í‘œ: {targetDays}ì¼)</span>
                        </div>
                    </div>
                    {/* 1. ê¸ˆì¼ ì¶œë ¥ í˜„í™© */}
                    <div className="mb-6 avoid-break">
                        <h2 className="text-xl font-bold border-l-4 border-black pl-2 mb-2">1. ê¸ˆì¼ ì¶œë ¥ í˜„í™©</h2>
                        <table className="w-full text-center">
                            <thead>
                                <tr className="bg-gray-100"><th>ê³µì¢…</th><th>ì¸ì›</th><th>ê³µì¢…</th><th>ì¸ì›</th><th>ê³µì¢…</th><th>ì¸ì›</th></tr>
                            </thead>
                            <tbody>
                                {Array.from({ length: Math.ceil(data.workerList.length / 3) }).map((_, rowIndex) => (
                                    <tr key={rowIndex}>
                                        {[0, 1, 2].map(colIndex => {
                                            const item = data.workerList[rowIndex * 3 + colIndex];
                                            return item ? (<React.Fragment key={colIndex}><td>{item.trade}</td><td>{item.count}ëª…</td></React.Fragment>) : (<React.Fragment key={colIndex}><td></td><td></td></React.Fragment>);
                                        })}
                                    </tr>
                                ))}
                                <tr className="font-bold bg-gray-50"><td colSpan="5" className="text-right pr-4">ì´ ì¶œë ¥ ì¸ì›</td><td>{data.workerList.reduce((acc, cur) => acc + parseInt(cur.count || 0), 0)}ëª…</td></tr>
                            </tbody>
                        </table>
                    </div>
                    {/* 2. ê³ ìœ„í—˜ ì‘ì—… */}
                    <div className="mb-6 avoid-break">
                        <h2 className="text-xl font-bold border-l-4 border-black pl-2 mb-2">2. ê³ ìœ„í—˜ ì‘ì—… ë° TBM(ìœ„í—˜ì„±í‰ê°€) ê¸°ë¡</h2>
                        <table className="w-full">
                            <thead><tr className="bg-gray-100"><th width="15%">ì‘ì—…íŒ€</th><th width="25%">ì‘ì—…ëª…</th><th width="10%">ìœ„í—˜ë„</th><th width="10%">ì¸ì›/êµìœ¡</th><th width="40%">ìœ„í—˜ì„±í‰ê°€ ë° ì¤‘ì  ê´€ë¦¬ ëŒ€ì±…</th></tr></thead>
                            <tbody>
                                {data.riskWorks.length > 0 ? data.riskWorks.map(work => (
                                    <tr key={work.id}><td className="text-center">{work.team}</td><td>{work.task}</td><td className="text-center">{work.risk}</td><td className="text-center">{work.eduCompleted} / {work.workerCount}</td><td className="text-left text-xs">{work.assessment || '-'}</td></tr>
                                )) : <tr><td colSpan="5" className="text-center py-4">ê¸ˆì¼ ê³ ìœ„í—˜ ì‘ì—… ì—†ìŒ</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {/* 3. ì•Œë¦¼ */}
                    <div className="mb-6 avoid-break">
                        <h2 className="text-xl font-bold border-l-4 border-black pl-2 mb-2">3. ì•ˆì „ ê³µì§€ì‚¬í•­</h2>
                        <table className="w-full">
                            <thead><tr className="bg-gray-100"><th width="15%">êµ¬ë¶„</th><th width="60%">ì œëª© ë° ë‚´ìš©</th><th width="15%">ì‘ì„±ì</th><th width="10%">ë‚ ì§œ</th></tr></thead>
                            <tbody>
                                {data.noticeData.length > 0 ? data.noticeData.map(notice => (
                                    <tr key={notice.id}><td className="text-center">{notice.type}</td><td><div className="font-bold">{notice.title}</div><div className="text-xs text-gray-500">{notice.content}</div></td><td className="text-center">{notice.author}</td><td className="text-center">{notice.date}</td></tr>
                                )) : <tr><td colSpan="4" className="text-center py-4">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ ì—†ìŒ</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    <div className="page-break"></div>
                    {/* 4. ë¶€ì í•© ì¡°ì¹˜ */}
                    <div className="mb-6">
                        <h2 className="text-xl font-bold border-l-4 border-black pl-2 mb-2">4. ì•ˆì „ ë¶€ì í•© ì¡°ì¹˜ í˜„í™©</h2>
                        <div className="grid grid-cols-2 gap-4">
                            {data.issueList.length > 0 ? data.issueList.map((issue, idx) => (
                                <div key={issue.id} className="border border-black p-2 avoid-break">
                                    <div className="flex justify-between border-b border-black mb-2 pb-1"><span className="font-bold text-sm">#{idx + 1}. {issue.loc}</span><span className="text-xs">ìƒíƒœ: {issue.status === 'done' ? 'ì¡°ì¹˜ì™„ë£Œ' : 'ì¡°ì¹˜ì¤‘'} | ë°œê²¬: {issue.finder}</span></div>
                                    <div className="text-sm mb-2 h-10 overflow-hidden">{issue.desc}</div>
                                    <div className="flex gap-1 h-32">
                                        <div className="w-1/2 border border-dashed border-gray-400 flex items-center justify-center bg-gray-50 overflow-hidden relative">
                                            {issue.beforeImg ? <img src={issue.beforeImg} className="w-full h-full object-contain" /> : <span className="text-xs text-gray-400">ì¡°ì¹˜ ì „ ì‚¬ì§„</span>}
                                        </div>
                                        <div className="w-1/2 border border-dashed border-gray-400 flex items-center justify-center bg-gray-50 overflow-hidden relative">
                                            {issue.afterImg ? <img src={issue.afterImg} className="w-full h-full object-contain" /> : <span className="text-xs text-gray-400">ì¡°ì¹˜ í›„ ì‚¬ì§„</span>}
                                        </div>
                                    </div>
                                </div>
                            )) : <div className="col-span-2 text-center py-4 border">ê¸ˆì¼ ë¶€ì í•© ì‚¬í•­ ì—†ìŒ</div>}
                        </div>
                    </div>
                    {/* 5. ì ê²€ ì´ë ¥ (PDF ì§€ì›) */}
                    <div className="mb-6 avoid-break">
                        <h2 className="text-xl font-bold border-l-4 border-black pl-2 mb-2">5. ë°˜ì… ì ê²€ ë° ê¸°íƒ€ ì ê²€ ê¸°ë¡</h2>
                        <table className="w-full">
                            <thead><tr className="bg-gray-100"><th width="15%">êµ¬ë¶„</th><th width="40%">ì ê²€ ëŒ€ìƒ</th><th width="15%">ì ê²€ì¼</th><th width="15%">ê²°ê³¼</th><th width="15%">í™•ì¸</th></tr></thead>
                            <tbody>
                                {data.inspectionLog.length > 0 ? data.inspectionLog.map(log => (
                                    <tr key={log.id}>
                                        <td className="text-center">{log.type}</td>
                                        <td>
                                            {log.item}
                                            {/* ì²¨ë¶€íŒŒì¼ ì•„ì´ì½˜ í‘œì‹œ */}
                                            {log.images && log.images.length > 0 && (
                                                <div className="flex gap-1 mt-1">
                                                    {log.images.map((img, idx) => (
                                                        <span key={idx} className="text-xs border rounded p-0.5 bg-gray-50">
                                                            {typeof img === 'string' ? 'ğŸ“· ì‚¬ì§„' : img.type === 'pdf' ? 'ğŸ“„ PDF' : 'ğŸ“· ì‚¬ì§„'}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </td>
                                        <td className="text-center">{log.date}</td>
                                        <td className="text-center font-bold">{log.status}</td>
                                        <td className="text-center text-gray-400">(ì„œëª…)</td>
                                    </tr>
                                )) : <tr><td colSpan="5" className="text-center py-4">ê¸ˆì¼ ì ê²€ ë‚´ì—­ ì—†ìŒ</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {/* [ì¶”ê°€] ê²°ì¬ ì„œëª…ë€ (5ì—´ 2í–‰) - ì‘ì„±, ê²€í† , ê²€í† , ì¡°ì •, ìŠ¹ì¸ */}
                    <div className="mt-12 flex justify-end avoid-break">
                        <table className="text-center border-collapse" style={{ width: '60%' }}>
                            <tbody>
                                <tr>
                                    <td rowSpan="2" className="border border-black bg-gray-100 font-bold w-10">ê²°<br />ì¬</td>
                                    <td className="border border-black bg-gray-50 p-1 font-bold">ì‘ì„±</td>
                                    <td className="border border-black bg-gray-50 p-1 font-bold">ê²€í† </td>
                                    <td className="border border-black bg-gray-50 p-1 font-bold">ê²€í† </td>
                                    <td className="border border-black bg-gray-50 p-1 font-bold">ì¡°ì •</td>
                                    <td className="border border-black bg-gray-50 p-1 font-bold">ìŠ¹ì¸</td>
                                </tr>
                                <tr>
                                    <td className="border border-black h-20"></td>
                                    <td className="border border-black h-20"></td>
                                    <td className="border border-black h-20"></td>
                                    <td className="border border-black h-20"></td>
                                    <td className="border border-black h-20"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div className="text-center text-xs text-gray-400 mt-8 border-t pt-4">ë‚¨í™”í† ê±´(ì£¼) ìŠ¤ë§ˆíŠ¸ ì•ˆì „ë³´ê±´ í”Œë«í¼ - Safety ON Output System</div>
                </div>
            );
        };

        const SafetyDashboard = () => {
            // [DEBUG] ë Œë”ë§ í™•ì¸ìš©

            const [currentDate, setCurrentDate] = useState('');
            const queryParams = new URLSearchParams(window.location.search);
            // [ìˆ˜ì •ë¨] ê¸°ë³¸ê°’ì„ 'siteB'(ìˆ˜ì› ë…¸ìœ ìì‹œì„¤)ë¡œ ì„¤ì •
            const siteId = queryParams.get('siteId') || 'siteB';

            // =================================================================
            // [í´ë” êµ¬ì¡° ì—°ë™ ë¡œì§] - siteConfig í™•ì¥ (í…Œë§ˆ ìƒ‰ìƒ ì¶”ê°€)
            // =================================================================
            const siteConfig = {
                'siteA': {
                    name: 'ëŒ€ê´‘ìƒˆë§ˆì„ê¸ˆê³  ì‹ ì¶•ê³µì‚¬',
                    link: './status_a/index.html',
                    theme: 'blue',
                    gradient: 'from-blue-700 to-blue-500',
                    text: 'text-blue-900',
                    bg: 'bg-blue-600'
                },
                'siteB': {
                    name: 'ìˆ˜ì› ë…¸ìœ ìì‹œì„¤ ì‹ ì¶•ê³µì‚¬',
                    link: './status_b/suwon.html',
                    theme: 'purple',
                    gradient: 'from-purple-700 to-purple-500',
                    text: 'text-purple-900',
                    bg: 'bg-purple-600'
                },
                'siteC': {
                    name: 'í‰íƒ ì„¸íƒì†Œ ì‹œì„¤ ì‹ ì¶• ê³µì‚¬',
                    link: './status_c/busan.html',
                    theme: 'green',
                    gradient: 'from-green-700 to-green-500',
                    text: 'text-green-900',
                    bg: 'bg-green-600'
                }
            };

            // í˜„ì¬ siteIdì— ë§ëŠ” ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì˜ëª»ëœ IDë©´ siteB ê¸°ë³¸)
            const currentSiteInfo = siteConfig[siteId] || siteConfig['siteB'];

            const [startDate, setStartDate] = useState('2024-01-01');
            const [targetDays, setTargetDays] = useState(500);
            const [accidentFreeDays, setAccidentFreeDays] = useState(0);

            // ì´ˆê¸° ìƒíƒœëŠ” ë¹ˆ ë°°ì—´ (DBì—ì„œ ë¶ˆëŸ¬ì˜´)
            const [riskWorks, setRiskWorks] = useState([]);
            const [noticeData, setNoticeData] = useState([]);
            const [issueList, setIssueList] = useState([]);
            const [inspectionLog, setInspectionLog] = useState([]);
            const [workerList, setWorkerList] = useState([]);

            // UI States
            const [logoUrl, setLogoUrl] = useState(null);
            const [showWorkerModal, setShowWorkerModal] = useState(false);
            const [showIssueModal, setShowIssueModal] = useState(false);
            const [selectedIssueType, setSelectedIssueType] = useState(null);
            const [editingWorkId, setEditingWorkId] = useState(null);
            const [showInspectionModal, setShowInspectionModal] = useState(false);
            const [inspectionType, setInspectionType] = useState('');
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            // [NEW] ì•Œë¦¼ ê´€ë ¨ State
            const [showNotifications, setShowNotifications] = useState(false);
            const [notifications, setNotifications] = useState([]);
            const [notificationCount, setNotificationCount] = useState(0);

            // [NEW] ê³µì§€ì‚¬í•­ ì‘ì„± ëª¨ë‹¬ State
            const [showNoticeWriteModal, setShowNoticeWriteModal] = useState(false);
            const [noticeFile, setNoticeFile] = useState(null);
            const [selectedNotice, setSelectedNotice] = useState(null); // ì„ íƒëœ ê³µì§€ì‚¬í•­


            // [ìˆ˜ì •ë¨] ì ê²€ ì´ë¯¸ì§€ ìƒíƒœ - ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì›ì„ ìœ„í•´ ë°°ì—´ë¡œ ë³€ê²½
            const [inspectionImages, setInspectionImages] = useState([]);

            // [NEW] íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ìƒíƒœ (Lightboxìš©)
            const [previewFile, setPreviewFile] = useState(null);

            // [NEW] ì•Œë¦¼ í† ê¸€ í•¸ë“¤ëŸ¬
            const handleToggleNotifications = (e) => {
                e.stopPropagation();
                console.log("Toggle Notifications clicked");
                setShowNotifications(prev => !prev);
            };

            // 1. ë‚ ì§œ ë° ë¬´ì¬í•´ ì¼ìˆ˜ ê³„ì‚°
            // [ìˆ˜ì •ë¨ 2026-02-14] ë‚ ì§œëŠ” ë§¤ë²ˆ í˜„ì¬ ë‚ ì§œë¡œ ìë™ ê³„ì‚°
            useEffect(() => {
                // ë‚ ì§œ ìë™ ì—…ë°ì´íŠ¸
                const today = new Date();
                setCurrentDate(`${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`);

                // ë¬´ì¬í•´ ì¼ìˆ˜ ê³„ì‚°
                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const startParts = startDate.split('-');
                const startMidnight = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
                const diffTime = todayMidnight - startMidnight;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                setAccidentFreeDays(diffDays >= 0 ? diffDays + 1 : 0);
            }); // [ìˆ˜ì •ë¨] ì˜ì¡´ì„± ë°°ì—´ ì œê±°: ë§¤ ë Œë”ë§ë§ˆë‹¤ í˜„ì¬ ë‚ ì§œ ê³„ì‚°

            // 2. DB ë¦¬ìŠ¤ë„ˆ ì—°ê²° (í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰)
            useEffect(() => {
                if (db) {
                    const siteRef = db.collection('sites').doc(siteId);

                    // [ì¶”ê°€] ì‚¬ì´íŠ¸ ì„¤ì •(ì‹¤ì°©ê³µì¼, ëª©í‘œì¼) ì‹¤ì‹œê°„ ë™ê¸°í™”
                    const unsubSite = siteRef.onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (data.startDate) setStartDate(data.startDate);
                            if (data.targetDays) setTargetDays(data.targetDays);
                        } else {
                            // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„¤ì •ê°’ ìƒì„±
                            siteRef.set({ startDate: '2024-01-01', targetDays: 500 }, { merge: true });
                        }
                    });

                    // [ìˆ˜ì •ë¨] ê°œë³„ ì»¬ë ‰ì…˜ ì‹œë”© (ì¤‘ë³µ ë°©ì§€)
                    const seedCollection = async (colName, data) => {
                        const colRef = siteRef.collection(colName);
                        const snap = await colRef.get();
                        if (snap.empty) {
                            const batch = db.batch();
                            data.forEach(d => batch.set(colRef.doc(d.id), d));
                            await batch.commit();
                        }
                    };

                    seedCollection('riskWorks', DEFAULT_SEED_DATA.riskWorks);
                    seedCollection('notices', DEFAULT_SEED_DATA.notices);
                    seedCollection('issues', DEFAULT_SEED_DATA.issueList);
                    seedCollection('inspections', DEFAULT_SEED_DATA.inspectionLog);
                    seedCollection('workers', DEFAULT_SEED_DATA.workerDetails);

                    // 2. ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                    const unsubRisk = siteRef.collection('riskWorks').onSnapshot(snap => setRiskWorks(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                    const unsubNotice = siteRef.collection('notices').orderBy('date', 'desc').onSnapshot(snap => setNoticeData(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                    const unsubIssue = siteRef.collection('issues').onSnapshot(snap => setIssueList(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                    const unsubInsp = siteRef.collection('inspections').orderBy('date', 'desc').onSnapshot(snap => setInspectionLog(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                    const unsubWorker = siteRef.collection('workers').onSnapshot(snap => setWorkerList(snap.docs.map(d => ({ id: d.id, ...d.data() }))));

                    return () => {
                        unsubSite(); // ì„¤ì • ë¦¬ìŠ¤ë„ˆ í•´ì œ
                        unsubRisk(); unsubNotice(); unsubIssue(); unsubInsp(); unsubWorker();
                    };
                }
            }, [siteId]);

            // [NEW] ë°ì´í„° ë³€ê²½ ì‹œ ì•Œë¦¼ ëª©ë¡ ê°±ì‹  (í†µí•© ì•Œë¦¼ ë¡œì§)
            useEffect(() => {
                // ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ (MM-DD)
                const today = new Date();
                const todayMMDD = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                // 1. ê³µì§€ì‚¬í•­ ì•Œë¦¼ ë³€í™˜
                const noticeNotis = noticeData.map(n => ({
                    id: `notice-${n.id}`,
                    source: 'notice',
                    label: 'ğŸ“¢ ê³µì§€ì‚¬í•­',
                    message: n.title,
                    date: n.date, // MM-DD
                    timestamp: n.createdAt || (n.id.includes('_') ? parseInt(n.id.split('_')[0]) : 0) // createdAt ìš°ì„ 
                }));

                // 2. ë¶€ì í•© ì¡°ì¹˜ ì•Œë¦¼ ë³€í™˜ (ì‹ ê·œë§Œ)
                const issueNotis = issueList
                    // .filter(i => i.status === 'new') // ì „ì²´ ë‹¤ ë³´ì—¬ì£¼ê¸°ë¡œ ë³€ê²½ (ìµœê·¼ í™œë™)
                    .map(i => ({
                        id: `issue-${i.id}`,
                        source: 'issue',
                        label: 'ğŸš¨ ì•ˆì „ ë¶€ì í•©',
                        message: `${i.loc} - ${i.desc}`,
                        date: i.date ? i.date.substring(5) : '', // YYYY-MM-DD -> MM-DD
                        timestamp: i.createdAt || (parseInt(i.id) || 0) // createdAt ìš°ì„ 
                    }));

                // 3. ë°˜ì… ì ê²€ ì•Œë¦¼ ë³€í™˜
                const inspectNotis = inspectionLog.map(i => ({
                    id: `insp-${i.id}`,
                    source: 'inspection',
                    label: 'ğŸ—ï¸ ë°˜ì… ì ê²€',
                    message: `${i.item} (${i.status})`,
                    date: i.date, // MM.DD or MM-DD
                    timestamp: i.createdAt || (parseInt(i.id) || 0) // createdAt ìš°ì„ 
                }));

                // 4. ê³ ìœ„í—˜ ì‘ì—… ì•Œë¦¼ (ì˜¤ëŠ˜ ë“±ë¡ëœ ê²ƒ ê°€ì •) -> createdAt í•„ìš”
                const riskNotis = riskWorks.filter(w => w.createdAt).map(w => ({
                    id: `risk-${w.id}`,
                    source: 'risk',
                    label: 'âš ï¸ ê³ ìœ„í—˜ ì‘ì—…',
                    message: `${w.team} - ${w.task}`,
                    date: todayMMDD,
                    timestamp: w.createdAt
                }));

                // í†µí•© ë° ì •ë ¬ (ìµœì‹ ìˆœ)
                const allNotis = [...noticeNotis, ...issueNotis, ...inspectNotis, ...riskNotis]
                    .sort((a, b) => b.timestamp - a.timestamp) // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ ì •ë ¬
                    .slice(0, 10); // ìµœì‹  10ê°œë§Œ

                setNotifications(allNotis);

                // ë°°ì§€ ì¹´ìš´íŠ¸: ì˜¤ëŠ˜(00:00:00 ì´í›„) ë“±ë¡ëœ í•­ëª© ìˆ˜
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ ìì •
                const todayTimestamp = todayStart.getTime();

                const todayCount = allNotis.filter(n => {
                    // timestampê°€ ì˜¤ëŠ˜ 00:00:00 ì´í›„ì¸ í•­ëª©ë§Œ ì¹´ìš´íŠ¸
                    return n.timestamp && n.timestamp >= todayTimestamp;
                }).length;

                setNotificationCount(todayCount);


            }, [noticeData, issueList, inspectionLog, riskWorks]);


            const issueCounts = {
                new: issueList.filter(i => i.status === 'new').length,
                processing: issueList.filter(i => i.status === 'processing').length,
                done: issueList.filter(i => i.status === 'done').length
            };
            const filteredIssues = issueList.filter(i => i.status === selectedIssueType);

            // --- Handlers (DB Write) ---

            // ë¡œê³  (ë¡œì»¬ í”„ë¦¬ë·°ë§Œ)
            const handleLogoUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setLogoUrl(reader.result); reader.readAsDataURL(file); } };

            // ì‘ì—… ê´€ë¦¬
            const handleWorkEdit = (id) => setEditingWorkId(id);
            const handleWorkSave = (id) => {
                setEditingWorkId(null);
                // ë³€ê²½ëœ ë‚´ìš©ì€ handleWorkChangeì—ì„œ ì´ë¯¸ ë¡œì»¬ stateì— ë°˜ì˜ë¨. 
                // í•˜ì§€ë§Œ DBì—ëŠ” ë°˜ì˜ ì•ˆë¨. ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ "Save" ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ DB ì—…ë°ì´íŠ¸ í•˜ë„ë¡ êµ¬í˜„.
                const workToSave = riskWorks.find(w => w.id === id);
                if (workToSave && db) db.collection('sites').doc(siteId).collection('riskWorks').doc(id).update(workToSave);
            };
            // Input Change -> Local State Update (UX ë°˜ì‘ì„±)
            const handleWorkChange = (id, field, value) => {
                setRiskWorks(riskWorks.map(work => work.id === id ? { ...work, [field]: value } : work));
            };

            const handleAddWork = () => {
                const newWork = {
                    team: '',
                    task: '',
                    risk: 'ì¤‘',
                    manager: '',
                    status: 'ì˜ˆì •',
                    workerCount: 0,
                    eduCompleted: 0,
                    assessment: '',
                    createdAt: Date.now() // [NEW] ìƒì„± ì‹œê°„ ì¶”ê°€
                };
                if (db) db.collection('sites').doc(siteId).collection('riskWorks').add(newWork);
            };

            // [ì¶”ê°€] ê³ ìœ„í—˜ ì‘ì—… ì‚­ì œ í•¨ìˆ˜
            const handleDeleteWork = (id) => {
                if (confirm("ì •ë§ë¡œ ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    if (db) db.collection('sites').doc(siteId).collection('riskWorks').doc(id).delete();
                }
            };

            // [ìˆ˜ì •ë¨] ì¶œë ¥ ì¸ì› ê´€ë¦¬ (ID ì¤‘ë³µ ë¬¸ì œ í•´ê²° + ë™ê¸°í™”)
            const handleWorkerChange = (id, field, value) => {
                setWorkerList(workerList.map(w => w.id === id ? { ...w, [field]: value } : w));
            };
            const handleAddWorker = () => setWorkerList([...workerList, { id: Date.now().toString(), trade: '', count: 0 }]);
            const handleDeleteWorker = (id) => setWorkerList(workerList.filter(w => w.id !== id));

            const saveWorkersToDB = async () => {
                if (!db) return;
                const batch = db.batch();
                const workerRef = db.collection('sites').doc(siteId).collection('workers');

                // 1. DBì— ìˆëŠ” ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const snapshot = await workerRef.get();
                const dbIds = snapshot.docs.map(doc => doc.id);
                const currentIds = workerList.map(w => String(w.id));

                // 2. ì‚­ì œëœ í•­ëª© ì²˜ë¦¬ (DBì—ëŠ” ìˆëŠ”ë° í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ê²ƒ ì‚­ì œ)
                dbIds.forEach(dbId => {
                    if (!currentIds.includes(dbId)) {
                        batch.delete(workerRef.doc(dbId));
                    }
                });

                // 3. í˜„ì¬ í•­ëª© ì—…ë°ì´íŠ¸/ì¶”ê°€
                workerList.forEach(w => {
                    const docRef = workerRef.doc(String(w.id));
                    batch.set(docRef, { trade: w.trade, count: parseInt(w.count) || 0 }, { merge: true });
                });

                await batch.commit();
                setShowWorkerModal(false);
            };

            // ë¶€ì í•© ì¡°ì¹˜
            const handleIssueChange = (id, field, value) => { setIssueList(issueList.map(issue => issue.id === id ? { ...issue, [field]: value } : issue)); };

            // [ì¶”ê°€] ë¶€ì í•© ì‹ ê·œ ë“±ë¡ í•¨ìˆ˜
            const handleAddIssue = () => {
                const newIssue = {
                    loc: '',
                    desc: '',
                    finder: 'ê´€ë¦¬ì',
                    status: 'new',
                    beforeImg: null,
                    afterImg: null,
                    date: new Date().toISOString().slice(0, 10),
                    createdAt: Date.now() // [NEW]
                };
                if (db) {
                    db.collection('sites').doc(siteId).collection('issues').add(newIssue);
                } else {
                    const tempId = Date.now().toString();
                    setIssueList([...issueList, { id: tempId, ...newIssue }]);
                }
            };

            // [ìˆ˜ì •ë¨] ë¶€ì í•© ì¡°ì¹˜ ì‚¬ì§„ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ - ì´ë¯¸ì§€ ì••ì¶• (ìë™ ìƒíƒœ ì „í™˜ ì œê±°)
            const handleIssueImageUpload = (id, type, e) => {
                const file = e.target.files[0];
                if (file) {
                    // ì´ë¯¸ì§€ ì••ì¶• ë¡œì§ ì¶”ê°€
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; // ìµœëŒ€ ë„ˆë¹„ ì œí•œ
                            const MAX_HEIGHT = 600; // ìµœëŒ€ ë†’ì´ ì œí•œ
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // ì••ì¶•ëœ ë°ì´í„° URL (JPEG, í’ˆì§ˆ 0.7)
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                            // ìƒíƒœ ì—…ë°ì´íŠ¸ ë° DB ì €ì¥ (ìë™ ìƒíƒœ ì „í™˜ ë¡œì§ ì œê±°)
                            setIssueList(prevList => {
                                return prevList.map(issue => {
                                    if (issue.id === id) {
                                        // DB ì—…ë°ì´íŠ¸ (ì••ì¶•ëœ ì´ë¯¸ì§€ ì‚¬ìš©)
                                        if (db) {
                                            const updateData = { [type]: dataUrl };
                                            db.collection('sites').doc(siteId).collection('issues').doc(id).update(updateData)
                                                .catch(err => {
                                                    console.error("Error updating document: ", err);
                                                    alert("ì‚¬ì§„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìš©ëŸ‰ì´ ë„ˆë¬´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                                                });
                                        }
                                        return { ...issue, [type]: dataUrl };
                                    }
                                    return issue;
                                });
                            });
                        };
                        img.src = readerEvent.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const saveIssueChanges = () => {
                if (!db) return;
                const batch = db.batch();
                filteredIssues.forEach(issue => {
                    const ref = db.collection('sites').doc(siteId).collection('issues').doc(issue.id);
                    batch.update(ref, {
                        loc: issue.loc,
                        finder: issue.finder,
                        desc: issue.desc,
                        beforeImg: issue.beforeImg || null, // ì´ë¯¸ì§€ í•„ë“œ ì¶”ê°€
                        afterImg: issue.afterImg || null
                    });
                });
                batch.commit().then(() => setShowIssueModal(false));
            };

            // [ìˆ˜ì •ë¨] ìƒíƒœ ë³€ê²½ ì‹œ í˜„ì¬ ë°ì´í„° ì „ì²´ ì—…ë°ì´íŠ¸ (ë‚´ìš©, ì‚¬ì§„ ë³´ì¡´ ê°•í™”)
            const changeIssueStatus = (id, newStatus) => {
                const targetIssue = issueList.find(i => i.id === id);
                if (!targetIssue) return;

                // ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ë°˜ì˜ (Optimistic Update)
                setIssueList(prev => prev.map(issue => issue.id === id ? { ...issue, status: newStatus } : issue));

                // DB ì—…ë°ì´íŠ¸ (ì „ì²´ í•„ë“œ ì—…ë°ì´íŠ¸í•˜ì—¬ ë‚´ìš©/ì‚¬ì§„ ë™ê¸°í™” ë³´ì¥)
                if (db) {
                    db.collection('sites').doc(siteId).collection('issues').doc(id).set({
                        ...targetIssue,
                        status: newStatus
                    }, { merge: true }) // merge: trueë¡œ ë®ì–´ì“°ê¸°
                        .catch(err => {
                            console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
                            alert("ìƒíƒœ ë³€ê²½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        });
                }
            };

            // ê³µì§€ì‚¬í•­ ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
            const handleAddNotice = () => {
                setShowNoticeWriteModal(true);
                setNoticeFile(null);
            };

            // [NEW] ê³µì§€ì‚¬í•­ ì €ì¥ (íŒŒì¼ ì—…ë¡œë“œ í¬í•¨) - Compat SDK ìŠ¤íƒ€ì¼ë¡œ ìˆ˜ì •
            const handleSaveNotice = async (e) => {
                e.preventDefault();
                const title = e.target.title.value;
                const content = e.target.content.value;

                if (!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                try {
                    let fileUrl = null;
                    let fileType = null;
                    let fileName = null;

                    if (noticeFile && storage) {
                        const fileRef = storage.ref(`site_notices/${Date.now()}_${noticeFile.name}`);
                        const snapshot = await fileRef.put(noticeFile);
                        fileUrl = await snapshot.ref.getDownloadURL();

                        fileType = noticeFile.type.includes('pdf') ? 'pdf' : 'image';
                        fileName = noticeFile.name;
                    }

                    await db.collection('sites').doc(siteId).collection('notices').add({
                        type: 'ê³µì§€',
                        title,
                        content,
                        author: 'ê´€ë¦¬ì',
                        date: new Date().toISOString().slice(5, 10),
                        attachment: fileUrl ? { url: fileUrl, type: fileType, name: fileName } : null,
                        createdAt: Date.now() // [NEW]
                    });

                    setShowNoticeWriteModal(false);
                } catch (err) {
                    console.error("ê³µì§€ì‚¬í•­ ì €ì¥ ì‹¤íŒ¨:", err);
                    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };
            // [ì¶”ê°€] ê³µì§€ì‚¬í•­ ì‚­ì œ ê¸°ëŠ¥
            const handleDeleteNotice = (id) => {
                if (confirm("ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                    if (pwd === "1234") {
                        if (db) db.collection('sites').doc(siteId).collection('notices').doc(id).delete();
                    } else if (pwd !== null) {
                        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    }
                }
            };

            // ì ê²€
            const openInspectionModal = (type) => {
                setInspectionType(type);
                setInspectionImages([]); // ì´ë¯¸ì§€ ë°°ì—´ ì´ˆê¸°í™”
                setShowInspectionModal(true);
            };

            // [ìˆ˜ì •ë¨] ì ê²€ ì´ë¯¸ì§€/PDF ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (Storage ì‚¬ìš© - Compat SDK)
            const handleInspectionImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                if (!storage) {
                    alert("Storageê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    return;
                }

                const uploadFile = async (file) => {
                    try {
                        const fileRef = storage.ref(`site_inspections/${Date.now()}_${file.name}`);
                        const snapshot = await fileRef.put(file);
                        const url = await snapshot.ref.getDownloadURL();

                        return {
                            type: file.type.includes('pdf') ? 'pdf' : 'image',
                            url: url,
                            name: file.name
                        };
                    } catch (err) {
                        console.error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
                        return null;
                    }
                };

                // ëª¨ë“  íŒŒì¼ ë¹„ë™ê¸° ì²˜ë¦¬
                const newAttachments = await Promise.all(files.map(uploadFile));
                setInspectionImages(prev => [...prev, ...newAttachments.filter(Boolean)]);
            };

            // [ì¶”ê°€] ì ê²€ ì´ë¯¸ì§€ ê°œë³„ ì‚­ì œ í•¸ë“¤ëŸ¬
            const handleRemoveInspectionImage = (index) => {
                setInspectionImages(prev => prev.filter((_, i) => i !== index));
            };

            const handleSaveInspection = (e) => {
                e.preventDefault();
                if (db) {
                    db.collection('sites').doc(siteId).collection('inspections').add({
                        type: inspectionType,
                        item: e.target.item.value,
                        date: new Date().toISOString().slice(5, 10),
                        status: e.target.result.value,
                        images: inspectionImages || [], // ì´ë¯¸ì§€ ë°°ì—´ ì €ì¥
                        createdAt: Date.now() // [NEW]
                    });
                }
                setShowInspectionModal(false);
            };

            // ì„¤ì • ì €ì¥ (DBì— ì €ì¥)
            const handleSaveSettings = (e) => {
                e.preventDefault();
                const newStartDate = e.target.startDate.value;
                const newTargetDays = parseInt(e.target.targetDays.value);

                // ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                setStartDate(newStartDate);
                setTargetDays(newTargetDays);

                // DBì— ì˜êµ¬ ì €ì¥
                if (db) {
                    db.collection('sites').doc(siteId).set({
                        startDate: newStartDate,
                        targetDays: newTargetDays
                    }, { merge: true });
                }
                setShowSettingsModal(false);
            };

            const closeModal = (setter) => (e) => { if (e.target === e.currentTarget) setter(false); };
            const getStatusColor = (status) => status === 'í•©ê²©' ? 'bg-green-100 text-green-600' : status === 'ë¶ˆí•©ê²©' ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-600';
            const handlePrint = () => { window.print(); };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans relative pb-20">
                    <PrintReport data={{ workerList, riskWorks, noticeData, issueList, inspectionLog }} siteName={currentSiteInfo.name} currentDate={currentDate} accidentFreeDays={accidentFreeDays} targetDays={targetDays} />
                    <div className="no-print">
                        {/* í—¤ë” ë°°ê²½ìƒ‰ì„ siteConfigì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë³€ê²½ */}
                        <header className={`bg-white shadow-sm sticky top-0 z-30 border-b-4 ${siteId === 'siteA' ? 'border-blue-500' : 'border-purple-500'}`}>
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
                                <div className="flex items-center w-1/4">
                                    <div><h1 className="text-xl font-bold text-gray-900 leading-tight">Safety ON</h1><p className="text-xs text-gray-500">ìŠ¤ë§ˆíŠ¸ ì•ˆì „ë³´ê±´ í”Œë«í¼</p></div>
                                </div>
                                <div className="flex-1 text-center">
                                    {/* ì œëª© ìƒ‰ìƒ ë™ì  ì ìš© */}
                                    <h2 className={`text-2xl font-extrabold tracking-wide font-['SeoulHangang'] drop-shadow-sm ${currentSiteInfo.text}`}>{currentSiteInfo.name}</h2>
                                    <p className="text-xs text-gray-400 mt-1">" ë‚¨í™”ì˜ ë¯¸ë˜ë¥¼ ì¼œë‹¤ "</p>
                                </div>
                                <div className="flex items-center justify-end space-x-6 w-1/4">
                                    <span className="text-sm font-medium text-gray-500 flex items-center hidden sm:flex"><CalendarIcon className="mr-2" size={16} /> {currentDate}</span>

                                    {/* [NEW] ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ (í´ë¦­ ì‹œ í† ê¸€) */}
                                    <div className="relative cursor-pointer z-[105]" onClick={handleToggleNotifications}>
                                        <Bell className={`hover:text-gray-600 transition ${showNotifications ? 'text-blue-500' : 'text-gray-400'}`} />
                                        {notificationCount > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold animate-bounce">
                                                {notificationCount}
                                            </span>
                                        )}

                                        {/* ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */}
                                        {showNotifications && (
                                            <div className="absolute top-10 right-0 w-80 bg-white rounded-xl shadow-xl border border-gray-100 z-[110] overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                                                <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                                    <h3 className="font-bold text-sm text-gray-800">ìµœê·¼ í™œë™ ì•Œë¦¼</h3>
                                                    <span className="text-xs text-gray-500">{notifications.length}ê±´</span>
                                                </div>
                                                <div className="max-h-64 overflow-y-auto">
                                                    {notifications.length > 0 ? (
                                                        notifications.map((noti, idx) => (
                                                            <div key={noti.id || idx} className="px-4 py-3 border-b border-gray-50 hover:bg-blue-50 transition flex items-start gap-3">
                                                                <div className={`mt-1 w-2 h-2 rounded-full shrink-0 ${noti.source === 'notice' ? 'bg-purple-500' :
                                                                    noti.source === 'issue' ? 'bg-red-500' :
                                                                        noti.source === 'risk' ? 'bg-yellow-500' : 'bg-blue-500'
                                                                    }`}></div>
                                                                <div>
                                                                    <p className="text-xs font-bold text-gray-500 mb-0.5">{noti.label}</p>
                                                                    <p className="text-sm text-gray-800 font-medium line-clamp-2">{noti.message}</p>
                                                                    <p className="text-[10px] text-gray-400 mt-1">{noti.time || noti.date}</p>
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="p-8 text-center text-gray-400 text-xs">
                                                            ìµœê·¼ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                                                        </div>
                                                    )}
                                                </div>
                                                {notifications.length > 0 && (
                                                    <div className="bg-gray-50 px-4 py-2 text-center border-t border-gray-100">
                                                        <button onClick={() => setNotifications([])} className="text-xs text-gray-500 hover:text-gray-800">ëª¨ë‘ ì§€ìš°ê¸°</button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* ê´€ë¦¬ ì•„ì´ì½˜ ìƒ‰ìƒ ë™ì  ì ìš© */}
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white cursor-pointer ${currentSiteInfo.bg}`}>ê´€ë¦¬</div>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            {/* Top Banner: ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ ë™ì  ì ìš© */}
                            <div className={`bg-gradient-to-r ${currentSiteInfo.gradient} rounded-2xl shadow-lg p-6 mb-8 text-white flex flex-col md:flex-row items-center justify-between animate-fade-in relative`}>
                                <button onClick={() => setShowSettingsModal(true)} className="absolute top-4 right-4 p-2 bg-white/20 rounded-full hover:bg-white/30 transition"><Settings size={20} className="text-white" /></button>
                                <div className="mb-4 md:mb-0">
                                    <h2 className="text-lg font-medium opacity-90 mb-1 flex items-center">ìš°ë¦¬ í˜„ì¥ ë¬´ì¬í•´ ê¸°ë¡ <button onClick={() => setShowSettingsModal(true)} className="ml-3 text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded flex items-center transition cursor-pointer border border-transparent hover:border-white/40" title="í´ë¦­í•˜ì—¬ ë‚ ì§œ ìˆ˜ì •">ì‹¤ì°©ê³µì¼: {startDate} <Edit2 size={12} className="ml-1 opacity-70" /></button></h2>
                                    <div className="flex items-end"><span className="text-5xl font-bold mr-2">{accidentFreeDays}</span><span className="text-xl mb-2">ì¼ì§¸</span><span className="ml-4 bg-white/20 px-3 py-1 rounded-full text-sm">ëª©í‘œ: {targetDays}ì¼</span></div>
                                </div>
                                <div className="flex space-x-8 text-center pr-12">
                                    <div className="cursor-pointer hover:bg-white/10 p-2 rounded-lg transition" onClick={() => setShowWorkerModal(true)}>
                                        <p className="text-sm opacity-75 mb-1 flex items-center justify-center">ê¸ˆì¼ ì¶œë ¥ ì¸ì› <MoreHorizontal size={12} className="ml-1" /></p>
                                        <p className="text-2xl font-bold flex items-center justify-center"><Users size={20} className="mr-1" /> {workerList.reduce((acc, cur) => acc + parseInt(cur.count || 0), 0)}ëª…</p>
                                    </div>
                                    <div className="h-12 w-px bg-white/30"></div>
                                    <div><p className="text-sm opacity-75 mb-1">ê³ ìœ„í—˜ ì‘ì—…</p><p className="text-2xl font-bold flex items-center justify-center text-yellow-300"><AlertTriangle size={20} className="mr-1" /> {riskWorks.length}ê±´</p></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 space-y-6">
                                    {/* 1. ê³ ìœ„í—˜ ì‘ì—… í˜„í™© */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 animate-fade-in" style={{ animationDelay: '0.1s' }}>
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-bold text-gray-800 flex items-center"><AlertOctagon className="text-red-500 mr-2" size={20} /> ê¸ˆì¼ ê³ ìœ„í—˜ ì‘ì—… í˜„í™©</h3>
                                            <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded font-bold animate-pulse">â— ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘</span>
                                        </div>
                                        <div className="overflow-x-auto mb-2">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-50 text-gray-500"><tr><th className="px-3 py-3 rounded-l-lg">ì‘ì—…íŒ€</th><th className="px-3 py-3">ì‘ì—… ë‚´ìš©</th><th className="px-3 py-3">ìœ„í—˜ë„</th><th className="px-3 py-3">íˆ¬ì… ì¸ì›</th><th className="px-3 py-3">ê°ë…ì</th><th className="px-3 py-3">ìƒíƒœ</th><th className="px-3 py-3 rounded-r-lg w-16">ê´€ë¦¬</th></tr></thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {riskWorks.map((work) => (
                                                        <tr key={work.id} className="hover:bg-gray-50">
                                                            {editingWorkId === work.id ? (
                                                                <>
                                                                    <td className="px-3 py-2"><input className="border rounded px-1 w-full" value={work.team} onChange={(e) => handleWorkChange(work.id, 'team', e.target.value)} /></td>
                                                                    <td className="px-3 py-2"><input className="border rounded px-1 w-full" value={work.task} onChange={(e) => handleWorkChange(work.id, 'task', e.target.value)} /></td>
                                                                    <td className="px-3 py-2"><select className="border rounded px-1" value={work.risk} onChange={(e) => handleWorkChange(work.id, 'risk', e.target.value)}><option value="ìƒ">ìƒ</option><option value="ì¤‘">ì¤‘</option><option value="í•˜">í•˜</option></select></td>
                                                                    <td className="px-3 py-2"><input type="number" className="border rounded px-1 w-full" value={work.workerCount} onChange={(e) => handleWorkChange(work.id, 'workerCount', e.target.value)} /></td>
                                                                    <td className="px-3 py-2"><input className="border rounded px-1 w-full" value={work.manager} onChange={(e) => handleWorkChange(work.id, 'manager', e.target.value)} /></td>
                                                                    <td className="px-3 py-2"><select className="border rounded px-1" value={work.status} onChange={(e) => handleWorkChange(work.id, 'status', e.target.value)}><option value="ì˜ˆì •">ì˜ˆì •</option><option value="ì§„í–‰">ì§„í–‰</option><option value="ì™„ë£Œ">ì™„ë£Œ</option></select></td>
                                                                    <td className="px-3 py-2 text-center"><button onClick={() => handleWorkSave(work.id)} className="text-green-600 bg-green-100 p-1 rounded"><Save size={16} /></button></td>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <td className="px-3 py-3 font-medium">{work.team}</td>
                                                                    <td className="px-3 py-3">{work.task}</td>
                                                                    <td className="px-3 py-3"><span className={`px-2 py-1 rounded text-xs font-bold ${work.risk === 'ìƒ' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600'}`}>{work.risk}</span></td>
                                                                    <td className="px-3 py-3 font-bold text-blue-600">{work.workerCount}ëª…</td>
                                                                    <td className="px-3 py-3">{work.manager}</td>
                                                                    <td className="px-3 py-3"><span className="flex items-center text-gray-500"><span className={`w-2 h-2 rounded-full mr-2 ${work.status === 'ì§„í–‰' ? 'bg-green-500 animate-pulse' : 'bg-gray-300'}`}></span>{work.status}</span></td>
                                                                    <td className="px-3 py-3 text-center">
                                                                        <button onClick={() => handleWorkEdit(work.id)} className="text-blue-500 p-1 rounded hover:bg-blue-50"><Edit2 size={16} /></button>
                                                                        {/* [ì¶”ê°€] ì‚­ì œ ë²„íŠ¼ */}
                                                                        <button onClick={() => handleDeleteWork(work.id)} className="text-red-500 p-1 rounded hover:bg-red-50 ml-1"><Trash size={16} /></button>
                                                                    </td>
                                                                </>
                                                            )}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button onClick={handleAddWork} className="w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-400 hover:border-blue-400 hover:text-blue-500 transition text-sm font-bold flex items-center justify-center"><Plus size={16} className="mr-1" /> ì‘ì—… ì¶”ê°€í•˜ê¸°</button>
                                    </div>

                                    {/* 2. ì•ˆì „ êµìœ¡ ë° ìœ„í—˜ì„±í‰ê°€ í˜„í™© */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 animate-fade-in" style={{ animationDelay: '0.2s' }}>
                                        <div className="flex items-center justify-between mb-6"><h3 className="text-lg font-bold text-gray-800 flex items-center"><ClipboardCheck className="text-blue-500 mr-2" size={20} /> ê³ ìœ„í—˜ ì‘ì—… ì•ˆì „ ê´€ë¦¬ (êµìœ¡ & ìœ„í—˜ì„±í‰ê°€)</h3></div>
                                        {riskWorks.length === 0 ? <div className="text-center py-8 text-gray-400 border-2 border-dashed rounded-lg">ë“±ë¡ëœ ê³ ìœ„í—˜ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div> : (
                                            <div className="space-y-6">
                                                {riskWorks.map((work) => {
                                                    const eduCompleted = parseInt(work.eduCompleted) || 0;
                                                    const workerCount = parseInt(work.workerCount) || 0;
                                                    const rate = workerCount > 0 ? Math.round((eduCompleted / workerCount) * 100) : 0;
                                                    const isOverflow = rate > 100;
                                                    const normalWidth = isOverflow ? 100 : rate;
                                                    const overflowWidth = isOverflow ? (rate - 100) : 0;

                                                    return (
                                                        <div key={work.id} className="border border-gray-200 rounded-xl p-5 bg-gray-50 hover:bg-white transition hover:shadow-md">
                                                            <div className="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                                                                <div>
                                                                    <div className="flex items-center gap-2 mb-1"><span className="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded font-bold">{work.team}</span><span className={`text-xs px-2 py-0.5 rounded font-bold ${work.risk === 'ìƒ' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600'}`}>ìœ„í—˜ë„ {work.risk}</span></div>
                                                                    <h4 className="font-bold text-gray-800 text-lg">{work.task}</h4>
                                                                </div>
                                                                <div className="flex-1 max-w-md bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <span className="text-sm font-bold text-gray-600">íŠ¹ë³„ ì•ˆì „ êµìœ¡ ì´ìˆ˜ í˜„í™©</span>
                                                                        <span className={`text-sm font-bold ${rate >= 100 ? 'text-green-600' : rate >= 80 ? 'text-blue-600' : 'text-orange-500'}`}>
                                                                            {rate}% {isOverflow ? '(ì´ˆê³¼ ë‹¬ì„±!)' : 'ë‹¬ì„±'}
                                                                        </span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2.5 mb-2 relative overflow-hidden">
                                                                        {/* 100%ê¹Œì§€ëŠ” ê¸°ë³¸ ìƒ‰ìƒ (ì´ˆë¡/íŒŒë‘) */}
                                                                        <div
                                                                            className={`h-2.5 ${isOverflow ? 'rounded-l-full' : 'rounded-full'} transition-all duration-500 ${rate >= 100 ? 'bg-green-500' : 'bg-blue-500'}`}
                                                                            style={{ width: `${normalWidth}%` }}>
                                                                        </div>
                                                                        {/* 100% ì´ˆê³¼ ì‹œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ */}
                                                                        {isOverflow && (
                                                                            <div
                                                                                className="h-2.5 bg-red-400 rounded-r-full transition-all duration-500 absolute left-full -translate-x-full"
                                                                                style={{ width: `${Math.min(overflowWidth, 20)}%` }}
                                                                                title={`ì´ˆê³¼: ${overflowWidth}%`}>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <div className="flex justify-between items-center text-xs">
                                                                        <span className="text-gray-500">êµìœ¡ ëŒ€ìƒ: <strong className="text-gray-800">{work.workerCount}ëª…</strong></span>
                                                                        <div className="flex items-center gap-2">
                                                                            <span>ì´ìˆ˜ ì™„ë£Œ:</span>
                                                                            <input
                                                                                type="number"
                                                                                min="0"
                                                                                className="w-16 border rounded px-1 py-0.5 text-center font-bold"
                                                                                value={work.eduCompleted}
                                                                                onChange={(e) => handleWorkChange(work.id, 'eduCompleted', parseInt(e.target.value) || 0)}
                                                                                onBlur={() => handleWorkSave(work.id)}
                                                                            />
                                                                            <span>ëª…</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="mt-3">
                                                                <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">ì‚¬ì „ ìœ„í—˜ì„±í‰ê°€ ë° ì¤‘ì  ê´€ë¦¬ ëŒ€ì±…</label>
                                                                <textarea className="w-full p-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 resize-none bg-white" rows="2" placeholder="ì£¼ìš” ìœ„í—˜ ìš”ì¸ê³¼ ì•ˆì „ ëŒ€ì±…ì„ ì…ë ¥í•˜ì„¸ìš”." value={work.assessment} onChange={(e) => handleWorkChange(work.id, 'assessment', e.target.value)} onBlur={() => handleWorkSave(work.id)}></textarea>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>

                                    {/* 3. ì•Œë¦¼ ê²Œì‹œíŒ */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 animate-fade-in" style={{ animationDelay: '0.3s' }}>
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-bold text-gray-800 flex items-center"><MessageSquare className="text-purple-500 mr-2" size={20} /> Safety ì•Œë¦¼ ê²Œì‹œíŒ</h3>
                                            <button onClick={handleAddNotice} className="text-sm px-3 py-1 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 transition flex items-center"><Plus size={12} className="mr-1" /> ê¸€ì“°ê¸°</button>
                                        </div>
                                        <div className="space-y-3">
                                            {noticeData.map((notice) => (
                                                <div key={notice.id} onClick={() => setSelectedNotice(notice)} className="flex items-center justify-between p-3 border-b border-gray-50 hover:bg-gray-50 transition cursor-pointer group">
                                                    <div className="flex items-center gap-3"><span className={`text-xs font-bold px-2 py-1 rounded ${notice.type === 'ê³µì§€' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>{notice.type}</span><span className="text-sm font-medium text-gray-800 hover:text-blue-600 transition">{notice.title}</span></div>
                                                    <div className="flex items-center text-xs text-gray-400 gap-3">
                                                        <span>{notice.author}</span><span>{notice.date}</span>
                                                        <button onClick={(e) => { e.stopPropagation(); handleDeleteNotice(notice.id); }} className="p-1 hover:bg-red-100 rounded text-gray-400 hover:text-red-500 transition ml-2"><Trash size={14} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    {/* 4. ë¶€ì í•© ì¡°ì¹˜ í˜„í™© */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 animate-fade-in" style={{ animationDelay: '0.4s' }}>
                                        <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><CheckCircle className="text-green-500 mr-2" size={20} /> ì•ˆì „ ë¶€ì í•© ì¡°ì¹˜</h3>
                                        <div className="space-y-3">
                                            <div onClick={() => { setSelectedIssueType('new'); setShowIssueModal(true); }} className="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-100 cursor-pointer hover:-translate-y-1 transition"><div className="flex items-center"><div className="w-8 h-8 rounded-full bg-red-200 flex items-center justify-center text-red-600 mr-3"><AlertTriangle size={16} /></div><span className="text-sm font-bold text-gray-700">ì‹ ê·œ ë°œê²¬ (ì ‘ìˆ˜ ëŒ€ê¸°)</span></div><span className="text-xl font-bold text-red-600">{issueCounts.new}</span></div>
                                            <div onClick={() => { setSelectedIssueType('processing'); setShowIssueModal(true); }} className="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-100 cursor-pointer hover:-translate-y-1 transition"><div className="flex items-center"><div className="w-8 h-8 rounded-full bg-yellow-200 flex items-center justify-center text-yellow-600 mr-3"><Activity size={16} /></div><span className="text-sm font-bold text-gray-700">ì¡°ì¹˜ ì¤‘ (ì§„í–‰)</span></div><span className="text-xl font-bold text-yellow-600">{issueCounts.processing}</span></div>
                                            <div onClick={() => { setSelectedIssueType('done'); setShowIssueModal(true); }} className="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-100 cursor-pointer hover:-translate-y-1 transition"><div className="flex items-center"><div className="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-600 mr-3"><CheckCircle size={16} /></div><span className="text-sm font-bold text-gray-700">ì¡°ì¹˜ ì™„ë£Œ</span></div><span className="text-xl font-bold text-green-600">{issueCounts.done}</span></div>
                                        </div>
                                    </div>

                                    {/* 5. ë°˜ì… ì ê²€ ë° ì•Œë¦¼ */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 animate-fade-in" style={{ animationDelay: '0.5s' }}>
                                        <h3 className="text-lg font-bold text-gray-800 mb-4">ë°˜ì… ì ê²€ ë° ì•Œë¦¼</h3>
                                        <div className="grid grid-cols-1 gap-2 mb-4">
                                            <button onClick={() => openInspectionModal('ê±´ì„¤ì¥ë¹„')} className="py-2.5 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold hover:bg-blue-100 flex items-center justify-center border border-blue-100"><Truck size={16} className="mr-2" /> ê±´ì„¤ì¥ë¹„ ì ê²€</button>
                                            <button onClick={() => openInspectionModal('ê¸°ê³„ê¸°êµ¬')} className="py-2.5 bg-orange-50 text-orange-700 rounded-lg text-sm font-bold hover:bg-orange-100 flex items-center justify-center border border-orange-100"><Tool size={16} className="mr-2" /> ê¸°ê³„ê¸°êµ¬ ì ê²€</button>
                                            <button onClick={() => openInspectionModal('ìœ í•´í™”í•™ë¬¼ì§ˆ')} className="py-2.5 bg-purple-50 text-purple-700 rounded-lg text-sm font-bold hover:bg-purple-100 flex items-center justify-center border border-purple-100"><FlaskConical size={16} className="mr-2" /> ìœ í•´í™”í•™ë¬¼ì§ˆ ì ê²€</button>
                                        </div>
                                        <ul className="space-y-3 mt-4">
                                            {inspectionLog.slice(0, 5).map(log => (
                                                <li key={log.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                    <div className="flex flex-col">
                                                        <span className="font-medium text-gray-700">{log.item}</span>
                                                        <span className="text-xs text-gray-500">{log.type} | {log.date}</span>
                                                        {/* [NEW] ë¦¬ìŠ¤íŠ¸ì— ì²¨ë¶€íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì•„ì´ì½˜ ì¶”ê°€ */}
                                                        {log.images && log.images.length > 0 && (
                                                            <div className="flex gap-1 mt-1">
                                                                {log.images.map((img, idx) => (
                                                                    <div key={idx} onClick={(e) => { e.stopPropagation(); setPreviewFile(typeof img === 'string' ? { url: img, name: 'ì´ë¯¸ì§€' } : img); }} className="cursor-pointer text-xs border rounded px-1 py-0.5 bg-white hover:bg-gray-100 flex items-center gap-1 text-gray-600 transition">
                                                                        {typeof img === 'string' || (img.type && img.type.includes('image')) ? <span className="text-[10px]">ğŸ“·</span> : <span className="text-[10px]">ğŸ“„</span>}
                                                                        <span className="max-w-[80px] truncate">{typeof img === 'string' ? 'ì´ë¯¸ì§€' : img.name}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <span className={`text-xs px-2 py-1 rounded font-bold ${getStatusColor(log.status)}`}>{log.status}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </main>

                        {/* Footer */}
                        <footer className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 border-t border-gray-200 mt-8 relative flex justify-center items-center">
                            <p className="text-gray-400 text-sm font-medium">ë‚¨í™”í† ê±´(ì£¼) ì•ˆì „ë³´ê±´íŒ€</p>
                            <div className="absolute right-4 flex space-x-2">
                                <button onClick={handlePrint} className="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition shadow-sm whitespace-nowrap"><Printer size={16} className="mr-2" /> PDF ë³´ê³ ì„œ ì¶œë ¥</button>
                                {/* [ìˆ˜ì •ë¨ 2026-02-14] ì˜ˆì •ê³µì •í‘œ ë§í¬ - ë³µêµ¬ëœ ì‹¤ì œ ê³µì •í‘œ íŒŒì¼ë¡œ ì—°ê²° */}
                                {/* [ìˆ˜ì •ë¨ 2026-02-14] ì˜ˆì •ê³µì •í‘œ ë§í¬ - ë³µêµ¬ëœ ì‹¤ì œ ê³µì •í‘œ íŒŒì¼ë¡œ ì—°ê²° */}
                                {/* ëŒ€ê´‘ìƒˆë§ˆì„ê¸ˆê³ (siteA): status_a/index.html, ìˆ˜ì›ë…¸ìœ ìì‹œì„¤(siteB): status_b/suwon.html, ë¶€ì‚°ì‹ ì¶•(siteC): status_c/busan.html */}
                                <a href={currentSiteInfo.link} target="_blank" className="flex items-center bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 whitespace-nowrap border border-purple-400/30"><LinkIcon size={18} className="mr-2" /> ì˜ˆì •ê³µì •í‘œ ë°”ë¡œê°€ê¸°</a>
                                <a href="index.html" className="flex items-center bg-gray-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-700 transition shadow-sm whitespace-nowrap">ë‚˜ê°€ê¸°</a>
                            </div>
                        </footer>

                        {/* Modals */}
                        {showSettingsModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={closeModal(setShowSettingsModal)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 flex justify-between items-center bg-gray-800 text-white rounded-t-xl"><h3 className="font-bold">ë¬´ì¬í•´ ëª©í‘œ ì„¤ì •</h3><button onClick={() => setShowSettingsModal(false)}><X size={24} /></button></div>
                                    <form onSubmit={handleSaveSettings} className="p-6 space-y-4">
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ì‹¤ì°©ê³µì¼</label><input name="startDate" type="date" defaultValue={startDate} className="w-full border rounded-lg p-2" required /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ëª©í‘œì¼ìˆ˜</label><input name="targetDays" type="number" defaultValue={targetDays} className="w-full border rounded-lg p-2" required /></div>
                                        <button type="submit" className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700">ì„¤ì • ì €ì¥</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {showWorkerModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center animate-fade-in" onClick={closeModal(setShowWorkerModal)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                                    <div className="bg-green-600 p-4 flex justify-between items-center text-white"><h3 className="font-bold">ê¸ˆì¼ ì¶œë ¥ ì¸ì› ìˆ˜ì •</h3><button onClick={() => setShowWorkerModal(false)}><X size={20} /></button></div>
                                    <div className="p-4">
                                        <div className="space-y-2 max-h-[60vh] overflow-y-auto mb-3">
                                            {workerList.map((worker) => (
                                                <div key={worker.id} className="flex items-center gap-2 mb-2">
                                                    <input type="text" className="border p-2 rounded w-1/2 text-sm" value={worker.trade} onChange={(e) => handleWorkerChange(worker.id, 'trade', e.target.value)} placeholder="ê³µì¢…ëª…" />
                                                    <input type="number" className="border p-2 rounded w-1/3 text-sm" value={worker.count} onChange={(e) => handleWorkerChange(worker.id, 'count', e.target.value)} placeholder="ì¸ì›" />
                                                    <button onClick={() => handleDeleteWorker(worker.id)} className="text-red-400 hover:text-red-600"><Trash size={16} /></button>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={handleAddWorker} className="w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-200">+ ê³µì¢… ì¶”ê°€</button>
                                        <button onClick={saveWorkersToDB} className="w-full mt-2 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700">ì €ì¥ ë° ë‹«ê¸°</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showIssueModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={closeModal(setShowIssueModal)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                    {/* ëª¨ë‹¬ í—¤ë” */}
                                    <div className={`p-5 flex justify-between items-center text-white rounded-t-xl shrink-0 ${selectedIssueType === 'new' ? 'bg-red-500' : selectedIssueType === 'processing' ? 'bg-yellow-500' : 'bg-green-500'}`}>
                                        <h3 className="font-bold text-lg">{selectedIssueType === 'new' ? 'ì‹ ê·œ ë°œê²¬ ëª©ë¡' : selectedIssueType === 'processing' ? 'ì¡°ì¹˜ ì¤‘ ëª©ë¡' : 'ì¡°ì¹˜ ì™„ë£Œ ëª©ë¡'}</h3>
                                        <button onClick={() => setShowIssueModal(false)} className="hover:bg-white/20 rounded-full p-1 transition"><X size={24} /></button>
                                    </div>

                                    {/* ëª¨ë‹¬ ë°”ë”” (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) */}
                                    <div className="p-6 space-y-6 overflow-y-auto bg-gray-50 flex-1">
                                        {/* [ì¶”ê°€] ì‹ ê·œ ë“±ë¡ ë²„íŠ¼ (ì‹ ê·œ ë°œê²¬ ëª©ë¡ì¼ ë•Œë§Œ í‘œì‹œ) */}
                                        {selectedIssueType === 'new' && (
                                            <button onClick={handleAddIssue} className="w-full py-3 bg-red-50 text-red-600 rounded-lg border-2 border-dashed border-red-200 font-bold mb-4 hover:bg-red-100 transition flex items-center justify-center">
                                                <Plus size={18} className="mr-2" /> + ì‹ ê·œ ë¶€ì í•© ì‚¬í•­ ë“±ë¡
                                            </button>
                                        )}

                                        {filteredIssues.length > 0 ? filteredIssues.map(issue => (
                                            <div key={issue.id} className="bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-200">
                                                {/* ìƒë‹¨: ì¥ì†Œ ë° ë°œê²¬ì */}
                                                <div className="flex justify-between items-end mb-4 pb-2 border-b border-gray-100">
                                                    <div className="flex-1 mr-4">
                                                        <input
                                                            type="text"
                                                            className="w-full text-xl font-bold text-gray-800 bg-transparent placeholder-gray-300 focus:outline-none focus:placeholder-gray-200"
                                                            value={issue.loc}
                                                            onChange={(e) => handleIssueChange(issue.id, 'loc', e.target.value)}
                                                            placeholder="ì¥ì†Œ ì…ë ¥ (ì˜ˆ: 105ë™ 3ì¸µ)"
                                                        />
                                                    </div>
                                                    <div className="flex items-center bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                                                        <span className="text-xs text-gray-500 mr-2 font-medium">ë°œê²¬ì:</span>
                                                        <input
                                                            type="text"
                                                            className="bg-transparent text-sm text-gray-700 font-medium focus:outline-none w-20 text-right border-b border-gray-300 focus:border-gray-500"
                                                            value={issue.finder}
                                                            onChange={(e) => handleIssueChange(issue.id, 'finder', e.target.value)}
                                                        />
                                                    </div>
                                                </div>

                                                {/* ë‚´ìš© ì…ë ¥ */}
                                                <textarea
                                                    className="w-full border border-gray-200 rounded-lg p-4 text-gray-700 text-sm focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-50 resize-none h-28 mb-5 placeholder-gray-300 leading-relaxed"
                                                    value={issue.desc}
                                                    onChange={(e) => handleIssueChange(issue.id, 'desc', e.target.value)}
                                                    placeholder="ì•ˆì „ ë¶€ì í•© ì‚¬í•­ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”."
                                                />

                                                {/* ì‚¬ì§„ ì—…ë¡œë“œ ì˜ì—­ */}
                                                <div className="grid grid-cols-2 gap-4 mb-6">
                                                    <label className="group border-2 border-dashed border-gray-200 rounded-xl h-32 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 transition-colors bg-gray-50 hover:bg-white overflow-hidden relative">
                                                        {issue.beforeImg ? (
                                                            <img src={issue.beforeImg} alt="ì¡°ì¹˜ ì „" className="w-full h-full object-cover" />
                                                        ) : (
                                                            <>
                                                                <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2 group-hover:bg-gray-200 transition">
                                                                    <Upload size={18} className="text-gray-400 group-hover:text-gray-600" />
                                                                </div>
                                                                <span className="text-xs font-bold text-gray-400 group-hover:text-gray-600">ì¡°ì¹˜ ì „ ì‚¬ì§„</span>
                                                            </>
                                                        )}
                                                        <input type="file" className="hidden" accept="image/*" onChange={(e) => handleIssueImageUpload(issue.id, 'beforeImg', e)} />
                                                    </label>
                                                    <label className="group border-2 border-dashed border-gray-200 rounded-xl h-32 flex flex-col items-center justify-center cursor-pointer hover:border-green-400 transition-colors bg-gray-50 hover:bg-white overflow-hidden relative">
                                                        {issue.afterImg ? (
                                                            <img src={issue.afterImg} alt="ì¡°ì¹˜ í›„" className="w-full h-full object-cover" />
                                                        ) : (
                                                            <>
                                                                <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2 group-hover:bg-green-50 transition">
                                                                    <Upload size={18} className="text-gray-400 group-hover:text-green-500" />
                                                                </div>
                                                                <span className="text-xs font-bold text-gray-400 group-hover:text-green-600">ì¡°ì¹˜ í›„ ì‚¬ì§„</span>
                                                            </>
                                                        )}
                                                        <input type="file" className="hidden" accept="image/*" onChange={(e) => handleIssueImageUpload(issue.id, 'afterImg', e)} />
                                                    </label>
                                                </div>

                                                {/* í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ */}
                                                <div className="flex gap-3">
                                                    <button
                                                        className="flex-1 bg-gray-100 text-gray-600 py-3.5 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors"
                                                        onClick={saveIssueChanges}
                                                    >
                                                        ë‚´ìš© ì €ì¥
                                                    </button>

                                                    {selectedIssueType === 'new' && (
                                                        <button className="flex-1 bg-yellow-500 text-white py-3.5 rounded-lg text-sm font-bold hover:bg-yellow-600 transition-colors flex items-center justify-center shadow-md hover:shadow-lg transform active:scale-95 duration-200" onClick={() => changeIssueStatus(issue.id, 'processing')}>
                                                            ì¡°ì¹˜ ì°©ìˆ˜ <ArrowRight size={16} className="ml-2" />
                                                        </button>
                                                    )}

                                                    {selectedIssueType === 'processing' && (
                                                        <button className="flex-1 bg-green-500 text-white py-3.5 rounded-lg text-sm font-bold hover:bg-green-600 transition-colors flex items-center justify-center shadow-md hover:shadow-lg transform active:scale-95 duration-200" onClick={() => changeIssueStatus(issue.id, 'done')}>
                                                            ì¡°ì¹˜ ì™„ë£Œ ìŠ¹ì¸ <CheckCircle size={16} className="ml-2" />
                                                        </button>
                                                    )}

                                                    {selectedIssueType === 'done' && (
                                                        <div className="flex-1 bg-gray-50 border border-gray-200 text-green-600 py-3.5 rounded-lg text-sm font-bold flex items-center justify-center cursor-default">
                                                            ì™„ë£Œëœ í•­ëª© <CheckCircle size={16} className="ml-2" />
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="text-center text-gray-400 py-20 flex flex-col items-center">
                                                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-300">
                                                    <AlertTriangle size={32} />
                                                </div>
                                                <p>{selectedIssueType === 'new' ? 'ì‹ ê·œ ë°œê²¬ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.' : selectedIssueType === 'processing' ? 'ì¡°ì¹˜ ì¤‘ì¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ì™„ë£Œëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {showInspectionModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={closeModal(setShowInspectionModal)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 flex justify-between items-center bg-blue-600 text-white rounded-t-xl"><h3 className="font-bold">{inspectionType} ì ê²€ ë“±ë¡</h3><button onClick={() => setShowInspectionModal(false)}><X size={24} /></button></div>
                                    <form onSubmit={handleSaveInspection} className="p-6 space-y-4">
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">í’ˆëª©ëª… / ì¥ë¹„ëª…</label><input name="item" type="text" className="w-full border rounded-lg p-2" required placeholder="ì˜ˆ: ì´ë™ì‹ í¬ë ˆì¸, ì—í­ì‹œ ë“±" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-2">ì ê²€ ê²°ê³¼</label><div className="flex gap-4"><label className="flex items-center cursor-pointer"><input type="radio" name="result" value="í•©ê²©" className="mr-2" defaultChecked /><span className="text-sm font-bold text-green-600">í•©ê²©</span></label><label className="flex items-center cursor-pointer"><input type="radio" name="result" value="ë¶ˆí•©ê²©" className="mr-2" /><span className="text-sm font-bold text-red-600">ë¶ˆí•©ê²©</span></label></div></div>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">ì„¸ë¶€ ì ê²€ ë‚´ìš©</label><textarea className="w-full border rounded-lg p-2 h-20" placeholder="íŠ¹ì´ì‚¬í•­ ë° ì ê²€ ê²°ê³¼ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea></div>

                                        {/* [ìˆ˜ì •ë¨] ì ê²€ ì‚¬ì§„ ì²¨ë¶€ UI - ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì› */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">ì ê²€ ì‚¬ì§„ / ì„œë¥˜ ì²¨ë¶€</label>

                                            {/* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ (ê·¸ë¦¬ë“œ í˜•íƒœ) */}
                                            <div className="flex flex-wrap gap-2 mb-2">
                                                {inspectionImages.map((img, idx) => (
                                                    <div key={idx} className="relative w-20 h-20 border rounded-lg overflow-hidden group bg-gray-50 flex items-center justify-center cursor-pointer" onClick={() => setPreviewFile(typeof img === 'string' ? { url: img, name: 'ì´ë¯¸ì§€' } : img)}>
                                                        {typeof img === 'string' ? (
                                                            <img src={img} className="w-full h-full object-cover" />
                                                        ) : img.type === 'pdf' ? (
                                                            <div className="flex flex-col items-center justify-center text-center p-1">
                                                                <span className="text-2xl">ğŸ“„</span>
                                                                <span className="text-[10px] text-gray-500 truncate w-16 leading-tight mt-1">{img.name}</span>
                                                            </div>
                                                        ) : (
                                                            <img src={img.url} className="w-full h-full object-cover" />
                                                        )}
                                                        <div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center pointer-events-none">
                                                            <span className="text-xs text-white bg-black/50 px-1 rounded">ë³´ê¸°</span>
                                                        </div>
                                                        <button
                                                            type="button"
                                                            onClick={(e) => { e.stopPropagation(); handleRemoveInspectionImage(idx); }}
                                                            className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-auto"
                                                        >
                                                            <X size={12} />
                                                        </button>
                                                    </div>
                                                ))}
                                                {/* ì—…ë¡œë“œ ë²„íŠ¼ (ì¶”ê°€) */}
                                                <label className="flex flex-col items-center justify-center w-20 h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                                    <Plus className="w-6 h-6 text-gray-400" />
                                                    <input type="file" multiple className="hidden" accept="image/*, .pdf" onChange={handleInspectionImageUpload} />
                                                </label>
                                            </div>
                                            <p className="text-xs text-gray-400">* ì‚¬ì§„ ë˜ëŠ” PDF ë¬¸ì„œë¥¼ ì—¬ëŸ¬ ê°œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                        </div>

                                        <button type="submit" className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700">ì €ì¥ í•˜ê¸°</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {selectedNotice && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={closeModal(() => setSelectedNotice(null))}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 flex justify-between items-center bg-purple-600 text-white rounded-t-xl"><h3 className="font-bold">ê³µì§€ì‚¬í•­ ìƒì„¸</h3><button onClick={() => setSelectedNotice(null)}><X size={24} /></button></div>
                                    <div className="p-6">
                                        <div className="flex items-center gap-2 mb-4"><span className={`text-xs font-bold px-2 py-1 rounded ${selectedNotice.type === 'ê³µì§€' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>{selectedNotice.type}</span><span className="text-sm text-gray-500">{selectedNotice.date} | {selectedNotice.author}</span></div>
                                        <h4 className="text-xl font-bold text-gray-800 mb-4">{selectedNotice.title}</h4>
                                        <div className="bg-gray-50 p-4 rounded-lg text-gray-700 text-sm min-h-[150px] whitespace-pre-wrap leading-relaxed">{selectedNotice.content}</div>

                                        {/* [NEW] ì²¨ë¶€íŒŒì¼ í‘œì‹œ */}
                                        {selectedNotice.attachment && (
                                            <div className="mt-4 border-t pt-4">
                                                <p className="text-sm font-bold text-gray-700 mb-2">ì²¨ë¶€íŒŒì¼</p>
                                                {selectedNotice.attachment.type === 'image' ? (
                                                    <img src={selectedNotice.attachment.url} className="max-w-full rounded-lg border" />
                                                ) : (
                                                    <a href={selectedNotice.attachment.url} target="_blank" className="flex items-center p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition text-blue-600 font-bold">
                                                        <span className="mr-2">ğŸ“„</span> {selectedNotice.attachment.name || "PDF ë¬¸ì„œ ë³´ê¸°"}
                                                    </a>
                                                )}
                                            </div>
                                        )}

                                        <button onClick={() => setSelectedNotice(null)} className="w-full mt-4 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-300 transition">ë‹«ê¸°</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* [NEW] ê³µì§€ì‚¬í•­ ì‘ì„± ëª¨ë‹¬ */}
                        {showNoticeWriteModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={closeModal(setShowNoticeWriteModal)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 flex justify-between items-center bg-purple-600 text-white rounded-t-xl"><h3 className="font-bold">ìƒˆ ê³µì§€ì‚¬í•­ ë“±ë¡</h3><button onClick={() => setShowNoticeWriteModal(false)}><X size={24} /></button></div>
                                    <form onSubmit={handleSaveNotice} className="p-6 space-y-4">
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ì œëª©</label><input name="title" type="text" className="w-full border rounded-lg p-2" placeholder="ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ë‚´ìš©</label><textarea name="content" className="w-full border rounded-lg p-2 h-32 resize-none" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)"></textarea></div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ì²¨ë¶€íŒŒì¼ (ì‚¬ì§„ ë˜ëŠ” PDF)</label>
                                            <input type="file" accept="image/*, .pdf" onChange={(e) => setNoticeFile(e.target.files[0])} className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" />
                                        </div>
                                        <button type="submit" className="w-full bg-purple-600 text-white py-2.5 rounded-lg font-bold hover:bg-purple-700">ë“±ë¡í•˜ê¸°</button>
                                    </form>
                                </div>
                            </div>
                        )}
                        {/* [NEW] íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (Lightbox) */}
                        {previewFile && (
                            <div className="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 animate-fade-in" onClick={() => setPreviewFile(null)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col relative" onClick={e => e.stopPropagation()}>
                                    <div className="p-3 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                        <h3 className="font-bold text-gray-800 truncate px-2">{previewFile.name || 'ë¯¸ë¦¬ë³´ê¸°'}</h3>
                                        <div className="flex gap-2">
                                            <a href={previewFile.url} target="_blank" download className="p-2 hover:bg-gray-200 rounded text-gray-600" title="ë‹¤ìš´ë¡œë“œ/ìƒˆì°½"><Upload className="rotate-180" size={20} /></a>
                                            <button onClick={() => setPreviewFile(null)} className="p-2 hover:bg-red-100 text-gray-500 hover:text-red-500 rounded transition"><X size={24} /></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 bg-gray-900 overflow-hidden flex items-center justify-center p-1">
                                        {(previewFile.type === 'pdf' || (previewFile.url && previewFile.url.toLowerCase().includes('.pdf'))) ? (
                                            <iframe src={previewFile.url} className="w-full h-full bg-white rounded" title="PDF Preview"></iframe>
                                        ) : (
                                            <img src={previewFile.url} className="max-w-full max-h-full object-contain rounded" />
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SafetyDashboard />);
    </script>
</body>

</html>