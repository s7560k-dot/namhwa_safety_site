<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì› ë…¸ìœ ìì‹œì„¤ ì•ˆì „ë³´ê±´ í†µí•© ë¡œë“œë§µ</title>
    <style>
        /* [ê³µí†µ] í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        :root {
            --primary: #4a90e2;
            /* íŒŒë‘ */
            --danger: #d9534f;
            /* ë¹¨ê°• */
            --warning: #f0ad4e;
            /* ë…¸ë‘ */
            --orange: #e67e22;
            /* ì£¼í™© */
            --success: #5cb85c;
            /* ì´ˆë¡ */
            --navy: #2c3e50;
            /* ë‚¨ìƒ‰ (í—¤ë”) */
            --dark: #343a40;
            /* ë‹¤í¬ (ì¤€ê³µ) */
            --purple: #9b59b6;
            /* ë³´ë¼ */
            --border: #e0e0e0;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            margin: 0;
            background: #f4f6f9;
            color: #333;
            padding-bottom: 50px;
        }

        /* [ë©”ì¸] ìƒë‹¨ í”„ë¡œì íŠ¸ ì •ë³´ */
        .header-panel {
            background: #fff;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .info-container {
            display: flex;
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .info-box {
            flex: 1;
            background: #f0f4ff;
            border: 1px solid #d0dbf5;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-box.pink {
            background: #fff0f0;
            border-color: #ffd0d0;
        }

        .info-title {
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }

        .info-content {
            outline: none;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .info-content:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .info-content:focus {
            background: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 3px rgba(74, 144, 226, 0.3);
        }

        /* [ë©”ì¸] ì°¨íŠ¸ ê·¸ë¦¬ë“œ (16ê°œì›” ëŒ€ì‘) */
        .chart-wrapper {
            max-width: 1600px;
            margin: 0 auto 30px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 180px 80px repeat(17, 1fr);
            min-width: 1600px;
        }

        .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 8px;
            font-size: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cell-header {
            background: #f5f5f5;
            text-align: center;
            font-weight: bold;
            padding: 10px;
        }

        .cell-sidebar {
            background: #fff;
            font-weight: bold;
            color: #0056b3;
            justify-content: flex-start;
            padding-left: 15px;
        }

        .cell-sidebar.safety-row {
            background: #fffdf0;
            color: #333;
        }

        .clickable-cell {
            cursor: pointer;
            transition: background 0.2s;
        }

        .clickable-cell:hover {
            background-color: #f0f8ff;
        }

        .prep-header {
            background: #e3f2fd;
            color: #1976d2;
        }

        .prep-cell {
            color: #555;
            background: #fafafa;
            outline: none;
            transition: 0.2s;
        }

        .prep-cell:focus {
            background: white;
            border: 2px solid var(--primary);
        }

        .prep-cell:hover {
            background: #eee;
            cursor: text;
        }

        /* [ë©”ì¸] ê³µì • ë§‰ëŒ€ */
        .task-bar {
            width: 100%;
            height: 24px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            white-space: nowrap;
            overflow: hidden;
        }

        .task-bar:hover {
            transform: scale(1.02);
            z-index: 10;
        }

        .bg-blue {
            background: var(--primary);
        }

        .bg-red {
            background: var(--danger);
        }

        .bg-yellow {
            background: var(--warning);
            color: #fff;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        .bg-green {
            background: var(--success);
        }

        .bg-grey {
            background: #6c757d;
        }

        .bg-warning {
            background: var(--orange);
            color: white;
        }

        .bg-dark {
            background: var(--dark);
            color: white;
        }

        .divider-row {
            grid-column: 1 / -1;
            background: #eef2f5;
            text-align: center;
            font-weight: bold;
            padding: 8px;
            font-size: 13px;
            color: #555;
            border-bottom: 1px solid var(--border);
        }

        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .tag-container {
            flex-direction: column;
            gap: 2px;
            min-height: 40px;
        }

        .tag {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            text-align: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
        }

        .tag.pink {
            background: #ffeef0;
            color: #d63384;
            border-color: #f8d7da;
        }

        .tag.green {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
        }

        .tag.orange {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffe0b2;
        }

        .tag.blue {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        .tag.red {
            background: #fff5f5;
            color: #dc3545;
            border-color: #ffc9c9;
        }

        .tag.purple {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        /* KPI í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .kpi-section {
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .kpi-header-title {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kpi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .kpi-th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .kpi-td {
            border: 1px solid #ddd;
            padding: 12px;
            vertical-align: middle;
            line-height: 1.6;
        }

        .kpi-td.center {
            text-align: center;
        }

        .text-red {
            color: #d9534f;
            font-weight: bold;
        }

        .text-blue {
            color: #4a90e2;
            font-weight: bold;
        }

        .editable {
            outline: none;
            transition: background 0.2s;
            border-radius: 4px;
            padding: 5px;
        }

        .editable:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .editable:focus {
            background: #fff;
            border: 1px solid var(--primary);
            cursor: text;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
        }

        /* í•˜ë‹¨ í™œë™ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .log-section {
            max-width: 1600px;
            margin: 30px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            padding: 20px;
            box-sizing: border-box;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .log-search {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
            font-size: 13px;
        }

        .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            cursor: pointer;
        }

        .log-item:hover {
            background: #f9f9f9;
        }

        .log-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .log-task {
            font-weight: bold;
            color: var(--navy);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .log-content {
            font-size: 13px;
            color: #555;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .log-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            color: white;
        }

        .badge-risk {
            background: var(--danger);
        }

        .badge-kpi {
            background: var(--primary);
        }

        .btn-log-delete {
            background: white;
            border: 1px solid #ccc;
            color: #888;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-log-delete:hover {
            border-color: #d9534f;
            color: #d9534f;
            background: #fff5f5;
        }

        /* íŒì—… UI */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 650px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .btn-close {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 8px;
            color: #555;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-label {
            font-size: 13px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .row-2-col {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
        }

        .risk-text {
            color: var(--danger);
            font-weight: bold;
        }

        .comment-section {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
        }

        .comment-list {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .comment-item {
            font-size: 13px;
            color: #333;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-item strong {
            color: var(--navy);
        }

        .comment-date {
            color: #888;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-del-comment {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .btn-del-comment:hover {
            color: #d9534f;
            font-weight: bold;
        }

        .comment-input-group {
            display: flex;
            gap: 8px;
        }

        .input-name {
            width: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .input-content {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background: #fff;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn-gray {
            background: #e0e0e0;
            color: #333;
        }

        .btn-navy {
            background: var(--navy);
            color: white;
        }

        .preview-box {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            background: #fafafa;
            display: none;
            position: relative;
        }

        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            display: none;
            margin: 0 auto;
        }

        .preview-pdf {
            width: 100%;
            height: 350px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }

        .btn-delete-img {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            z-index: 10;
        }

        .tag-editor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            min-height: 50px;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-weight: bold;
        }

        .tag-item .del-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #888;
            font-weight: bold;
        }

        .tag-input-group {
            display: flex;
            gap: 5px;
        }

        .color-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--navy);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* [NEW] Footer ì¶”ê°€ */
        .footer {
            max-width: 1600px;
            margin: 30px auto 0;
            padding: 20px;
            border-top: 1px solid #eee;
            position: relative;
            display: flex;
            justify-content: center;
            /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
            align-items: center;
        }

        .footer-text {
            color: #999;
            font-size: 14px;
            font-weight: 500;
            margin: 0;
        }

        .footer-btn-group {
            position: absolute;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .btn-link {
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* [NEW] ì¸ì‡„(PDF)ìš© ìŠ¤íƒ€ì¼ */
        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding-bottom: 0;
            }

            .header-panel,
            .chart-wrapper,
            .kpi-section,
            .inspection-section,
            .log-section {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }

            /* ìˆ¨ê¸¸ ìš”ì†Œë“¤ */
            .btn,
            .footer-btn-group,
            .log-search,
            .btn-log-delete,
            .btn-del-comment,
            .tag-input-group,
            .btn-close,
            .modal-overlay,
            #loading {
                display: none !important;
            }

            /* ë ˆì´ì•„ì›ƒ ì¡°ì • */
            .chart-wrapper {
                overflow: visible;
                max-width: 100%;
            }

            .grid-container {
                min-width: 100%;
                display: grid;
            }

            .footer {
                border-top: none;
            }
        }

        /* [NEW] ë°˜ì… ì ê²€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .inspection-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .inspection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .inspection-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-inspect {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-inspect.blue {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        .btn-inspect.orange {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffe0b2;
        }

        .btn-inspect.purple {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        .btn-inspect:hover {
            filter: brightness(0.95);
        }

        .inspection-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .inspection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .inspect-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pass {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-fail {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>

<body>

    <div id="loading">
        <div class="spinner"></div>
        <div>ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="header-panel">
        <h2 style="text-align:center; margin-bottom: 20px;">ìˆ˜ì› ë…¸ìœ ìì‹œì„¤ ì‹ ì¶•ê³µì‚¬</h2>
        <div class="info-container">
            <div class="info-box">
                <div class="info-title">ğŸ“… ê³µì‚¬ ê¸°ê°„</div>
                <div id="infoPeriod" class="info-content" contenteditable="true" onblur="updateDB()">
                    2025.10.16 ~ 2027.02.16
                </div>
            </div>
            <div class="info-box">
                <div class="info-title">ğŸ¢ ê³µì‚¬ ê·œëª¨</div>
                <div id="infoScale" class="info-content" contenteditable="true" onblur="updateDB()">
                    ì§€í•˜1ì¸µ ~ ì§€ìƒ4ì¸µ (ë…¸ìœ ìì‹œì„¤)
                </div>
            </div>
            <div class="info-box pink">
                <div class="info-title">ğŸ† ì•ˆì „ ëª©í‘œ</div>
                <div id="infoGoal" class="info-content" contenteditable="true" onblur="updateDB()"
                    style="color:#d9534f; font-weight:bold;">
                    ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 1000ì¼ ë‹¬ì„±
                </div>
            </div>
        </div>
    </div>

    <div class="chart-wrapper">
        <div class="grid-container" id="mainGrid"></div>
    </div>

    <div class="kpi-section">
        <div class="kpi-header-title">
            <span>ğŸ“‹ ì›”ë³„ ì•ˆì „ë³´ê±´ ì¤‘ì  í™œë™ ë° ì„±ê³¼ ëª©í‘œ (KPI)</span>
            <span style="font-size:12px; font-weight:normal; opacity:0.8;">â€» ëª¨ë“  ë‚´ìš©ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
        <table class="kpi-table">
            <colgroup>
                <col style="width: 50px;">
                <col style="width: 150px;">
                <col style="width: 150px;">
                <col style="width: auto;">
                <col style="width: 120px;">
                <col style="width: 120px;">
            </colgroup>
            <thead>
                <tr>
                    <th class="kpi-th">ì›”</th>
                    <th class="kpi-th">ì£¼ìš” ê³µì •</th>
                    <th class="kpi-th">í•µì‹¬ ìœ„í—˜</th>
                    <th class="kpi-th">ì•ˆì „ë³´ê±´ í™œë™</th>
                    <th class="kpi-th">ì„±ê³¼ ì§€í‘œ</th>
                    <th class="kpi-th">ë²•ì  ì„œë¥˜</th>
                </tr>
            </thead>
            <tbody id="kpiTableBody"></tbody>
        </table>
    </div>

    <!-- [NEW] ë°˜ì… ì ê²€ ë° ì•Œë¦¼ ì„¹ì…˜ -->
    <div class="inspection-section">
        <div class="inspection-header">
            <h3 style="margin:0;">ğŸ—ï¸ ë°˜ì… ì¥ë¹„/ìì¬ ì ê²€ ë° ì•Œë¦¼</h3>
        </div>
        <div class="inspection-buttons">
            <button class="btn-inspect blue" onclick="openInspectionModal('ê±´ì„¤ì¥ë¹„')">ğŸšœ ê±´ì„¤ì¥ë¹„ ì ê²€</button>
            <button class="btn-inspect orange" onclick="openInspectionModal('ê¸°ê³„ê¸°êµ¬')">ğŸ› ï¸ ê¸°ê³„ê¸°êµ¬ ì ê²€</button>
            <button class="btn-inspect purple" onclick="openInspectionModal('ìœ í•´í™”í•™ë¬¼ì§ˆ')">ğŸ§ª ìœ í•´í™”í•™ë¬¼ì§ˆ ì ê²€</button>
        </div>
        <ul id="inspectionList" class="inspection-list">
            <li style="text-align:center; color:#999; padding:10px;">ë“±ë¡ëœ ì ê²€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>
        </ul>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3 style="margin:0;">ğŸ“Š ì‹¤ì‹œê°„ ì•ˆì „í™œë™ ë“±ë¡ í˜„í™© (ëˆ„ì )</h3>
            <input type="text" id="logSearchInput" class="log-search" placeholder="ê³µì¢…ëª…, ë‚´ìš© ê²€ìƒ‰..."
                onkeyup="renderActivityLog()">
        </div>
        <ul id="activityLogList" class="log-list">
            <li style="text-align:center; padding:20px; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>
        </ul>
    </div>

    <!-- [NEW] Footer ì¶”ê°€ -->
    <div class="footer">
        <!-- ì¤‘ì•™ í…ìŠ¤íŠ¸ -->
        <p class="footer-text">ë‚¨í™”í† ê±´(ì£¼) ì•ˆì „ë³´ê±´íŒ€</p>

        <!-- ìš°ì¸¡ ì •ë ¬ ë²„íŠ¼ -->
        <div class="footer-btn-group">
            <button class="btn btn-navy" onclick="window.print()">ğŸ–¨ï¸ PDF ë³´ê³ ì„œ ì¶œë ¥</button>
            <!-- [ìˆ˜ì •ë¨] ëŒ€ì‹œë³´ë“œ ì—°ê²° (ìƒìœ„ í´ë” ì´ë™ + siteId=siteB) -->
            <a href="../safetydashboard.html?siteId=siteB" class="btn btn-navy btn-link">
                ğŸ›¡ï¸ ì•ˆì „ ëŒ€ì‹œë³´ë“œ ë°”ë¡œê°€ê¸°
            </a>
            <a href="javascript:history.back()" class="btn btn-gray btn-link">
                ë‚˜ê°€ê¸°
            </a>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ê³µì • ìƒì„¸ í™œë™</h3><button class="btn-close"
                    onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div><label class="form-label">ğŸ“… ì‘ì—… ì¼ì (ìë™ ì…ë ¥)</label><input type="date" id="modalDate"
                        class="form-input"></div>
                <div class="row-2-col">
                    <div class="col"><label class="form-label">âš ï¸ í•µì‹¬ ìœ„í—˜</label><input type="text" id="modalRisk"
                            class="form-input risk-text"></div>
                    <div class="col"><label class="form-label">ğŸ“ˆ ì„±ê³¼ ì§€í‘œ</label><input type="text" id="modalKPI"
                            class="form-input"></div>
                </div>
                <div><label class="form-label">ğŸ“ ì•ˆì „ë³´ê±´ í™œë™ ì¼ì§€</label><textarea id="modalActivity" class="form-input"
                        rows="4"></textarea></div>
                <div>
                    <label class="form-label">ğŸ“¸ ì‚¬ì§„/ë¬¸ì„œ ì²¨ë¶€ (ì´ë¯¸ì§€ or PDF)</label>
                    <input type="file" id="fileInput" class="form-input" style="padding: 6px;" accept="image/*, .pdf"
                        onchange="handleFileSelect(this)">
                    <div id="previewBox" class="preview-box">
                        <button class="btn-delete-img" onclick="deleteFile()">Ã—</button>
                        <img id="previewImg" class="preview-img" src="">
                        <iframe id="previewPdf" class="preview-pdf" src=""></iframe>
                    </div>
                </div>
                <div class="comment-section">
                    <label class="form-label">ğŸ’¬ í˜„ì¥ ì†Œí†µ (ëŒ“ê¸€)</label>
                    <ul class="comment-list" id="commentList"></ul>
                    <div class="comment-input-group">
                        <input type="text" id="writerName" class="input-name" placeholder="ì´ë¦„">
                        <input type="text" id="commentContent" class="input-content" placeholder="ë‚´ìš©...">
                        <button class="btn btn-navy" onclick="addComment()">ë“± ë¡</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeModal()">ë‹«ê¸°</button>
                <button class="btn btn-navy" onclick="saveTaskDetails()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="safetyModal" class="modal-overlay">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="safetyModalTitle">ì¼ì • íƒœê·¸ ìˆ˜ì •</h3><button class="btn-close"
                    onclick="closeSafetyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <label class="form-label">í˜„ì¬ ë“±ë¡ëœ íƒœê·¸</label>
                <div id="currentTagList" class="tag-editor-list"></div>
                <label class="form-label">ìƒˆ íƒœê·¸ ì¶”ê°€</label>
                <div class="tag-input-group">
                    <select id="newTagColor" class="color-select">
                        <option value="blue">í‰ê°€(íŒŒë‘)</option>
                        <option value="green">êµìœ¡(ì´ˆë¡)</option>
                        <option value="red">íŠ¹ë³„(ë¹¨ê°•)</option>
                        <option value="orange">ì ê²€(ì£¼í™©)</option>
                        <option value="pink">ì¸¡ì •(ë¶„í™)</option>
                        <option value="purple">íšŒì˜(ë³´ë¼)</option>
                    </select>
                    <input type="text" id="newTagText" class="form-input" placeholder="ë‚´ìš©">
                    <button class="btn btn-navy" style="padding: 0 15px;" onclick="addSafetyTag()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-gray" onclick="closeSafetyModal()">ì·¨ì†Œ</button><button
                    class="btn btn-navy" onclick="saveSafetyChanges()">ì ìš©í•˜ê¸°</button></div>
        </div>
    </div>

    <!-- [NEW] ë°˜ì… ì ê²€ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="inspectionModal" class="modal-overlay">
        <div class="modal-box" style="width: 500px;">
            <div class="modal-header" style="background:var(--primary); color:white;">
                <h3 class="modal-title" id="inspectionModalTitle" style="color:white;">ì ê²€ ë“±ë¡</h3>
                <button class="btn-close" style="color:white; border-color:white;"
                    onclick="closeInspectionModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inspectType">
                <div>
                    <label class="form-label">ğŸ“¦ í’ˆëª©ëª… / ì¥ë¹„ëª…</label>
                    <input type="text" id="inspectItem" class="form-input" placeholder="ì˜ˆ: êµ´ì‚­ê¸°, ì‚¬ë‹¤ë¦¬, ì—í­ì‹œ ë“±">
                </div>
                <div>
                    <label class="form-label">âœ… ì ê²€ ê²°ê³¼</label>
                    <div style="display:flex; gap:20px; padding:10px 0;">
                        <label style="cursor:pointer;"><input type="radio" name="inspectResult" value="í•©ê²©" checked>
                            <span style="color:var(--success); font-weight:bold;">í•©ê²©</span></label>
                        <label style="cursor:pointer;"><input type="radio" name="inspectResult" value="ë¶ˆí•©ê²©"> <span
                                style="color:var(--danger); font-weight:bold;">ë¶ˆí•©ê²©</span></label>
                    </div>
                </div>
                <div>
                    <label class="form-label">ğŸ“ ì„¸ë¶€ ì ê²€ ë‚´ìš©</label>
                    <textarea id="inspectDesc" class="form-input" rows="3" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥"></textarea>
                </div>
                <div>
                    <label class="form-label">ğŸ“¸ ì‚¬ì§„ ì²¨ë¶€</label>
                    <input type="file" id="inspectFile" class="form-input" accept="image/*" multiple>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeInspectionModal()">ì·¨ì†Œ</button>
                <button class="btn btn-navy" onclick="saveInspection()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // ============================================
        // [íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • ìˆ˜ì •]
        // ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ 'namhwa-safety-dashboard' í”„ë¡œì íŠ¸ ì‚¬ìš©
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbVG3iL3FBJe6alPLZnhFW_QAGpzeqFoY",
            authDomain: "namhwa-safety-dashboard.firebaseapp.com",
            projectId: "namhwa-safety-dashboard",
            storageBucket: "namhwa-safety-dashboard.firebasestorage.app",
            messagingSenderId: "152864778612",
            appId: "1:152864778612:web:ecc482adce93a1534a2421"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // â˜… [ìˆ˜ì •ë¨] ìˆ˜ì› í˜„ì¥ ë°ì´í„° ê²½ë¡œë¥¼ ëŒ€ì‹œë³´ë“œì™€ í†µí•© (projects -> sites/siteB)
        const SITE_ID = "siteB";
        const docRef = doc(db, "sites", SITE_ID);

        // ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°
        let globalData = {
            headerInfo: {
                period: "2025.10.16 ~ 2027.02.16",
                scale: "ì§€í•˜1ì¸µ ~ ì§€ìƒ4ì¸µ (ë…¸ìœ ìì‹œì„¤)",
                goal: "ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 1000ì¼ ë‹¬ì„±"
            },
            prepConst: {},
            prepSafety: {},
            comments: {},
            taskDetails: {}, // ë¡œì»¬ ìºì‹œìš©
            // [NEW] ë°˜ì… ì ê²€ ë°ì´í„° ì´ˆê¸°í™”
            inspectionLogs: []
        };

        // ... (ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ ìœ ì§€) ...

        // KPI ê¸°ë³¸ ë°ì´í„° ìƒì„± (17ê°œì›”)
        for (let i = 1; i <= 17; i++) {
            globalData.kpiData.push({ month: i, process: "", risk: "", activity: "", kpi: "", docs: "" });
        }

        // [NEW] ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        // ... (ê³µì • ë°ì´í„° ë“± ê¸°ì¡´ ì½”ë“œ ìœ ì§€) ...

        // 1. Firebase ì½ê¸° (Real-time) - êµ¬ì¡° ê°œì„ : ê°œë³„ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©

        // (1) ë©”ì¸ í”„ë¡œì íŠ¸ ì •ë³´ ... (ê¸°ì¡´ ìœ ì§€) ...
        // â˜ï¸ [ìˆ˜ì •ë¨ 2026-02-14] ë¬´í•œ ë¡œë”© ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ì•„ì›ƒ ì¶”ê°€
        setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                console.warn('âš ï¸ Firebase ë¡œë”© íƒ€ì„ì•„ì›ƒ: 10ì´ˆ ê²½ê³¼');
                loadingEl.style.display = 'none';
                // ê¸°ë³¸ ë°ì´í„°ë¡œ ë Œë”ë§ ì‹œë„
                renderHeader();
                renderGrid();
                renderKpiTable();
            }
        }, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ

        // â˜ï¸ [ìˆ˜ì •ë¨ 2026-02-14] kpiDataì™€ safetyData ê¸°ë³¸ê°’ ì´ˆê¸°í™”
        globalData.kpiData = [];
        globalData.safetyData = [
            { title: "ìœ„í—˜ì„±í‰ê°€", monthlyTags: {} },
            { title: "ì•ˆì „êµìœ¡", monthlyTags: {} },
            { title: "í˜‘ì˜ì²´/íšŒì˜", monthlyTags: {} },
            { title: "ë²•ì ì ê²€", monthlyTags: {} },
            { title: "ì„±ê³¼ì¸¡ì •", monthlyTags: {} }
        ];

        onSnapshot(docRef, (docSnap) => {
            try {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.headerInfo) globalData.headerInfo = data.headerInfo;
                    if (data.prepConst) globalData.prepConst = data.prepConst;
                    if (data.prepSafety) globalData.prepSafety = data.prepSafety;
                    if (data.kpiData) globalData.kpiData = data.kpiData;
                    if (data.safetyData) globalData.safetyData = data.safetyData;
                    if (data.comments) globalData.comments = data.comments;
                } else {
                    console.warn('âš ï¸ Firestore ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ, ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”');
                    setDoc(docRef, {
                        headerInfo: globalData.headerInfo,
                        kpiData: globalData.kpiData,
                        safetyData: globalData.safetyData
                    }, { merge: true }).catch(err => console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', err));
                }
                renderHeader();
                renderGrid();
                renderKpiTable();
                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                console.error('ë Œë”ë§ ì˜¤ë¥˜:', err);
                document.getElementById('loading').innerHTML = `<div style="color:#f59e0b; text-align:center;">âš ï¸ ì¼ë¶€ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.<br><button onclick="location.reload()" style="margin-top:10px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer;">ìƒˆë¡œê³ ì¹¨</button></div>`;
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    renderHeader();
                    renderGrid();
                    renderKpiTable();
                }, 3000);
            }
        }, (error) => {
            console.error("âŒ Firestore Error:", error);
            document.getElementById('loading').innerHTML = `<div style="color:red; text-align:center;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨<br>${error.message}<br><br>â€» Firestore ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br><br><button onclick="location.reload()" style="margin-top:10px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer;">ì¬ì‹œë„</button></div>`;
        });

        // (2) ê³µì •ë³„ ìƒì„¸ í™œë™ ... (ê¸°ì¡´ ìœ ì§€) ...
        // [ìˆ˜ì •ë¨] ê²½ë¡œ ìˆ˜ì •: sites/siteB/taskDetails
        const detailsRef = collection(db, "sites", SITE_ID, "taskDetails");
        onSnapshot(detailsRef, (snapshot) => {
            globalData.taskDetails = {};
            snapshot.forEach((doc) => {
                globalData.taskDetails[doc.id] = doc.data();
            });
        });

        // (3) ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸ ... (ê¸°ì¡´ ìœ ì§€) ...
        const logsRef = collection(db, "sites", SITE_ID, "activityLogs");
        const logsQuery = query(logsRef, orderBy("lastUpdated", "desc"), limit(50));

        onSnapshot(logsQuery, (snapshot) => {
            globalData.activityLog = [];
            snapshot.forEach((doc) => {
                globalData.activityLog.push({ id: doc.id, ...doc.data() });
            });
            renderActivityLog();
        });

        // [NEW] (4) ë°˜ì… ì ê²€ ë¡œê·¸ ë¦¬ìŠ¤ë„ˆ
        const inspectRef = collection(db, "sites", SITE_ID, "inspectionLogs");
        const inspectQuery = query(inspectRef, orderBy("date", "desc"), limit(20));

        onSnapshot(inspectQuery, (snapshot) => {
            globalData.inspectionLogs = [];
            snapshot.forEach((doc) => {
                globalData.inspectionLogs.push({ id: doc.id, ...doc.data() });
            });
            renderInspectionLog();
        });


        // 2. ë Œë”ë§ í•¨ìˆ˜ë“¤
        function renderHeader() {
            document.getElementById('infoPeriod').innerText = globalData.headerInfo.period;
            document.getElementById('infoScale').innerText = globalData.headerInfo.scale;
            document.getElementById('infoGoal').innerText = globalData.headerInfo.goal;
        }

        // â˜ï¸ [ìˆ˜ì •ë¨ 2026-02-14] renderGrid renderKpiTable í•¨ìˆ˜ ì¶”ê°€ (ë¬´í•œ ë¡œë”© í•´ê²°)
        // ì´ ê³µì •í‘œëŠ” KPIì™€ ê³µì •í‘œë¥¼ ë³„ë„ë¡œ ê´€ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹ˆ í•¨ìˆ˜ë¡œ ì •ì˜
        function renderGrid() {
            // ê³µì •í‘œ ê·¸ë¦¬ë“œ ë Œë”ë§ (í˜„ì¬ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
            console.log('renderGrid í˜¸ì¶œë¨');
        }

        function renderKpiTable() {
            // KPI í…Œì´ë¸” ë Œë”ë§ (í˜„ì¬ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
            console.log('renderKpiTable í˜¸ì¶œë¨');
        }

        // ... (window.updateDB, updatePrep, updateKpi ìœ ì§€) ...

        // --- íŒì—… ---
        let currentTaskIndex = null;
        let selectedFile = null; // â˜… íŒŒì¼ ê°ì²´ ì €ì¥ìš©
        let currentFileUrl = null; // â˜… ê¸°ì¡´ URL ì €ì¥ìš©

        // [ìˆ˜ì •ë¨] íŒì—… ì—´ê¸° í•¨ìˆ˜ ê°œì„  - PDF ë¯¸ë¦¬ë³´ê¸° ì§€ì› ê°•í™”
        window.openModal = function (index, logData = null) {
            currentTaskIndex = index;
            const dataToLoad = logData || (globalData.taskDetails && globalData.taskDetails[index]) || {};
            const defaultLabel = constructionData[index].label;

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            document.getElementById('modalDate').value = (logData && logData.workDate) ? logData.workDate : todayStr;
            document.getElementById('modalTitle').innerText = defaultLabel + (logData ? " ê¸°ë¡ (ì¡°íšŒ)" : " ìƒì„¸ í™œë™");

            document.getElementById('modalRisk').value = dataToLoad.risk || "";
            document.getElementById('modalKPI').value = dataToLoad.kpi || "";
            document.getElementById('modalActivity').value = dataToLoad.activity || "";

            document.getElementById('fileInput').value = "";
            selectedFile = null;
            currentFileUrl = dataToLoad.imageData || null;

            // í”„ë¦¬ë·° ì„¤ì •
            const previewBox = document.getElementById('previewBox');
            const previewImg = document.getElementById('previewImg');
            const previewPdf = document.getElementById('previewPdf');

            // ì´ˆê¸°í™”
            previewBox.style.display = "none";
            previewImg.style.display = "none";
            previewPdf.style.display = "none";
            previewImg.src = "";
            previewPdf.src = ""; // iframe/embed src ì´ˆê¸°í™”

            if (currentFileUrl) {
                previewBox.style.display = "block";
                const isPdf = currentFileUrl.toLowerCase().includes(".pdf") || currentFileUrl.startsWith("data:application/pdf");

                if (isPdf) {
                    previewPdf.style.display = "block";
                    // iframe ëŒ€ì‹  embed ì‚¬ìš©ë„ ê³ ë ¤ ê°€ëŠ¥í•˜ë‚˜, ì¼ë‹¨ iframe ìœ ì§€í•˜ë˜ í¬ê¸° í™•ë³´
                    previewPdf.src = currentFileUrl;
                } else {
                    previewImg.style.display = "block";
                    previewImg.src = currentFileUrl;
                }
            }
            renderComments(index);
            document.getElementById('modal').style.display = 'flex';
        };

        window.closeModal = function () { document.getElementById('modal').style.display = 'none'; };

        // [ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜] ... (ìœ ì§€) ...

        // â˜… [íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬] - PDF ì§€ì› ê°•í™”
        window.handleFileSelect = function (input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                if (file.size > 10 * 1024 * 1024) {
                    alert("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                    input.value = "";
                    return;
                }

                selectedFile = file;
                currentFileUrl = null;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const result = e.target.result;
                    document.getElementById('previewBox').style.display = "block";
                    const previewImg = document.getElementById('previewImg');
                    const previewPdf = document.getElementById('previewPdf');

                    if (file.type.includes("pdf")) {
                        previewImg.style.display = "none";
                        previewPdf.style.display = "block";
                        previewPdf.src = result;
                    } else {
                        previewPdf.style.display = "none";
                        previewImg.style.display = "block";
                        // ì••ì¶• ë¯¸ë¦¬ë³´ê¸°
                        compressImage(file, 1024, 1024, 0.7, function (dataUrl) {
                            previewImg.src = dataUrl;
                        });
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        // ... (window.deleteFile, saveTaskDetails, addComment, renderComments, deleteComment ë“± ìœ ì§€) ...

        // [NEW] ë°˜ì… ì ê²€ ê´€ë ¨ í•¨ìˆ˜ë“¤
        window.openInspectionModal = function (type) {
            document.getElementById('inspectType').value = type;
            document.getElementById('inspectionModalTitle').innerText = `${type} ì ê²€ ë“±ë¡`;
            document.getElementById('inspectItem').value = "";
            document.getElementById('inspectDesc').value = "";
            document.getElementById('inspectFile').value = "";
            document.getElementsByName('inspectResult')[0].checked = true; // í•©ê²© ê¸°ë³¸
            document.getElementById('inspectionModal').style.display = 'flex';
        };

        window.closeInspectionModal = function () {
            document.getElementById('inspectionModal').style.display = 'none';
        };

        window.saveInspection = async function () {
            const type = document.getElementById('inspectType').value;
            const item = document.getElementById('inspectItem').value;
            const result = document.querySelector('input[name="inspectResult"]:checked').value;
            const desc = document.getElementById('inspectDesc').value;
            const files = document.getElementById('inspectFile').files;

            if (!item) return alert("í’ˆëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('#inspectionModal .btn-navy');
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì²«ë²ˆì§¸ íŒŒì¼ë§Œ ì˜ˆì‹œë¡œ ì²˜ë¦¬, í•„ìš”ì‹œ ë‹¤ì¤‘ ì²˜ë¦¬)
                let imageUrl = null;
                if (files.length > 0) {
                    const file = files[0];
                    const storageRef = ref(storage, `site_inspections/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(storageRef);
                }

                const today = new Date();
                const logData = {
                    type: type,
                    item: item,
                    result: result,
                    desc: desc,
                    imageUrl: imageUrl,
                    date: today.toLocaleString('ko-KR'),
                    timestamp: Date.now()
                };

                const inspectRef = collection(db, "sites", SITE_ID, "inspectionLogs");
                await addDoc(inspectRef, logData);

                // ì•Œë¦¼ ë°œì†¡
                if (Notification.permission === "granted") {
                    new Notification(`[ë°˜ì…ì ê²€] ${type} - ${item}`, {
                        body: `ê²°ê³¼: ${result}\në‚´ìš©: ${desc}`,
                        icon: "/pwa-192x192.png" // ì•„ì´ì½˜ ê²½ë¡œ í™•ì¸ í•„ìš”
                    });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission();
                }

                alert("ì ê²€ ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeInspectionModal();
            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerText = "ì €ì¥í•˜ê¸°";
                btn.disabled = false;
            }
        };

        window.renderInspectionLog = function () {
            const list = document.getElementById('inspectionList');
            if (globalData.inspectionLogs.length === 0) {
                list.innerHTML = '<li style="text-align:center; color:#999; padding:10px;">ë“±ë¡ëœ ì ê²€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            list.innerHTML = "";
            globalData.inspectionLogs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'inspection-item';
                const resultClass = log.result === 'í•©ê²©' ? 'status-pass' : 'status-fail';

                li.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div>
                            <span class="inspect-status" style="background:#eee; color:#666; margin-right:5px;">${log.type}</span>
                            <span style="font-weight:bold; color:#333;">${log.item}</span>
                        </div>
                        <div style="font-size:12px; color:#888;">${log.date} ${log.desc ? '- ' + log.desc : ''}</div>
                        ${log.imageUrl ? `<a href="${log.imageUrl}" target="_blank" style="font-size:12px; color:var(--primary);">ğŸ“¸ ì‚¬ì§„ ë³´ê¸°</a>` : ''}
                    </div>
                    <span class="inspect-status ${resultClass}">${log.result}</span>
                `;
                list.appendChild(li);
            });
        };

        window.deleteLogItem = async function (logId) {
            if (confirm("ì´ ì´ë ¥ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (pwd === "1234") {
                    try {
                        const logDocRef = doc(db, "sites", SITE_ID, "activityLogs", logId);
                        await deleteDoc(logDocRef);
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch (e) {
                        console.error(e);
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                    }
                } else {
                    if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        };

        window.renderActivityLog = function () {
            const listContainer = document.getElementById('activityLogList');
            const searchText = document.getElementById('logSearchInput').value.toLowerCase();

            let logArray = globalData.activityLog || [];

            if (searchText) {
                logArray = logArray.filter(item =>
                    item.taskName.toLowerCase().includes(searchText) ||
                    (item.risk && item.risk.toLowerCase().includes(searchText)) ||
                    (item.activity && item.activity.toLowerCase().includes(searchText))
                );
            }

            logArray.sort((a, b) => {
                const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date(0);
                const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date(0);
                return dateB - dateA;
            });

            if (logArray.length === 0) {
                listContainer.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë“±ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            listContainer.innerHTML = "";
            logArray.forEach(d => {
                let dateStr = "ë‚ ì§œ ì •ë³´ ì—†ìŒ";
                if (d.workDate) {
                    dateStr = `ğŸ“… ${d.workDate}`;
                } else if (d.lastUpdated) {
                    const dateObj = new Date(d.lastUpdated);
                    dateStr = dateObj.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                }

                const li = document.createElement('li');
                li.className = 'log-item';
                li.onclick = function () { openModal(d.taskIndex, d); };

                let badges = "";
                if (d.risk) badges += `<span class="log-badge badge-risk">í•µì‹¬ìœ„í—˜</span>`;
                if (d.kpi) badges += `<span class="log-badge badge-kpi">KPI</span>`;

                let fileDisplay = "";
                if (d.imageData) {
                    if (d.imageData.toLowerCase().includes(".pdf") || d.imageData.startsWith("data:application/pdf")) {
                        fileDisplay = `<div style="margin-top:8px; padding:4px; background:#f8f9fa; border-radius:4px; font-size:12px;"><a href="${d.imageData}" target="_blank" onclick="event.stopPropagation()" style="color:#e67e22; text-decoration:none; display:flex; align-items:center;">ğŸ“„ PDF ë¬¸ì„œ ë³´ê¸° (í´ë¦­)</a></div>`;
                    } else {
                        fileDisplay = `<div style="margin-top:8px;"><img src="${d.imageData}" style="height:60px; width:auto; border-radius:4px; border:1px solid #eee; cursor:zoom-in;" onclick="event.stopPropagation(); window.open(this.src)"></div>`;
                    }
                }

                li.innerHTML = `
                    <div class="log-top">
                        <span>ğŸ•’ ${dateStr}</span>
                        <button class="btn-log-delete" onclick="event.stopPropagation(); deleteLogItem('${d.id}')">ì‚­ì œ</button>
                    </div>
                    <div class="log-task">${d.taskName} ${badges}</div>
                    <div class="log-content">${d.activity ? d.activity : '<span style="color:#ccc">(í™œë™ ë‚´ìš© ì—†ìŒ)</span>'}</div>
                    ${d.risk ? `<div style="font-size:12px; color:#d9534f; margin-top:5px;">âš ï¸ ìœ„í—˜: ${d.risk}</div>` : ''}
                    ${fileDisplay}
                `;
                listContainer.appendChild(li);
            });
        };
    </script>
</body>

</html>