<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì› ë…¸ìœ ìì‹œì„¤ ì•ˆì „ë³´ê±´ í†µí•© ë¡œë“œë§µ</title>
    <style>
        /* [ê³µí†µ] í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        :root {
            --primary: #4a90e2;
            /* íŒŒë‘ */
            --danger: #d9534f;
            /* ë¹¨ê°• */
            --warning: #f0ad4e;
            /* ë…¸ë‘ */
            --orange: #e67e22;
            /* ì£¼í™© */
            --success: #5cb85c;
            /* ì´ˆë¡ */
            --navy: #2c3e50;
            /* ë‚¨ìƒ‰ (í—¤ë”) */
            --dark: #343a40;
            /* ë‹¤í¬ (ì¤€ê³µ) */
            --purple: #9b59b6;
            /* ë³´ë¼ */
            --border: #e0e0e0;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            margin: 0;
            background: #f4f6f9;
            color: #333;
            padding-bottom: 50px;
        }

        /* [ë©”ì¸] ìƒë‹¨ í”„ë¡œì íŠ¸ ì •ë³´ */
        .header-panel {
            background: #fff;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .info-container {
            display: flex;
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .info-box {
            flex: 1;
            background: #f0f4ff;
            border: 1px solid #d0dbf5;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-box.pink {
            background: #fff0f0;
            border-color: #ffd0d0;
        }

        .info-title {
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }

        .info-content {
            outline: none;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .info-content:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .info-content:focus {
            background: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 3px rgba(74, 144, 226, 0.3);
        }

        /* [ë©”ì¸] ì°¨íŠ¸ ê·¸ë¦¬ë“œ (16ê°œì›” ëŒ€ì‘) */
        .chart-wrapper {
            max-width: 1600px;
            margin: 0 auto 30px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 180px 80px repeat(17, 1fr);
            min-width: 1600px;
        }

        .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 8px;
            font-size: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cell-header {
            background: #f5f5f5;
            text-align: center;
            font-weight: bold;
            padding: 10px;
        }

        .cell-sidebar {
            background: #fff;
            font-weight: bold;
            color: #0056b3;
            justify-content: flex-start;
            padding-left: 15px;
        }

        .cell-sidebar.safety-row {
            background: #fffdf0;
            color: #333;
        }

        .clickable-cell {
            cursor: pointer;
            transition: background 0.2s;
        }

        .clickable-cell:hover {
            background-color: #f0f8ff;
        }

        .prep-header {
            background: #e3f2fd;
            color: #1976d2;
        }

        .prep-cell {
            color: #555;
            background: #fafafa;
            outline: none;
            transition: 0.2s;
        }

        .prep-cell:focus {
            background: white;
            border: 2px solid var(--primary);
        }

        .prep-cell:hover {
            background: #eee;
            cursor: text;
        }

        /* [ë©”ì¸] ê³µì • ë§‰ëŒ€ */
        .task-bar {
            width: 100%;
            height: 24px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            white-space: nowrap;
            overflow: hidden;
        }

        .task-bar:hover {
            transform: scale(1.02);
            z-index: 10;
        }

        .bg-blue {
            background: var(--primary);
        }

        .bg-red {
            background: var(--danger);
        }

        .bg-yellow {
            background: var(--warning);
            color: #fff;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        .bg-green {
            background: var(--success);
        }

        .bg-grey {
            background: #6c757d;
        }

        .bg-warning {
            background: var(--orange);
            color: white;
        }

        .bg-dark {
            background: var(--dark);
            color: white;
        }

        .divider-row {
            grid-column: 1 / -1;
            background: #eef2f5;
            text-align: center;
            font-weight: bold;
            padding: 8px;
            font-size: 13px;
            color: #555;
            border-bottom: 1px solid var(--border);
        }

        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .tag-container {
            flex-direction: column;
            gap: 2px;
            min-height: 40px;
        }

        .tag {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            text-align: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
        }

        .tag.pink {
            background: #ffeef0;
            color: #d63384;
            border-color: #f8d7da;
        }

        .tag.green {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
        }

        .tag.orange {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffe0b2;
        }

        .tag.blue {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        .tag.red {
            background: #fff5f5;
            color: #dc3545;
            border-color: #ffc9c9;
        }

        .tag.purple {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        /* KPI í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .kpi-section {
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .kpi-header-title {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kpi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .kpi-th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .kpi-td {
            border: 1px solid #ddd;
            padding: 12px;
            vertical-align: middle;
            line-height: 1.6;
        }

        .kpi-td.center {
            text-align: center;
        }

        .text-red {
            color: #d9534f;
            font-weight: bold;
        }

        .text-blue {
            color: #4a90e2;
            font-weight: bold;
        }

        .editable {
            outline: none;
            transition: background 0.2s;
            border-radius: 4px;
            padding: 5px;
        }

        .editable:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .editable:focus {
            background: #fff;
            border: 1px solid var(--primary);
            cursor: text;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
        }

        /* í•˜ë‹¨ í™œë™ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .log-section {
            max-width: 1600px;
            margin: 30px auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            padding: 20px;
            box-sizing: border-box;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .log-search {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
            font-size: 13px;
        }

        .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            cursor: pointer;
        }

        .log-item:hover {
            background: #f9f9f9;
        }

        .log-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .log-task {
            font-weight: bold;
            color: var(--navy);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .log-content {
            font-size: 13px;
            color: #555;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .log-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            color: white;
        }

        .badge-risk {
            background: var(--danger);
        }

        .badge-kpi {
            background: var(--primary);
        }

        .btn-log-delete {
            background: white;
            border: 1px solid #ccc;
            color: #888;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-log-delete:hover {
            border-color: #d9534f;
            color: #d9534f;
            background: #fff5f5;
        }

        /* íŒì—… UI */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 650px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .btn-close {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 8px;
            color: #555;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-label {
            font-size: 13px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .row-2-col {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
        }

        .risk-text {
            color: var(--danger);
            font-weight: bold;
        }

        .comment-section {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
        }

        .comment-list {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .comment-item {
            font-size: 13px;
            color: #333;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-item strong {
            color: var(--navy);
        }

        .comment-date {
            color: #888;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-del-comment {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .btn-del-comment:hover {
            color: #d9534f;
            font-weight: bold;
        }

        .comment-input-group {
            display: flex;
            gap: 8px;
        }

        .input-name {
            width: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .input-content {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background: #fff;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn-gray {
            background: #e0e0e0;
            color: #333;
        }

        .btn-navy {
            background: var(--navy);
            color: white;
        }

        .preview-box {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            background: #fafafa;
            display: none;
            position: relative;
        }

        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            display: none;
            margin: 0 auto;
        }

        .preview-pdf {
            width: 100%;
            height: 350px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }

        .btn-delete-img {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            z-index: 10;
        }

        .tag-editor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            min-height: 50px;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-weight: bold;
        }

        .tag-item .del-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #888;
            font-weight: bold;
        }

        .tag-input-group {
            display: flex;
            gap: 5px;
        }

        .color-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--navy);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* [NEW] Footer ì¶”ê°€ */
        .footer {
            max-width: 1600px;
            margin: 30px auto 0;
            padding: 20px;
            border-top: 1px solid #eee;
            position: relative;
            display: flex;
            justify-content: center;
            /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
            align-items: center;
        }

        .footer-text {
            color: #999;
            font-size: 14px;
            font-weight: 500;
            margin: 0;
        }

        .footer-btn-group {
            position: absolute;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .btn-link {
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <div id="loading">
        <div class="spinner"></div>
        <div>ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="header-panel">
        <h2 style="text-align:center; margin-bottom: 20px;">ìˆ˜ì› ë…¸ìœ ìì‹œì„¤ ì‹ ì¶•ê³µì‚¬</h2>
        <div class="info-container">
            <div class="info-box">
                <div class="info-title">ğŸ“… ê³µì‚¬ ê¸°ê°„</div>
                <div id="infoPeriod" class="info-content" contenteditable="true" onblur="updateDB()">
                    2025.10.16 ~ 2027.02.16
                </div>
            </div>
            <div class="info-box">
                <div class="info-title">ğŸ¢ ê³µì‚¬ ê·œëª¨</div>
                <div id="infoScale" class="info-content" contenteditable="true" onblur="updateDB()">
                    ì§€í•˜1ì¸µ ~ ì§€ìƒ4ì¸µ (ë…¸ìœ ìì‹œì„¤)
                </div>
            </div>
            <div class="info-box pink">
                <div class="info-title">ğŸ† ì•ˆì „ ëª©í‘œ</div>
                <div id="infoGoal" class="info-content" contenteditable="true" onblur="updateDB()"
                    style="color:#d9534f; font-weight:bold;">
                    ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 1000ì¼ ë‹¬ì„±
                </div>
            </div>
        </div>
    </div>

    <div class="chart-wrapper">
        <div class="grid-container" id="mainGrid"></div>
    </div>

    <div class="kpi-section">
        <div class="kpi-header-title">
            <span>ğŸ“‹ ì›”ë³„ ì•ˆì „ë³´ê±´ ì¤‘ì  í™œë™ ë° ì„±ê³¼ ëª©í‘œ (KPI)</span>
            <span style="font-size:12px; font-weight:normal; opacity:0.8;">â€» ëª¨ë“  ë‚´ìš©ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
        <table class="kpi-table">
            <colgroup>
                <col style="width: 50px;">
                <col style="width: 150px;">
                <col style="width: 150px;">
                <col style="width: auto;">
                <col style="width: 120px;">
                <col style="width: 120px;">
            </colgroup>
            <thead>
                <tr>
                    <th class="kpi-th">ì›”</th>
                    <th class="kpi-th">ì£¼ìš” ê³µì •</th>
                    <th class="kpi-th">í•µì‹¬ ìœ„í—˜</th>
                    <th class="kpi-th">ì•ˆì „ë³´ê±´ í™œë™</th>
                    <th class="kpi-th">ì„±ê³¼ ì§€í‘œ</th>
                    <th class="kpi-th">ë²•ì  ì„œë¥˜</th>
                </tr>
            </thead>
            <tbody id="kpiTableBody"></tbody>
        </table>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3 style="margin:0;">ğŸ“Š ì‹¤ì‹œê°„ ì•ˆì „í™œë™ ë“±ë¡ í˜„í™© (ëˆ„ì )</h3>
            <input type="text" id="logSearchInput" class="log-search" placeholder="ê³µì¢…ëª…, ë‚´ìš© ê²€ìƒ‰..."
                onkeyup="renderActivityLog()">
        </div>
        <ul id="activityLogList" class="log-list">
            <li style="text-align:center; padding:20px; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>
        </ul>
    </div>

    <!-- [NEW] Footer ì¶”ê°€ -->
    <div class="footer">
        <!-- ì¤‘ì•™ í…ìŠ¤íŠ¸ -->
        <p class="footer-text">ë‚¨í™”í† ê±´(ì£¼) ì•ˆì „ë³´ê±´íŒ€</p>

        <!-- ìš°ì¸¡ ì •ë ¬ ë²„íŠ¼ -->
        <div class="footer-btn-group">
            <!-- [ìˆ˜ì •ë¨] ëŒ€ì‹œë³´ë“œ ì—°ê²° (ìƒìœ„ í´ë” ì´ë™ + siteId=siteB) -->
            <a href="../safetydashboard.html?siteId=siteB" class="btn btn-navy btn-link">
                ğŸ›¡ï¸ ì•ˆì „ ëŒ€ì‹œë³´ë“œ ë°”ë¡œê°€ê¸°
            </a>
            <a href="javascript:history.back()" class="btn btn-gray btn-link">
                ë‚˜ê°€ê¸°
            </a>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ê³µì • ìƒì„¸ í™œë™</h3><button class="btn-close"
                    onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div><label class="form-label">ğŸ“… ì‘ì—… ì¼ì (ìë™ ì…ë ¥)</label><input type="date" id="modalDate"
                        class="form-input"></div>
                <div class="row-2-col">
                    <div class="col"><label class="form-label">âš ï¸ í•µì‹¬ ìœ„í—˜</label><input type="text" id="modalRisk"
                            class="form-input risk-text"></div>
                    <div class="col"><label class="form-label">ğŸ“ˆ ì„±ê³¼ ì§€í‘œ</label><input type="text" id="modalKPI"
                            class="form-input"></div>
                </div>
                <div><label class="form-label">ğŸ“ ì•ˆì „ë³´ê±´ í™œë™ ì¼ì§€</label><textarea id="modalActivity" class="form-input"
                        rows="4"></textarea></div>
                <div>
                    <label class="form-label">ğŸ“¸ ì‚¬ì§„/ë¬¸ì„œ ì²¨ë¶€ (ì´ë¯¸ì§€ or PDF)</label>
                    <input type="file" id="fileInput" class="form-input" style="padding: 6px;" accept="image/*, .pdf"
                        onchange="handleFileSelect(this)">
                    <div id="previewBox" class="preview-box">
                        <button class="btn-delete-img" onclick="deleteFile()">Ã—</button>
                        <img id="previewImg" class="preview-img" src="">
                        <iframe id="previewPdf" class="preview-pdf" src=""></iframe>
                    </div>
                </div>
                <div class="comment-section">
                    <label class="form-label">ğŸ’¬ í˜„ì¥ ì†Œí†µ (ëŒ“ê¸€)</label>
                    <ul class="comment-list" id="commentList"></ul>
                    <div class="comment-input-group">
                        <input type="text" id="writerName" class="input-name" placeholder="ì´ë¦„">
                        <input type="text" id="commentContent" class="input-content" placeholder="ë‚´ìš©...">
                        <button class="btn btn-navy" onclick="addComment()">ë“± ë¡</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeModal()">ë‹«ê¸°</button>
                <button class="btn btn-navy" onclick="saveTaskDetails()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="safetyModal" class="modal-overlay">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="safetyModalTitle">ì¼ì • íƒœê·¸ ìˆ˜ì •</h3><button class="btn-close"
                    onclick="closeSafetyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <label class="form-label">í˜„ì¬ ë“±ë¡ëœ íƒœê·¸</label>
                <div id="currentTagList" class="tag-editor-list"></div>
                <label class="form-label">ìƒˆ íƒœê·¸ ì¶”ê°€</label>
                <div class="tag-input-group">
                    <select id="newTagColor" class="color-select">
                        <option value="blue">í‰ê°€(íŒŒë‘)</option>
                        <option value="green">êµìœ¡(ì´ˆë¡)</option>
                        <option value="red">íŠ¹ë³„(ë¹¨ê°•)</option>
                        <option value="orange">ì ê²€(ì£¼í™©)</option>
                        <option value="pink">ì¸¡ì •(ë¶„í™)</option>
                        <option value="purple">íšŒì˜(ë³´ë¼)</option>
                    </select>
                    <input type="text" id="newTagText" class="form-input" placeholder="ë‚´ìš©">
                    <button class="btn btn-navy" style="padding: 0 15px;" onclick="addSafetyTag()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-gray" onclick="closeSafetyModal()">ì·¨ì†Œ</button><button
                    class="btn btn-navy" onclick="saveSafetyChanges()">ì ìš©í•˜ê¸°</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // ============================================
        // [íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • ìˆ˜ì •]
        // ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ 'namhwa-safety-dashboard' í”„ë¡œì íŠ¸ ì‚¬ìš©
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbVG3iL3FBJe6alPLZnhFW_QAGpzeqFoY",
            authDomain: "namhwa-safety-dashboard.firebaseapp.com",
            projectId: "namhwa-safety-dashboard",
            storageBucket: "namhwa-safety-dashboard.firebasestorage.app",
            messagingSenderId: "152864778612",
            appId: "1:152864778612:web:ecc482adce93a1534a2421"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // â˜… [ìˆ˜ì •ë¨] ìˆ˜ì› í˜„ì¥ ë°ì´í„° ê²½ë¡œë¥¼ ëŒ€ì‹œë³´ë“œì™€ í†µí•© (projects -> sites/siteB)
        const SITE_ID = "siteB";
        const docRef = doc(db, "sites", SITE_ID);

        // ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°
        let globalData = {
            headerInfo: {
                period: "2025.10.16 ~ 2027.02.16",
                scale: "ì§€í•˜1ì¸µ ~ ì§€ìƒ4ì¸µ (ë…¸ìœ ìì‹œì„¤)",
                goal: "ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 1000ì¼ ë‹¬ì„±"
            },
            prepConst: {},
            prepSafety: {},
            comments: {},
            taskDetails: {}, // ë¡œì»¬ ìºì‹œìš©
            activityLog: [], // ë¡œì»¬ ìºì‹œìš©
            kpiData: [],
            safetyData: [
                { title: "ìœ„í—˜ì„±í‰ê°€", monthlyTags: { 1: ["ìµœì´ˆí‰ê°€|blue"] } },
                { title: "ì•ˆì „êµìœ¡", monthlyTags: { 1: ["ì±„ìš©ì‹œ|green"] } },
                { title: "í˜‘ì˜ì²´/íšŒì˜", monthlyTags: { 1: ["í˜‘ì˜ì²´|purple"] } },
                { title: "ë²•ì ì ê²€", monthlyTags: { 1: ["í•©ë™|orange"] } },
                { title: "ì„±ê³¼ì¸¡ì •", monthlyTags: { 1: ["ì´í–‰ì ê²€|pink"] } }
            ]
        };

        // KPI ê¸°ë³¸ ë°ì´í„° ìƒì„± (17ê°œì›”)
        for (let i = 1; i <= 17; i++) {
            globalData.kpiData.push({ month: i, process: "", risk: "", activity: "", kpi: "", docs: "" });
        }

        // ê³µì • ë°ì´í„°
        const constructionData = [
            { name: "ê³µí†µê°€ì„¤ê³µì‚¬", start: 1, duration: 17, color: "bg-grey", label: "ê³µí†µê°€ì„¤" },
            { name: "ê°€ì„¤ê³µì‚¬", start: 3, duration: 5, color: "bg-blue", label: "ê°€ì„¤ê³µì‚¬" },
            { name: "ì² ê·¼ì½˜í¬ë¦¬íŠ¸", start: 5, duration: 11, color: "bg-red", label: "ê³¨ì¡°ê³µì‚¬" },
            { name: "ì¡°ì ê³µì‚¬", start: 8, duration: 6, color: "bg-blue", label: "ì¡°ì ê³µì‚¬" },
            { name: "ë¯¸ì¥ê³µì‚¬", start: 8, duration: 8, color: "bg-blue", label: "ë¯¸ì¥ê³µì‚¬" },
            { name: "ë°©ìˆ˜ê³µì‚¬", start: 8, duration: 8, color: "bg-blue", label: "ë°©ìˆ˜ê³µì‚¬" },
            { name: "íƒ€ì¼ê³µì‚¬", start: 12, duration: 3, color: "bg-yellow", label: "íƒ€ì¼ê³µì‚¬" },
            { name: "ì„ê³µì‚¬", start: 11, duration: 5, color: "bg-yellow", label: "ì„ê³µì‚¬" },
            { name: "ê¸ˆì†ê³µì‚¬", start: 11, duration: 5, color: "bg-yellow", label: "ê¸ˆì†ê³µì‚¬" },
            { name: "ì°½í˜¸ê³µì‚¬", start: 8, duration: 8, color: "bg-yellow", label: "ì°½í˜¸ê³µì‚¬" },
            { name: "ìœ ë¦¬ê³µì‚¬", start: 12, duration: 4, color: "bg-yellow", label: "ìœ ë¦¬ê³µì‚¬" },
            { name: "ë„ì¥ê³µì‚¬", start: 11, duration: 5, color: "bg-yellow", label: "ë„ì¥ê³µì‚¬" },
            { name: "ìˆ˜ì¥ê³µì‚¬", start: 10, duration: 5, color: "bg-yellow", label: "ìˆ˜ì¥ê³µì‚¬" },
            { name: "ì¥ì• ì¸í¸ì˜", start: 14, duration: 2, color: "bg-yellow", label: "ì¥ì• ì¸ì‹œì„¤" },
            { name: "E/Vê³µì‚¬", start: 12, duration: 4, color: "bg-yellow", label: "ìŠ¹ê°•ê¸°" },
            { name: "ì¡°ê²½ê³µì‚¬", start: 14, duration: 2, color: "bg-green", label: "ì¡°ê²½ê³µì‚¬" },
            { name: "í† ëª©ê³µì‚¬", start: 1, duration: 5, color: "bg-blue", label: "í† ëª©ê³µì‚¬" },
            { name: "ë¶€ëŒ€í† ëª©ê³µì‚¬", start: 13, duration: 3, color: "bg-green", label: "ë¶€ëŒ€í† ëª©" },
            { name: "ê¸°ê³„ì„¤ë¹„ê³µì‚¬", start: 5, duration: 11, color: "bg-grey", label: "ê¸°ê³„ì„¤ë¹„" },
            { name: "ì „ê¸°í†µì‹ ê³µì‚¬", start: 5, duration: 11, color: "bg-grey", label: "ì „ê¸°í†µì‹ " },
            { name: "ì†Œë°©ê³µì‚¬", start: 6, duration: 10, color: "bg-grey", label: "ì†Œë°©ê³µì‚¬" },
            { name: "ì¤€ê³µ/ì¸ê³„", start: 17, duration: 1, color: "bg-dark", label: "ì¤€ê³µ" }
        ];

        // 1. Firebase ì½ê¸° (Real-time) - êµ¬ì¡° ê°œì„ : ê°œë³„ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©

        // (1) ë©”ì¸ í”„ë¡œì íŠ¸ ì •ë³´ (í—¤ë”, KPI, ì¼ì • ë“±)
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.headerInfo) globalData.headerInfo = data.headerInfo;
                if (data.prepConst) globalData.prepConst = data.prepConst;
                if (data.prepSafety) globalData.prepSafety = data.prepSafety;
                if (data.kpiData) globalData.kpiData = data.kpiData;
                if (data.safetyData) globalData.safetyData = data.safetyData;
                if (data.comments) globalData.comments = data.comments;
            } else {
                setDoc(docRef, {
                    headerInfo: globalData.headerInfo,
                    kpiData: globalData.kpiData,
                    safetyData: globalData.safetyData
                }, { merge: true });
            }
            renderHeader();
            renderGrid();
            renderKpiTable();
            document.getElementById('loading').style.display = 'none';
        }, (error) => {
            console.error("Firestore Error:", error);
            document.getElementById('loading').innerHTML = `<div style="color:red; text-align:center;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨<br>${error.message}<br><br>â€» ê´€ë¦¬ìì—ê²Œ 'Firestore ê·œì¹™' í™•ì¸ì„ ìš”ì²­í•˜ì„¸ìš”.</div>`;
        });

        // (2) ê³µì •ë³„ ìƒì„¸ í™œë™ (taskDetails) - í•˜ìœ„ ì»¬ë ‰ì…˜
        // [ìˆ˜ì •ë¨] ê²½ë¡œ ìˆ˜ì •: sites/siteB/taskDetails
        const detailsRef = collection(db, "sites", SITE_ID, "taskDetails");
        onSnapshot(detailsRef, (snapshot) => {
            globalData.taskDetails = {};
            snapshot.forEach((doc) => {
                globalData.taskDetails[doc.id] = doc.data();
            });
        });

        // (3) ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸ (activityLogs) - í•˜ìœ„ ì»¬ë ‰ì…˜ (ìµœì‹ ìˆœ ì •ë ¬)
        // [ìˆ˜ì •ë¨] ê²½ë¡œ ìˆ˜ì •: sites/siteB/activityLogs
        const logsRef = collection(db, "sites", SITE_ID, "activityLogs");
        const logsQuery = query(logsRef, orderBy("lastUpdated", "desc"), limit(50));

        onSnapshot(logsQuery, (snapshot) => {
            globalData.activityLog = [];
            snapshot.forEach((doc) => {
                globalData.activityLog.push({ id: doc.id, ...doc.data() });
            });
            renderActivityLog();
        });


        // 2. ë Œë”ë§ í•¨ìˆ˜ë“¤
        function renderHeader() {
            document.getElementById('infoPeriod').innerText = globalData.headerInfo.period;
            document.getElementById('infoScale').innerText = globalData.headerInfo.scale;
            document.getElementById('infoGoal').innerText = globalData.headerInfo.goal;
        }

        function renderGrid() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = `<div class="cell-header">êµ¬ë¶„</div><div class="cell-header prep-header">ì°©ê³µì¤€ë¹„</div>`;

            // [ìˆ˜ì •ë¨] 25.10 ~ 27.02 (17ê°œì›”) í—¤ë” ìƒì„±
            const startYear = 2025;
            const startMonth = 10;
            const totalMonths = 17;

            for (let i = 0; i < totalMonths; i++) {
                let y = startYear + Math.floor((startMonth + i - 1) / 12);
                let m = (startMonth + i) % 12;
                if (m === 0) m = 12;
                // mì´ 12ì¼ ë•Œ ì—°ë„ê°€ ì¦ê°€í•˜ì§€ ì•Šë„ë¡ ë³´ì • ì´ë¯¸ ìœ„ì—ì„œ ë¨
                // ì•„ë‹ˆì§€, (10+0-1)/12 = 0.75 -> 0. 2025ë…„.
                // (10+2-1)/12 = 11/12 = 0.91 -> 0. 2025ë…„.
                // (10+3-1)/12 = 12/12 = 1. -> 2026ë…„. (1ì›”) ë§ìŒ.

                // ì¢€ ë” ì§ê´€ì ì¸ ë‚ ì§œ ê³„ì‚°
                const date = new Date(startYear, startMonth - 1 + i, 1);
                const yearShort = date.getFullYear().toString().slice(2);
                const monthStr = (date.getMonth() + 1).toString().padStart(2, '0');
                grid.innerHTML += `<div class="cell-header">${yearShort}.${monthStr}</div>`;
            }

            // ê³µì •
            constructionData.forEach((task, index) => {
                let rowHTML = `<div class="cell cell-sidebar" title="${task.name}">${task.name}</div>`;
                let prepVal = globalData.prepConst[index] || "";
                rowHTML += `<div class="cell prep-cell" contenteditable="true" onblur="updatePrep('const', ${index}, this.innerText)">${prepVal}</div>`;
                for (let i = 1; i <= totalMonths; i++) {
                    if (i === task.start) {
                        rowHTML += `<div class="cell" style="grid-column: span ${task.duration}; background:#fff; padding:5px;"><div class="task-bar ${task.color}" onclick="openModal(${index})">${task.label}</div></div>`;
                        i += (task.duration - 1);
                    } else { rowHTML += `<div class="cell"></div>`; }
                }
                grid.innerHTML += rowHTML;
            });

            grid.innerHTML += `<div class="divider-row">â–¼ ë²•ì  ì•ˆì „ê´€ë¦¬ ë° ì„±ê³¼ ì¸¡ì • ì¼ì • (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</div>`;

            // ì•ˆì „
            globalData.safetyData.forEach((row, rowIndex) => {
                let rowHTML = `<div class="cell cell-sidebar safety-row">${row.title}</div>`;
                let prepVal = globalData.prepSafety[rowIndex] || "";
                rowHTML += `<div class="cell prep-cell" contenteditable="true" onblur="updatePrep('safety', ${rowIndex}, this.innerText)">${prepVal}</div>`;
                for (let i = 1; i <= totalMonths; i++) {
                    let tagsHTML = "";
                    if (row.monthlyTags && row.monthlyTags[i]) {
                        row.monthlyTags[i].forEach(tagStr => {
                            const [text, color] = tagStr.split("|");
                            tagsHTML += `<div class="tag ${color}">${text}</div>`;
                        });
                    }
                    rowHTML += `<div class="cell tag-container clickable-cell" onclick="openSafetyModal(${rowIndex}, ${i})">${tagsHTML}</div>`;
                }
                grid.innerHTML += rowHTML;
            });
        }

        function renderKpiTable() {
            const tbody = document.getElementById('kpiTableBody');
            tbody.innerHTML = "";
            globalData.kpiData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="kpi-td center"><strong>${row.month}ì›”</strong></td>
                    <td class="kpi-td editable center" contenteditable="true" onblur="updateKpi(${index}, 'process', this.innerText)">${row.process || ""}</td>
                    <td class="kpi-td editable center text-red" contenteditable="true" onblur="updateKpi(${index}, 'risk', this.innerText)">${row.risk || ""}</td>
                    <td class="kpi-td editable" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpi(${index}, 'activity', this.innerText)">${row.activity || ""}</td>
                    <td class="kpi-td editable center text-blue" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpi(${index}, 'kpi', this.innerText)">${row.kpi || ""}</td>
                    <td class="kpi-td editable center" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpi(${index}, 'docs', this.innerText)">${row.docs || ""}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. ì“°ê¸° (ì „ì—­ í•¨ìˆ˜)
        window.updateDB = async function () {
            globalData.headerInfo = {
                period: document.getElementById('infoPeriod').innerText,
                scale: document.getElementById('infoScale').innerText,
                goal: document.getElementById('infoGoal').innerText
            };
            await updateDoc(docRef, { headerInfo: globalData.headerInfo });
        };

        window.updatePrep = async function (type, index, value) {
            if (type === 'const') globalData.prepConst[index] = value;
            else globalData.prepSafety[index] = value;
            await updateDoc(docRef, { prepConst: globalData.prepConst, prepSafety: globalData.prepSafety });
        };

        window.updateKpi = async function (index, key, value) {
            globalData.kpiData[index][key] = value;
            await updateDoc(docRef, { kpiData: globalData.kpiData });
        };

        // --- íŒì—… ---
        let currentTaskIndex = null;
        let selectedFile = null; // â˜… íŒŒì¼ ê°ì²´ ì €ì¥ìš©
        let currentFileUrl = null; // â˜… ê¸°ì¡´ URL ì €ì¥ìš©

        // [ìˆ˜ì •ë¨] íŒì—… ì—´ê¸° í•¨ìˆ˜ ê°œì„  - íŠ¹ì • ì´ë ¥(logData) ë³´ê¸° ì§€ì›
        window.openModal = function (index, logData = null) {
            currentTaskIndex = index;
            // logDataê°€ ìˆìœ¼ë©´(ë¦¬ìŠ¤íŠ¸ í´ë¦­) ê·¸ê²ƒì„ ì‚¬ìš©, ì—†ìœ¼ë©´(ì°¨íŠ¸ í´ë¦­) ìµœì‹  ìƒíƒœ ì‚¬ìš©
            const dataToLoad = logData || (globalData.taskDetails && globalData.taskDetails[index]) || {};
            const defaultLabel = constructionData[index].label;

            // [NEW] ë‚ ì§œ ìë™ ì„¸íŒ… (ì´ë ¥ ì¡°íšŒ ì‹œ í•´ë‹¹ ë‚ ì§œ, ì•„ë‹ˆë©´ ì˜¤ëŠ˜ ë‚ ì§œ)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            document.getElementById('modalDate').value = (logData && logData.workDate) ? logData.workDate : todayStr;

            // íƒ€ì´í‹€ ìˆ˜ì •: ì´ë ¥ ì¡°íšŒ ì‹œ êµ¬ë¶„
            document.getElementById('modalTitle').innerText = defaultLabel + (logData ? " ê¸°ë¡ (ì¡°íšŒ)" : " ìƒì„¸ í™œë™");

            document.getElementById('modalRisk').value = dataToLoad.risk || "";
            document.getElementById('modalKPI').value = dataToLoad.kpi || "";
            document.getElementById('modalActivity').value = dataToLoad.activity || "";

            document.getElementById('fileInput').value = "";
            selectedFile = null;
            currentFileUrl = dataToLoad.imageData || null; // í•´ë‹¹ ë°ì´í„°ì˜ ì´ë¯¸ì§€ URL ë¡œë“œ

            // í”„ë¦¬ë·° ì„¤ì •
            const previewBox = document.getElementById('previewBox');
            const previewImg = document.getElementById('previewImg');
            const previewPdf = document.getElementById('previewPdf');

            if (currentFileUrl) {
                previewBox.style.display = "block";
                previewImg.style.display = "block";
                previewPdf.style.display = "none";
                previewImg.src = currentFileUrl;

                previewImg.onerror = function () {
                    previewImg.style.display = "none";
                    previewPdf.style.display = "block";
                    previewPdf.src = currentFileUrl;
                };
            } else {
                previewBox.style.display = "none";
                previewImg.src = "";
                previewPdf.src = "";
            }
            renderComments(index);
            document.getElementById('modal').style.display = 'flex';
        };

        window.closeModal = function () { document.getElementById('modal').style.display = 'none'; };

        // [ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜]
        function compressImage(file, maxWidth, maxHeight, quality, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function (event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function () {
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL("image/jpeg", quality);
                    callback(dataUrl);
                }
            }
        }

        // â˜… [íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬]
        window.handleFileSelect = function (input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // ìš©ëŸ‰ ì²´í¬ (StorageëŠ” ë„‰ë„‰í•˜ì§€ë§Œ 10MB ê¶Œì¥)
                if (file.size > 10 * 1024 * 1024) {
                    alert("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                    input.value = "";
                    return;
                }

                selectedFile = file; // ì—…ë¡œë“œ ëŒ€ê¸°
                currentFileUrl = null; // ìƒˆ íŒŒì¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ ê¸°ì¡´ URL ë¬´ì‹œ

                // ë¡œì»¬ í”„ë¦¬ë·° í‘œì‹œ
                const reader = new FileReader();
                reader.onload = function (e) {
                    const result = e.target.result;
                    document.getElementById('previewBox').style.display = "block";
                    const previewImg = document.getElementById('previewImg');
                    const previewPdf = document.getElementById('previewPdf');

                    if (file.type.includes("pdf")) {
                        previewImg.style.display = "none";
                        previewPdf.style.display = "block";
                        previewPdf.src = result;
                    } else {
                        previewPdf.style.display = "none";
                        previewImg.style.display = "block";

                        // ì••ì¶•í•´ì„œ ë¯¸ë¦¬ë³´ê¸°ì— í‘œì‹œ (ì„ íƒì‚¬í•­, ì›ë³¸ë„ ë¬´ë°©)
                        compressImage(file, 1024, 1024, 0.7, function (dataUrl) {
                            previewImg.src = dataUrl;
                        });
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.deleteFile = function () {
            if (confirm("ì²¨ë¶€íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                selectedFile = null;
                currentFileUrl = null;
                document.getElementById('previewBox').style.display = "none";
                document.getElementById('previewImg').src = "";
                document.getElementById('previewPdf').src = "";
                document.getElementById('fileInput').value = "";
            }
        };

        // â˜… [í•µì‹¬] ì €ì¥ ë¡œì§: Storage ì—…ë¡œë“œ -> URL íšë“ -> Firestore ì €ì¥
        window.saveTaskDetails = async function () {
            const btn = document.querySelector('.modal-footer .btn-navy');
            const originalText = btn.innerText;
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                const now = new Date().toISOString();
                let finalImageUrl = currentFileUrl; // ê¸°ë³¸: ê¸°ì¡´ URL

                // 1. ìƒˆ íŒŒì¼ì´ ì„ íƒë˜ì—ˆë‹¤ë©´ Storageì— ì—…ë¡œë“œ
                if (selectedFile) {
                    const storageRef = ref(storage, `site_attachments/${Date.now()}_${selectedFile.name}`);
                    await uploadBytes(storageRef, selectedFile);
                    finalImageUrl = await getDownloadURL(storageRef);
                }

                const workDate = document.getElementById('modalDate').value; // [NEW] ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°

                const taskData = {
                    taskName: constructionData[currentTaskIndex].label,
                    risk: document.getElementById('modalRisk').value,
                    kpi: document.getElementById('modalKPI').value,
                    activity: document.getElementById('modalActivity').value,
                    imageData: finalImageUrl, // URL ì €ì¥ (ìš©ëŸ‰ ì‘ìŒ)
                    workDate: workDate, // [NEW] ì‘ì—… ì¼ì ì €ì¥
                    lastUpdated: now
                };

                // 2. ê³µì •ë³„ ìƒì„¸ ì •ë³´ ì €ì¥ (ë®ì–´ì“°ê¸°) -> taskDetails ì»¬ë ‰ì…˜
                // [ìˆ˜ì •ë¨] ê²½ë¡œ ìˆ˜ì •: sites/siteB/taskDetails
                const taskDocRef = doc(db, "sites", SITE_ID, "taskDetails", String(currentTaskIndex));
                await setDoc(taskDocRef, taskData);

                // 3. í™œë™ ë¡œê·¸ ì €ì¥ (ëˆ„ì ) -> activityLogs ì»¬ë ‰ì…˜
                // [ìˆ˜ì •ë¨] ê²½ë¡œ ìˆ˜ì •: sites/siteB/activityLogs
                const logData = {
                    ...taskData,
                    taskIndex: currentTaskIndex
                };
                const logsCollectionRef = collection(db, "sites", SITE_ID, "activityLogs");
                await addDoc(logsCollectionRef, logData);

                alert("âœ… [ì €ì¥ ì™„ë£Œ]\n\nì•ˆì „ë³´ê±´ í™œë™ ë‚´ì—­ì´ ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeModal();
            } catch (e) {
                alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message);
                console.error(e);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.addComment = async function () {
            const name = document.getElementById('writerName').value.trim();
            const content = document.getElementById('commentContent').value.trim();
            if (!name || !content) return alert("ì…ë ¥í•˜ì„¸ìš”");

            const dateStr = new Date().toISOString().slice(0, 10);
            const newComment = { name, content, date: dateStr };

            if (!globalData.comments) globalData.comments = {};
            if (!globalData.comments[currentTaskIndex]) globalData.comments[currentTaskIndex] = [];
            globalData.comments[currentTaskIndex].push(newComment);

            await updateDoc(docRef, { comments: globalData.comments });
            document.getElementById('commentContent').value = '';
            renderComments(currentTaskIndex);
        };

        function renderComments(index) {
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            const comments = (globalData.comments && globalData.comments[index]) || [];
            comments.forEach((c, i) => {
                const li = document.createElement('li');
                li.className = 'comment-item';
                li.innerHTML = `<div><strong>${c.name}:</strong> ${c.content} <span class="comment-date">(${c.date})</span></div><button class="btn-del-comment" onclick="deleteComment(${i})">ì‚­ì œ</button>`;
                list.appendChild(li);
            });
        }

        window.deleteComment = async function (idx) {
            const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
            if (pwd === "1234") {
                globalData.comments[currentTaskIndex].splice(idx, 1);
                await updateDoc(docRef, { comments: globalData.comments });
                renderComments(currentTaskIndex);
            } else if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        };

        // --- íƒœê·¸ í¸ì§‘ ---
        let safetyEditRow = null;
        let safetyEditMonth = null;
        let tempTags = [];

        window.openSafetyModal = function (rowIdx, month) {
            safetyEditRow = rowIdx;
            safetyEditMonth = month;
            document.getElementById('safetyModalTitle').innerText = `${month}ì›” ì¼ì • ìˆ˜ì •`;
            tempTags = [];
            if (globalData.safetyData[rowIdx].monthlyTags && globalData.safetyData[rowIdx].monthlyTags[month]) {
                tempTags = [...globalData.safetyData[rowIdx].monthlyTags[month]];
            }
            renderTempTags();
            document.getElementById('newTagText').value = "";
            document.getElementById('safetyModal').style.display = 'flex';
        };

        window.closeSafetyModal = function () { document.getElementById('safetyModal').style.display = 'none'; };

        function renderTempTags() {
            const container = document.getElementById('currentTagList');
            container.innerHTML = "";
            tempTags.forEach((tagStr, idx) => {
                const [text, color] = tagStr.split("|");
                const span = document.createElement('span');
                span.className = `tag-item tag ${color}`;
                span.innerHTML = `${text} <span class="del-btn" onclick="removeSafetyTag(${idx})">Ã—</span>`;
                container.appendChild(span);
            });
        }

        window.addSafetyTag = function () {
            const text = document.getElementById('newTagText').value.trim();
            const color = document.getElementById('newTagColor').value;
            if (!text) return;
            tempTags.push(`${text}|${color}`);
            renderTempTags();
            document.getElementById('newTagText').value = "";
            document.getElementById('newTagText').focus();
        };

        window.removeSafetyTag = function (idx) {
            tempTags.splice(idx, 1);
            renderTempTags();
        };

        window.saveSafetyChanges = async function () {
            if (!globalData.safetyData[safetyEditRow].monthlyTags) globalData.safetyData[safetyEditRow].monthlyTags = {};
            globalData.safetyData[safetyEditRow].monthlyTags[safetyEditMonth] = tempTags;
            await updateDoc(docRef, { safetyData: globalData.safetyData });
            closeSafetyModal();
        };

        // â˜… [ìˆ˜ì •ë¨] ì‚­ì œ ë¡œì§: í•˜ìœ„ ì»¬ë ‰ì…˜ ë¬¸ì„œ ì‚­ì œ (ê²½ë¡œ ìˆ˜ì •ë¨)
        window.deleteLogItem = async function (logId) {
            if (confirm("ì´ ì´ë ¥ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                const pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (pwd === "1234") {
                    try {
                        const logDocRef = doc(db, "sites", SITE_ID, "activityLogs", logId);
                        await deleteDoc(logDocRef);
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch (e) {
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                    }
                } else {
                    if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        };

        // â˜… [ìˆ˜ì •ë¨] ë Œë”ë§ ë¡œì§: activityLog(ë°°ì—´) ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
        window.renderActivityLog = function () {
            const listContainer = document.getElementById('activityLogList');
            const searchText = document.getElementById('logSearchInput').value.toLowerCase();

            let logArray = globalData.activityLog || [];

            if (searchText) {
                logArray = logArray.filter(item =>
                    item.taskName.toLowerCase().includes(searchText) ||
                    (item.risk && item.risk.toLowerCase().includes(searchText)) ||
                    (item.activity && item.activity.toLowerCase().includes(searchText))
                );
            }

            logArray.sort((a, b) => {
                const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date(0);
                const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date(0);
                return dateB - dateA;
            });

            if (logArray.length === 0) {
                listContainer.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë“±ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            listContainer.innerHTML = "";
            logArray.forEach(d => {
                let dateStr = "ë‚ ì§œ ì •ë³´ ì—†ìŒ";
                // [NEW] ì‘ì—… ì¼ì(workDate)ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ í‘œì‹œ
                if (d.workDate) {
                    dateStr = `ğŸ“… ${d.workDate}`;
                } else if (d.lastUpdated) {
                    // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜
                    const dateObj = new Date(d.lastUpdated);
                    dateStr = dateObj.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                }

                const li = document.createElement('li');
                li.className = 'log-item';
                // í´ë¦­í•˜ë©´ í•´ë‹¹ ë¡œê·¸ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ì—¬ íŒì—… ì˜¤í”ˆ (ëˆ„ì ëœ íŒŒì¼ í™•ì¸ ê°€ëŠ¥)
                li.onclick = function () { openModal(d.taskIndex, d); };

                let badges = "";
                if (d.risk) badges += `<span class="log-badge badge-risk">í•µì‹¬ìœ„í—˜</span>`;
                if (d.kpi) badges += `<span class="log-badge badge-kpi">KPI</span>`;

                // [ìˆ˜ì •ë¨] ë¦¬ìŠ¤íŠ¸ì— ì´ë¯¸ì§€/ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì¶”ê°€
                let fileDisplay = "";
                if (d.imageData) {
                    if (d.imageData.includes("pdf") || d.imageData.startsWith("data:application/pdf")) {
                        fileDisplay = `<div style="margin-top:8px; padding:4px; background:#f8f9fa; border-radius:4px; font-size:12px;"><a href="${d.imageData}" target="_blank" onclick="event.stopPropagation()" style="color:#e67e22; text-decoration:none; display:flex; align-items:center;">ğŸ“„ PDF ë¬¸ì„œ ë³´ê¸° (í´ë¦­)</a></div>`;
                    } else {
                        fileDisplay = `<div style="margin-top:8px;"><img src="${d.imageData}" style="height:60px; width:auto; border-radius:4px; border:1px solid #eee; cursor:zoom-in;" onclick="event.stopPropagation(); window.open(this.src)"></div>`;
                    }
                }

                li.innerHTML = `
                    <div class="log-top">
                        <span>ğŸ•’ ${dateStr}</span>
                        <button class="btn-log-delete" onclick="event.stopPropagation(); deleteLogItem('${d.id}')">ì‚­ì œ</button>
                    </div>
                    <div class="log-task">${d.taskName} ${badges}</div>
                    <div class="log-content">${d.activity ? d.activity : '<span style="color:#ccc">(í™œë™ ë‚´ìš© ì—†ìŒ)</span>'}</div>
                    ${d.risk ? `<div style="font-size:12px; color:#d9534f; margin-top:5px;">âš ï¸ ìœ„í—˜: ${d.risk}</div>` : ''}
                    ${fileDisplay}
                `;
                listContainer.appendChild(li);
            });
        };
    </script>
</body>

</html>